<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify AWS S3 Loading</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #111;
            color: white;
        }
        h1 {
            color: #fbbf24;
            border-bottom: 2px solid #fbbf24;
            padding-bottom: 10px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .model-test {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #334155;
        }
        .model-test.aws {
            border-color: #10b981;
            background: #064e3b;
        }
        .model-test.cloudinary {
            border-color: #ef4444;
            background: #7f1d1d;
        }
        .model-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .url-preview {
            font-size: 11px;
            color: #94a3b8;
            word-break: break-all;
            margin: 5px 0;
            padding: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        .status.success {
            background: #10b981;
            color: white;
        }
        .status.error {
            background: #ef4444;
            color: white;
        }
        .summary {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #fbbf24;
        }
        .stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }
        .stat {
            flex: 1;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        .stat-label {
            color: #94a3b8;
            margin-top: 5px;
        }
        button {
            background: #fbbf24;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        button:hover {
            background: #f59e0b;
        }
        model-viewer {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 8px;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #fbbf24;
        }
    </style>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
    <h1>üîç Verify AWS S3 Direct Loading</h1>

    <div class="summary">
        <h2>Testing All Models - Are they loading from AWS S3?</h2>
        <p>This page loads ALL your models and shows exactly where each file is coming from.</p>
        <button onclick="startTest()">üöÄ Start Verification Test</button>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat">
                <div class="stat-value" id="aws-count" style="color: #10b981;">0</div>
                <div class="stat-label">Loading from AWS S3 ‚úÖ</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="cloudinary-count" style="color: #ef4444;">0</div>
                <div class="stat-label">Still on Cloudinary ‚ùå</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="missing-count" style="color: #6b7280;">0</div>
                <div class="stat-label">Missing Files</div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        ‚è≥ Loading all models and checking their sources...
    </div>

    <div id="test-results" class="test-grid"></div>

    <script>
        async function startTest() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('stats').style.display = 'flex';

            try {
                // Fetch all models
                const response = await fetch('/api/models');
                const data = await response.json();

                if (!data.success || !data.models) {
                    throw new Error('Failed to load models');
                }

                const models = data.models;
                const results = {
                    aws: [],
                    cloudinary: [],
                    missing: []
                };

                const testContainer = document.getElementById('test-results');

                for (const model of models) {
                    const modelDiv = document.createElement('div');
                    modelDiv.className = 'model-test';

                    // Determine which URL is being used
                    let modelUrl = null;
                    let source = 'missing';

                    if (model.aws_url) {
                        modelUrl = model.aws_url;
                        source = 'aws';
                        results.aws.push(model);
                        modelDiv.classList.add('aws');
                    } else if (model.cloudinary_url) {
                        modelUrl = model.cloudinary_url;
                        source = 'cloudinary';
                        results.cloudinary.push(model);
                        modelDiv.classList.add('cloudinary');
                    } else {
                        results.missing.push(model);
                    }

                    let statusBadge = '';
                    if (source === 'aws') {
                        statusBadge = '<div class="status success">‚úÖ Loading from AWS S3</div>';
                    } else if (source === 'cloudinary') {
                        statusBadge = '<div class="status error">‚ùå Still on Cloudinary</div>';
                    } else {
                        statusBadge = '<div class="status error">‚ö†Ô∏è No file found</div>';
                    }

                    modelDiv.innerHTML = `
                        <div class="model-title">${model.title || 'Untitled'}</div>
                        <div class="url-preview">${modelUrl || 'No URL'}</div>
                        ${statusBadge}
                        ${modelUrl ? `
                            <model-viewer
                                src="${modelUrl}"
                                auto-rotate
                                camera-controls
                                loading="eager"
                                reveal="interaction">
                            </model-viewer>
                        ` : ''}
                        <div style="margin-top: 10px;">
                            <a href="/view?id=${model.id}" target="_blank" style="color: #fbbf24;">Test AR View ‚Üí</a>
                        </div>
                    `;

                    testContainer.appendChild(modelDiv);

                    // Update counts
                    document.getElementById('aws-count').textContent = results.aws.length;
                    document.getElementById('cloudinary-count').textContent = results.cloudinary.length;
                    document.getElementById('missing-count').textContent = results.missing.length;
                }

                document.getElementById('loading').style.display = 'none';

                // Log detailed results
                console.log('=== AWS S3 Loading Verification ===');
                console.log(`‚úÖ AWS S3: ${results.aws.length} models`);
                console.log(`‚ùå Cloudinary: ${results.cloudinary.length} models`);
                console.log(`‚ö†Ô∏è Missing: ${results.missing.length} models`);

                if (results.cloudinary.length > 0) {
                    console.log('\nModels still on Cloudinary:');
                    results.cloudinary.forEach(m => console.log(`  - ${m.title} (${m.id})`));
                }

                // Alert summary
                const awsPercentage = ((results.aws.length / models.length) * 100).toFixed(1);
                alert(`‚úÖ ${results.aws.length}/${models.length} models (${awsPercentage}%) are now loading from AWS S3!\n\n` +
                      `‚ùå ${results.cloudinary.length} still on Cloudinary\n` +
                      `‚ö†Ô∏è ${results.missing.length} missing files`);

            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('loading').innerHTML = '‚ùå Error: ' + error.message;
            }
        }

        // Also test in network tab
        function checkNetworkRequests() {
            console.log('Open Network tab and filter by ".glb" to see where models are loading from:');
            console.log('- AWS URLs: https://newfurniture-ar-assets.s3.amazonaws.com/...');
            console.log('- Cloudinary URLs: https://res.cloudinary.com/...');
        }

        window.checkNetworkRequests = checkNetworkRequests;
    </script>
</body>
</html>