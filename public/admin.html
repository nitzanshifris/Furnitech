<!DOCTYPE html>
<!-- SKU FIX VERSION 2.0 - Force cache refresh -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - newfurniture.live</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Meta Tags -->
    <meta name="description" content="Admin dashboard for managing AR furniture platform">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#2c3e50">
    
    <!-- Force cache refresh -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <script src="js/direct-s3-upload.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 255, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #0a0c10 0%, #0d1117 50%, #111418 100%);
            color: #e6edf3;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="0.5" fill="%23ffffff" opacity="0.02"/><circle cx="75" cy="75" r="0.3" fill="%23ffffff" opacity="0.02"/><circle cx="50" cy="10" r="0.4" fill="%23ffffff" opacity="0.01"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>'),
                linear-gradient(180deg, rgba(88, 166, 255, 0.02) 0%, transparent 100%);
            pointer-events: none;
            z-index: -1;
        }
        
        .header {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 3px;
            background: linear-gradient(135deg, #ffffff 0%, #a8a8a8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-button {
            background: rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            border: 1px solid rgba(240, 246, 252, 0.2);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 14px;
        }
        
        .nav-button:hover {
            background: rgba(240, 246, 252, 0.15);
            border-color: rgba(240, 246, 252, 0.3);
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                gap: 8px;
            }
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.9) 0%, rgba(30, 35, 42, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.15);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.4),
                0 1px 0 rgba(255, 255, 255, 0.05) inset;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 0;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.5), transparent);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.1) inset;
            border-color: rgba(88, 166, 255, 0.3);
        }
        
        .stat-label {
            color: #7d8590;
            font-size: 0.7rem;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e6edf3;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-icon {
            float: right;
            font-size: 1.2rem;
            opacity: 0.4;
        }
        
        @media (max-width: 768px) {
            .stat-icon {
                font-size: 1.5rem;
            }
            .stat-value {
                font-size: 1.8rem !important;
            }
            .stat-label {
                font-size: 0.8rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .stat-icon {
                font-size: 1.2rem;
            }
            .stat-value {
                font-size: 1.5rem !important;
            }
            .stat-label {
                font-size: 0.7rem !important;
                line-height: 1.2;
            }
        }
        
        .models-section {
            margin-top: 40px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.9) 0%, rgba(30, 35, 42, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.15);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 1px 0 rgba(255, 255, 255, 0.05) inset;
            position: relative;
            overflow: hidden;
        }
        
        .models-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.6), rgba(120, 200, 255, 0.6), transparent);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e6edf3;
        }
        
        .refresh-button {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .refresh-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.3);
        }

        
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .model-card {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.05) inset;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.4), transparent);
            z-index: 1;
        }
        
        .model-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.6),
                0 2px 0 rgba(88, 166, 255, 0.2) inset;
            border-color: rgba(88, 166, 255, 0.4);
        }
        
        .model-card:hover::before {
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.8), rgba(120, 200, 255, 0.6), transparent);
        }
        
        .model-preview {
            position: relative;
            height: 200px;
            background: linear-gradient(135deg, #0d1117 0%, #21262d 100%);
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .model-viewer {
            width: 100%;
            height: 100%;
        }
        
        .model-info {
            padding: 16px;
        }
        
        .model-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 8px;
        }
        
        .model-description {
            color: #7d8590;
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .model-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #7d8590;
        }
        
        .model-id {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: rgba(240, 246, 252, 0.1);
            color: #79c0ff;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .model-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #58a6ff;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #7d8590;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Legacy styles removed - using card-actions-consolidated instead */
        
        .action-button {
            padding: 6px 10px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            background: rgba(240, 246, 252, 0.05);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: #e6edf3;
            display: inline-block;
            flex: 1;
            text-align: center;
        }
        
        .action-button:hover {
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(88, 166, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .action-button.delete {
            color: #f85149;
            border-color: rgba(248, 81, 73, 0.3);
            background: rgba(248, 81, 73, 0.1);
        }
        
        .action-button.delete:hover {
            background: rgba(248, 81, 73, 0.2);
            border-color: rgba(248, 81, 73, 0.5);
        }
        
        .action-button.variant-btn {
            background: rgba(255, 165, 0, 0.1);
            border-color: rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }
        
        .action-button.variant-btn:hover {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.5);
        }
        
        /* Consolidated Button Layout */
        .card-actions-consolidated {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }
        
        .action-button.primary {
            background: rgba(88, 166, 255, 0.15);
            border-color: rgba(88, 166, 255, 0.3);
            color: #58a6ff;
        }
        
        .action-button.primary:hover {
            background: rgba(88, 166, 255, 0.25);
            border-color: rgba(88, 166, 255, 0.5);
        }
        
        .action-button.settings {
            background: rgba(163, 113, 247, 0.15);
            border-color: rgba(163, 113, 247, 0.3);
            color: #a371f7;
        }
        
        .action-button.settings:hover {
            background: rgba(163, 113, 247, 0.25);
            border-color: rgba(163, 113, 247, 0.5);
        }
        
        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .settings-modal-content {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .settings-modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            background: rgba(88, 166, 255, 0.05);
        }
        
        .settings-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6edf3;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-modal-body {
            padding: 20px 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-action {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(240, 246, 252, 0.05);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .settings-action:hover {
            background: rgba(240, 246, 252, 0.08);
            border-color: rgba(240, 246, 252, 0.2);
        }
        
        .settings-action-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .settings-action-label {
            color: #e6edf3;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .settings-action-desc {
            color: #7d8590;
            font-size: 0.85rem;
        }
        
        .settings-action-button {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            background: rgba(240, 246, 252, 0.05);
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .settings-action-button:hover {
            background: rgba(240, 246, 252, 0.1);
            border-color: rgba(240, 246, 252, 0.3);
        }
        
        .settings-action-button.danger {
            background: rgba(248, 81, 73, 0.1);
            border-color: rgba(248, 81, 73, 0.3);
            color: #f85149;
        }
        
        .settings-action-button.danger:hover {
            background: rgba(248, 81, 73, 0.2);
            border-color: rgba(248, 81, 73, 0.5);
        }
        
        .settings-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
            display: flex;
            justify-content: flex-end;
        }
        
        .settings-close-button {
            padding: 8px 16px;
            background: rgba(240, 246, 252, 0.1);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            color: #7d8590;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .settings-close-button:hover {
            background: rgba(240, 246, 252, 0.15);
            border-color: rgba(240, 246, 252, 0.3);
            color: #e6edf3;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }
        
        
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.2);
            padding: 20px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e6edf3;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            background: rgba(240, 246, 252, 0.05);
            color: #e6edf3;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #58a6ff;
            background: rgba(240, 246, 252, 0.1);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .modal-button.primary {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            font-weight: 500;
        }
        
        .modal-button.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.3);
        }
        
        .modal-button.secondary {
            background: rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            border: 1px solid rgba(240, 246, 252, 0.2);
        }
        
        .modal-button.secondary:hover {
            background: rgba(240, 246, 252, 0.15);
            border-color: rgba(240, 246, 252, 0.3);
        }

        
        .copy-button {
            cursor: pointer;
            color: #667eea;
            margin-left: 10px;
            font-size: 1.2rem;
        }
        
        .copy-button:hover {
            color: #5568d3;
        }
        
        /* Futuristic Upload Styles */
        .futuristic-upload {
            max-width: 550px !important;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.98) 0%, rgba(30, 35, 42, 0.95) 100%);
            border: 2px solid rgba(88, 166, 255, 0.2);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }
        
        .upload-header {
            text-align: center;
            margin-bottom: 10px;
            position: relative;
        }
        
        .upload-icon-container {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .upload-icon-bg {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(120, 200, 255, 0.1));
            border: 2px solid rgba(88, 166, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: iconPulse 3s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(88, 166, 255, 0); }
        }
        
        .upload-icon {
            width: 32px;
            height: 32px;
            color: #58a6ff;
        }
        
        .upload-title {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #e6edf3, #58a6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .upload-subtitle {
            color: #7d8590;
            font-size: 0.95rem;
            font-weight: 400;
        }
        
        .futuristic-drop-zone {
            position: relative;
            margin-bottom: 12px;
        }
        
        .drop-zone-content {
            border: 2px dashed rgba(88, 166, 255, 0.3);
            border-radius: 16px;
            padding: 18px 15px;
            text-align: center;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.02), rgba(120, 200, 255, 0.01));
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .drop-zone-content::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(88, 166, 255, 0.1), transparent);
            border-radius: 16px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .drop-zone-content:hover {
            border-color: rgba(88, 166, 255, 0.5);
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05), rgba(120, 200, 255, 0.02));
        }
        
        .drop-zone-content:hover::before {
            opacity: 1;
        }
        
        .drop-animation {
            position: relative;
            display: inline-block;
            margin-bottom: 12px;
        }
        
        .drop-ring {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(88, 166, 255, 0.3);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: ripple 2s ease-out infinite;
        }
        
        .drop-ring:nth-child(2) { animation-delay: 0.5s; }
        .drop-ring:nth-child(3) { animation-delay: 1s; }
        
        @keyframes ripple {
            0% {
                width: 20px;
                height: 20px;
                opacity: 1;
            }
            100% {
                width: 80px;
                height: 80px;
                opacity: 0;
            }
        }
        
        .upload-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }
        
        .primary-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e6edf3;
        }
        
        .secondary-text {
            font-size: 0.95rem;
            color: #7d8590;
        }
        
        .click-text {
            color: #58a6ff;
            font-weight: 500;
        }
        
        .format-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .format-badge {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(88, 166, 255, 0.2);
        }
        
        .size-limit {
            color: #7d8590;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.15), rgba(120, 200, 255, 0.1));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .futuristic-drop-zone.drag-over .drag-overlay {
            opacity: 1;
        }
        
        .drag-content {
            text-align: center;
            color: #58a6ff;
        }
        
        .drag-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: bounce 0.6s ease infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        
        .file-preview-container {
            margin-bottom: 10px;
        }
        
        .file-preview-card {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(120, 200, 255, 0.05));
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 2rem;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 4px;
        }
        
        .file-size {
            color: #7d8590;
            font-size: 0.9rem;
        }
        
        .remove-file-btn {
            background: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .remove-file-btn:hover {
            background: rgba(248, 81, 73, 0.2);
        }
        
        .input-group {
            position: relative;
            margin-bottom: 10px;
        }
        
        .futuristic-input {
            width: 100%;
            background: rgba(240, 246, 252, 0.03);
            border: 1px solid rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            padding: 12px;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .futuristic-input:focus {
            outline: none;
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(240, 246, 252, 0.05);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .futuristic-input.textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .field-hint {
            color: #7d8590;
            font-size: 0.875rem;
            margin-top: 8px;
            display: block;
            font-style: italic;
            opacity: 0.8;
        }
        
        /* Product URL editing styles */
        .product-url-container {
            margin-top: 8px;
        }
        
        .product-url-btn {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            width: 100%;
            text-align: left;
            word-break: break-all;
            line-height: 1.3;
            margin-top: 4px;
        }
        
        .product-url-btn:hover {
            background: rgba(88, 166, 255, 0.2);
            border-color: rgba(88, 166, 255, 0.5);
            transform: translateY(-1px);
        }
        
        .product-url-btn[data-empty="true"] {
            color: #7d8590;
            border-color: rgba(125, 133, 144, 0.3);
            background: rgba(125, 133, 144, 0.05);
        }
        
        .product-url-btn[data-empty="true"]:hover {
            color: #58a6ff;
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(88, 166, 255, 0.1);
        }
        
        .editable-title {
            cursor: pointer;
            position: relative;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .editable-title:hover {
            background: rgba(88, 166, 255, 0.1);
        }
        
        .input-line {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 0;
            background: linear-gradient(90deg, #58a6ff, #79c0ff);
            transition: width 0.3s ease;
            border-radius: 1px;
        }
        
        .futuristic-input:focus + .input-line {
            width: 100%;
        }
        
        /* Password Toggle Button Styles */
        .password-input-group {
            position: relative;
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            z-index: 10;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: #7d8590;
        }
        
        .password-toggle-btn:hover {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }
        
        .password-toggle-btn .eye-icon {
            width: 18px;
            height: 18px;
        }
        
        .password-input-group .futuristic-input {
            padding-right: 50px;
        }
        
        .input-label {
            display: block;
            color: #7d8590;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .password-note {
            margin-top: 6px;
            padding-left: 4px;
        }
        
        .futuristic-primary {
            position: relative;
            overflow: hidden;
        }
        
        .button-text {
            position: relative;
            z-index: 2;
        }
        
        .button-glow {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .futuristic-primary:hover .button-glow {
            left: 100%;
        }
        
        .upload-progress {
            margin-top: 25px;
        }
        
        .progress-label {
            color: #e6edf3;
            font-weight: 500;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .progress-track {
            flex: 1;
            height: 6px;
            background: rgba(240, 246, 252, 0.1);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #79c0ff);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.5), transparent);
            opacity: 0;
            animation: progressGlow 2s ease-in-out infinite;
        }
        
        @keyframes progressGlow {
            0%, 100% { opacity: 0; transform: translateX(-100%); }
            50% { opacity: 1; transform: translateX(100%); }
        }
        
        .progress-percentage {
            color: #58a6ff;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 40px;
        }
        
        .customer-select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%2358a6ff" d="M6 8L0 2h12L6 8z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 50px;
        }
        
        /* Customer Groups Styles */
        .customer-groups {
            margin-top: 30px;
        }
        
        .customer-group {
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.6), rgba(30, 35, 42, 0.5));
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .customer-group:hover {
            border-color: rgba(88, 166, 255, 0.2);
        }
        
        /* Sidebar Styles */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, rgba(13, 17, 23, 0.95) 0%, rgba(22, 27, 34, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(240, 246, 252, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow: hidden; /* Prevent sidebar itself from scrolling */
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            text-align: center;
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 5px;
        }
        
        .sidebar-subtitle {
            font-size: 0.85rem;
            color: #7d8590;
        }
        
        .sidebar-search {
            padding: 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .search-input {
            width: 100%;
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 12px;
            color: #e6edf3;
            padding: 12px 16px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            border-color: rgba(88, 166, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .search-input::placeholder {
            color: #7d8590;
        }
        
        
        .sidebar-section {
            padding: 20px;
        }
        
        .sidebar-customers {
            padding: 20px;
            flex: 1;
            overflow: hidden; /* Prevent this section from expanding */
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-customers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sidebar-customers-title {
            font-size: 0.9rem;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .add-customer-btn {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-customer-btn:hover {
            background: rgba(88, 166, 255, 0.2);
        }
        
        .customer-list {
            list-style: none;
            padding: 8px;
            margin: 10px 0 0 0;
            max-height: 280px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .customer-item {
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            margin-bottom: 6px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(88, 166, 255, 0.05));
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            min-height: 32px;
            width: 100%;
        }

        .customer-item:hover {
            transform: translateY(-1px);
            border-color: rgba(88, 166, 255, 0.6);
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(88, 166, 255, 0.1));
            box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3);
        }

        .customer-item.active {
            border-color: rgba(88, 166, 255, 0.8);
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.3), rgba(88, 166, 255, 0.2));
            box-shadow: 0 0 0 1px rgba(88, 166, 255, 0.3), 0 2px 8px rgba(88, 166, 255, 0.4);
        }

        .customer-item.active:hover {
            transform: translateY(-1px);
        }

        /* Special styling for All and Unassigned */
        .customer-item[data-customer-id="all"] {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            border-color: rgba(34, 197, 94, 0.4);
        }

        .customer-item[data-customer-id="all"]:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.2));
            border-color: rgba(34, 197, 94, 0.6);
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .customer-item[data-customer-id="unassigned"] {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(249, 115, 22, 0.1));
            border-color: rgba(249, 115, 22, 0.4);
        }

        .customer-item[data-customer-id="unassigned"]:hover {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.3), rgba(249, 115, 22, 0.2));
            border-color: rgba(249, 115, 22, 0.6);
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .customer-name {
            color: #e6edf3;
            font-weight: 500;
            font-size: 0.85rem;
            text-align: center;
            width: 100%;
        }

        
        .main-content {
            margin-left: 321px;
            flex: 1;
        }
        
        .add-customer-form {
            display: none;
            padding: 10px;
            background: rgba(22, 27, 34, 0.8);
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .add-customer-input {
            width: 100%;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 8px;
            color: #e6edf3;
            padding: 8px 12px;
            font-size: 0.85rem;
            outline: none;
            margin-bottom: 8px;
        }
        
        .add-customer-actions {
            display: flex;
            gap: 8px;
        }
        
        .add-customer-save,
        .add-customer-cancel {
            flex: 1;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-customer-save {
            background: rgba(46, 160, 67, 0.2);
            border: 1px solid rgba(46, 160, 67, 0.4);
            color: #3fb950;
        }
        
        .add-customer-cancel {
            background: rgba(248, 81, 73, 0.2);
            border: 1px solid rgba(248, 81, 73, 0.4);
            color: #f85149;
        }
        
        
        
        /* Assign Dropdown */
        .assign-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .assign-button {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }
        
        .assign-button:hover {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.5);
        }
        
        .assign-dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            min-width: 200px;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .assign-dropdown.show .assign-dropdown-content {
            display: block;
        }
        
        .assign-option {
            padding: 10px 16px;
            color: #e6edf3;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .assign-option:last-child {
            border-bottom: none;
        }
        
        .assign-option:hover {
            background: rgba(240, 246, 252, 0.1);
        }
        
        .assign-option.current {
            background: rgba(255, 165, 0, 0.1);
            color: #ffa500;
            font-weight: 500;
        }
        
        .assign-option.new-customer {
            background: rgba(46, 160, 67, 0.1);
            color: #3fb950;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
            font-weight: 500;
        }
        
        .assign-option.new-customer:hover {
            background: rgba(46, 160, 67, 0.2);
        }

        .customer-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(120, 200, 255, 0.05));
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .customer-header:hover {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.15), rgba(120, 200, 255, 0.08));
        }
        
        .customer-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #e6edf3;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .customer-badge {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .customer-stats {
            color: #7d8590;
            font-size: 0.9rem;
        }
        
        .expand-icon {
            color: #58a6ff;
            transition: transform 0.3s ease;
        }
        
        .customer-group.collapsed .expand-icon {
            transform: rotate(-90deg);
        }
        
        .customer-content {
            padding: 30px;
            display: none;
        }
        
        .customer-group:not(.collapsed) .customer-content {
            display: block;
        }
        
        /* Feedback Management Styles */
        .feedback-table {
            background: rgba(22, 27, 34, 0.9);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(240, 246, 252, 0.15);
        }
        
        .feedback-header {
            display: grid;
            grid-template-columns: 100px 120px 150px 1fr 150px 120px 1fr 100px;
            gap: 15px;
            background: rgba(13, 17, 23, 0.8);
            padding: 10px;
            font-weight: 600;
            color: #e6edf3;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .feedback-row {
            display: grid;
            grid-template-columns: 100px 120px 150px 1fr 150px 120px 1fr 100px;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.05);
            transition: background-color 0.2s ease;
        }
        
        .feedback-row:hover {
            background: rgba(240, 246, 252, 0.03);
        }
        
        .feedback-row.positive {
            border-left: 3px solid rgba(46, 160, 67, 0.6);
        }

        .feedback-row.negative {
            border-left: 3px solid rgba(248, 81, 73, 0.6);
        }

        /* Feedback Image Styles */
        .image-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(66, 133, 244, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #4285f4;
            cursor: pointer;
            margin-left: 8px;
        }

        .image-indicator:hover {
            background: rgba(66, 133, 244, 0.3);
        }

        .feedback-images-gallery {
            margin-top: 15px;
            padding: 15px;
            background: rgba(22, 27, 34, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(240, 246, 252, 0.1);
        }

        .feedback-images-title {
            color: rgba(240, 246, 252, 0.8);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .feedback-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .feedback-image-item {
            position: relative;
            aspect-ratio: 1;
            min-height: 120px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(240, 246, 252, 0.2);
            background: rgba(22, 27, 34, 0.8);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback-image-item:hover {
            transform: scale(1.05);
            border-color: rgba(66, 133, 244, 0.5);
        }

        .feedback-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Full Screen Image Viewer */
        .image-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            z-index: 10001;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .viewer-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .image-viewer-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .image-viewer-controls button {
            background: rgba(66, 133, 244, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .image-viewer-controls button:hover {
            background: #4285f4;
        }

        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            font-size: 30px;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        .image-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .image-nav-btn.prev {
            left: 20px;
        }

        .image-nav-btn.next {
            right: 20px;
        }

        .feedback-row.approved {
            border-left: 3px solid rgba(46, 160, 67, 0.8);
            background: rgba(46, 160, 67, 0.05);
        }

        .feedback-row.changes_requested {
            border-left: 3px solid rgba(255, 187, 0, 0.8);
            background: rgba(255, 187, 0, 0.05);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* New 3-level approval system styles */
        .status-badge.perfect {
            background: rgba(46, 160, 67, 0.25);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.5);
            font-weight: 600;
        }

        .status-badge.approved_with_notes {
            background: rgba(0, 122, 255, 0.2);
            color: #007AFF;
            border: 1px solid rgba(0, 122, 255, 0.4);
        }

        .status-badge.rejected {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
            border: 1px solid rgba(255, 69, 58, 0.4);
        }

        /* Backward compatibility styles */
        .status-badge.approved {
            background: rgba(46, 160, 67, 0.2);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.4);
        }

        .status-badge.changes_requested {
            background: rgba(255, 187, 0, 0.2);
            color: #ffbb00;
            border: 1px solid rgba(255, 187, 0, 0.4);
        }

        .status-badge.positive {
            background: rgba(46, 160, 67, 0.15);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        .status-badge.negative {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .status-badge.pending {
            background: rgba(125, 133, 144, 0.15);
            color: #7d8590;
            border: 1px solid rgba(125, 133, 144, 0.3);
        }
        /* Variant Badge Styles */
        .feedback-variant {
            display: flex;
            align-items: center;
        }

        .variant-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(240, 246, 252, 0.2);
            color: #ffffff;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
            /* Removed max-width to show full variant name */
            white-space: nowrap;
        }

        .variant-badge.original {
            background: linear-gradient(45deg, #6b7280, #9ca3af);
            color: #ffffff;
        }
        .feedback-col {
            color: #e6edf3;
            display: flex;
            align-items: center;
        }
        
        .feedback-date {
            font-size: 0.85rem;
        }
        
        .feedback-time {
            display: block;
            font-size: 0.75rem;
            color: #7d8590;
            margin-top: 2px;
        }
        
        .feedback-customer {
            font-weight: 500;
            color: #58a6ff;
        }
        
        .feedback-model {
            font-size: 0.9rem;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .feedback-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .feedback-type-badge.positive {
            background: rgba(46, 160, 67, 0.15);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }
        
        .feedback-type-badge.negative {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }
        
        .feedback-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .category-tag {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            border: 1px solid rgba(88, 166, 255, 0.2);
        }
        
        .feedback-comment {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #c9d1d9;
            max-height: 60px;
            overflow-y: auto;
        }
        
        .feedback-comment em {
            color: #7d8590;
        }

        /* Feedback Actions */
        .feedback-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: linear-gradient(135deg, #2ea043, #3fb950);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #2c8b3b, #3aa946);
            transform: translateY(-1px);
        }

        .restore-btn {
            background: linear-gradient(135deg, #007AFF, #5AC8FA);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .restore-btn:hover {
            background: linear-gradient(135deg, #0066CC, #4AA3D9);
            transform: translateY(-1px);
        }

        .revision-complete-btn {
            background: linear-gradient(135deg, #FF8C00, #FFA500);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .revision-complete-btn:hover {
            background: linear-gradient(135deg, #FF7F00, #FF9500);
            transform: translateY(-1px);
        }

        .archived-label {
            color: #7d8590;
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Feedback View Toggle */
        .feedback-view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(22, 27, 34, 0.8);
            padding: 8px;
            border-radius: 10px;
            width: fit-content;
        }

        .toggle-btn {
            background: transparent;
            color: #7d8590;
            border: 1px solid rgba(240, 246, 252, 0.1);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            border-color: rgba(88, 166, 255, 0.3);
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }

        /* User Management Styles */
        .user-management-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .user-management-list.expanded {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.05);
            transition: background 0.2s ease;
        }
        
        .user-item:hover {
            background: rgba(240, 246, 252, 0.03);
        }
        
        .user-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .user-name {
            color: #e6edf3;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .user-role {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .user-details {
            font-size: 0.8rem;
            color: #7d8590;
            margin-bottom: 8px;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-item-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            color: #e6edf3;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .user-role-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-role {
            color: #7d8590;
            font-size: 0.75rem;
            text-transform: capitalize;
        }
        
        .user-settings-btn {
            padding: 2px 4px;
            font-size: 0.7rem;
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 4px;
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-settings-btn:hover {
            background: rgba(88, 166, 255, 0.25);
            border-color: rgba(88, 166, 255, 0.5);
            transform: scale(1.1);
        }
        
        .user-views {
            color: #7d8590;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        
        .edit-section {
            padding: 20px;
            margin-bottom: 10px;
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 12px;
        }
        
        .section-title {
            color: #e6edf3;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .user-edit-sections {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Logout Section */
        .sidebar-logout {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.5) 0%, rgba(30, 35, 42, 0.3) 100%);
            flex-shrink: 0; /* Prevent logout from shrinking */
        }
        
        .logout-user-info {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        
        .logout-username {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .logout-role {
            color: #7d8590;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .logout-button {
            width: 100%;
            padding: 10px;
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: #f85149;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .logout-button:hover {
            background: rgba(248, 81, 73, 0.2);
            border-color: rgba(248, 81, 73, 0.5);
            transform: translateY(-1px);
        }
        
        /* Modern File Upload Styles */
        .modern-file-upload {
            position: relative;
            border: 2px dashed rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            padding: 30px 20px;
            background: rgba(13, 17, 23, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .modern-file-upload:hover {
            border-color: rgba(88, 166, 255, 0.6);
            background: rgba(88, 166, 255, 0.05);
            transform: translateY(-1px);
        }
        
        .modern-file-upload.drag-over {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
            transform: scale(1.02);
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 2;
        }
        
        .upload-icon-modern {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(121, 192, 255, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #58a6ff;
            transition: all 0.3s ease;
        }
        
        .modern-file-upload:hover .upload-icon-modern {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.3);
        }
        
        .upload-text-modern {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .upload-primary {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .upload-secondary {
            color: #7d8590;
            font-size: 0.85rem;
        }
        
        .upload-border {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .modern-file-upload:hover .upload-border {
            left: 100%;
        }
        
        .file-name-modern {
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 8px;
            color: #58a6ff;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 500;
        }
        
        /* Variant Display Styles */
        .model-variants {
            margin: 15px 0;
            padding: 12px;
            background: rgba(88, 166, 255, 0.05);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
        }
        
        .variants-label {
            color: #e6edf3;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .variants-circles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
            padding: 0;
        }
        
        .variant-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        
        .variant-circle:hover {
            transform: scale(1.2);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .variant-circle.primary {
            border-color: #ffd700;
            border-width: 3px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .variant-circle.primary:hover {
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.7);
        }

        /* Size variant button styles */
        .variant-button {
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #e6edf3;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            margin: 2px;
            backdrop-filter: blur(10px);
        }

        .variant-button:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .variant-button.primary {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .variant-button.primary:hover {
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        }
        
        .variant-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .variant-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .variant-name {
            font-size: 0.75rem;
            color: #c9d1d9;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .variant-url {
            font-size: 0.7rem;
        }
        
        .variant-url a {
            color: #58a6ff;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .variant-url a:hover {
            opacity: 1;
        }
        
        .variant-url-button {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid rgba(88, 166, 255, 0.3);
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .variant-url-button:hover {
            background: rgba(88, 166, 255, 0.2);
            transform: scale(1.1);
        }
        
        .variant-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .variant-wrapper:hover .variant-delete {
            display: flex;
        }
        
        .variant-delete:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .variant-edit-color {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 20px;
            height: 20px;
            background: rgba(88, 166, 255, 0.9);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .variant-wrapper:hover .variant-edit-color {
            display: flex;
        }

        .variant-edit-color:hover {
            background: rgba(88, 166, 255, 1);
            transform: scale(1.1);
        }
        
        /* Variant Type Selection */
        .variant-type-options {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        
        .variant-type-option {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(88, 166, 255, 0.2);
            border-radius: 10px;
            background: rgba(13, 17, 23, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .variant-type-option:hover {
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(88, 166, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .variant-type-option.active {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.15);
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }
        
        .type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .type-label {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        
        .type-desc {
            color: #7d8590;
            font-size: 0.8rem;
        }
        
        .variant-type-option.active .type-label {
            color: #58a6ff;
        }
        
        /* Page System Styles */
        .page {
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        
        /* Content wrapper for pages */
        .dashboard-content {
            padding: 30px;
        }
        
        .sidebar-nav-title {
            padding: 15px 20px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sidebar-nav-links {
            padding: 0 10px;
        }
        
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 4px;
            border: none;
            background: transparent;
            color: #e6edf3;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .sidebar-nav-link:hover {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }
        
        .sidebar-nav-link.active {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            font-weight: 600;
        }
        
        /* Requests Admin Styles */
        
        .nav-icon {
            margin-right: 12px;
            font-size: 1.1em;
        }
        
        .nav-label {
            flex: 1;
        }
        
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        /* Filters Section */
        .filters-section {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-label {
            color: #7d8590;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .filter-select,
        .filter-input {
            padding: 8px 12px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            background: rgba(13, 17, 23, 0.8);
            color: #e6edf3;
            font-size: 0.9rem;
            min-width: 140px;
        }
        
        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        
        .filter-input {
            min-width: 200px;
        }
        
        /* Images Grid */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .image-card {
            background: rgba(13, 17, 23, 0.6);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .image-card:hover {
            border-color: rgba(88, 166, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .image-preview {
            width: 100%;
            height: 160px;
            background: rgba(240, 246, 252, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-info {
            padding: 10px;
        }
        
        .image-title {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        
        .image-meta {
            color: #7d8590;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        
        .image-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }
        
        .image-type-badge {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .image-delete-btn {
            background: none;
            border: none;
            color: #f85149;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        
        .image-delete-btn:hover {
            background: rgba(248, 81, 73, 0.1);
        }
        
        /* Users Section */
        .users-section {
            background: rgba(13, 17, 23, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(240, 246, 252, 0.1);
            overflow: hidden;
        }
        
        .user-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            transition: all 0.2s ease;
        }
        
        .user-card:last-child {
            border-bottom: none;
        }
        
        .user-card:hover {
            background: rgba(88, 166, 255, 0.05);
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(88, 166, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            color: #e6edf3;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .user-role {
            color: #7d8590;
            font-size: 0.85rem;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-action-btn {
            padding: 6px 12px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            background: transparent;
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .user-action-btn:hover {
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        .user-action-btn.danger:hover {
            border-color: #f85149;
            color: #f85149;
        }
        
        .user-customer {
            color: #7d8590;
            font-size: 0.85em;
            margin-left: 8px;
        }
        
        .user-meta {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            font-size: 0.8em;
        }
        
        .user-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(46, 160, 67, 0.15);
            color: #2ea043;
        }
        
        .status-inactive {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }
        
        .user-created {
            color: #7d8590;
        }
        
        /* Customer Logo Management Styles */
        .customer-logo-section {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 8px;
            background: rgba(13, 17, 23, 0.3);
        }
        
        .subsection-title {
            color: #7d8590;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .logo-management {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .current-logo {
            width: 80px;
            height: 80px;
            border: 2px dashed rgba(240, 246, 252, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(240, 246, 252, 0.02);
        }
        
        .current-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-placeholder {
            color: #7d8590;
            font-size: 0.8rem;
            text-align: center;
            padding: 10px;
        }
        
        .logo-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .logo-actions .action-button {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        /* Mobile Responsiveness for Settings Modal */
        @media (max-width: 768px) {
            .settings-modal {
                padding: 10px;
            }
            
            .settings-modal-content {
                max-width: 100%;
                margin: 0;
            }
            
            .settings-modal-header {
                padding: 16px 20px 12px;
            }
            
            .settings-modal-title {
                font-size: 1.1rem;
            }
            
            .settings-modal-body {
                padding: 16px 20px;
                max-height: 70vh;
            }
            
            .settings-section-title {
                font-size: 0.85rem;
            }
            
            .settings-action {
                padding: 10px 14px;
            }
            
            .settings-action-label {
                font-size: 0.9rem;
            }
            
            .settings-action-desc {
                font-size: 0.8rem;
            }
            
            .settings-action-button {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .card-actions-consolidated {
                gap: 6px;
            }
            
            .action-button {
                font-size: 0.7rem;
                padding: 5px 8px;
            }

            /* Mobile Feedback Table Styles */
            .feedback-table {
                border-radius: 8px;
                overflow: visible;
            }

            .feedback-header {
                display: none; /* Hide desktop header on mobile */
            }

            .feedback-row {
                display: block;
                background: rgba(22, 27, 34, 0.95);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 16px;
                border: 1px solid rgba(240, 246, 252, 0.1);
            }

            .feedback-col {
                display: block !important;
                margin-bottom: 12px;
                width: 100% !important;
            }

            .feedback-col:before {
                content: attr(data-label);
                font-weight: 600;
                color: #58a6ff;
                font-size: 0.8rem;
                display: block;
                margin-bottom: 4px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .feedback-date {
                font-size: 0.9rem;
            }

            .feedback-time {
                display: block;
                margin-top: 2px;
                font-size: 0.8rem;
            }

            .feedback-customer {
                font-size: 0.9rem;
                font-weight: 500;
            }

            .feedback-model {
                font-size: 0.9rem;
                word-break: break-word;
            }

            .variant-badge {
                font-size: 0.8rem;
                padding: 3px 6px;
            }

            .status-badge {
                font-size: 0.8rem;
                padding: 4px 8px;
            }

            .feedback-comment {
                font-size: 0.85rem;
                line-height: 1.4;
                word-break: break-word;
                white-space: pre-wrap;
            }

            /* Filter dropdowns stack vertically on mobile */
            .section div[style*="flex"] {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            .futuristic-input {
                min-width: unset !important;
                width: 100% !important;
                margin-bottom: 10px;
            }
        }

        /* Force hide wallpaper upload components - they should not appear anywhere */
        #wallpaperUploadModal,
        #wallpaperUploadForm,
        div[onclick*="wallpaperAlbedoInput"],
        div[onclick*="wallpaperNormalInput"],
        div[onclick*="wallpaperRoughnessInput"],
        div[onclick*="wallpaperHeightInput"],
        input[id*="wallpaper"],
        .wallpaper-preview,
        [class*="wallpaper"] {
            display: none !important;
            visibility: hidden !important;
        }

        /* Data Export Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            font-weight: 500;
        }

        .status-success {
            background: rgba(46, 160, 67, 0.15);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        .status-error {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }
    </style>
</head>
<body style="display: none;">
    
    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Admin Panel</div>
                <div class="sidebar-subtitle">Furniture Management</div>
            </div>
            
            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="Search furniture or customers..." 
                       oninput="handleSearch(this.value)" />
            </div>
            
            <!-- Upload Buttons -->
            <div style="padding: 20px; border-bottom: 1px solid rgba(240, 246, 252, 0.1);">
                <button onclick="toggleUploadModal()" class="modal-button primary" style="width: 100%; padding: 12px; font-size: 0.9rem; background: rgba(88, 166, 255, 0.15); border: 1px solid rgba(88, 166, 255, 0.3); color: #58a6ff; border-radius: 12px; transition: all 0.2s ease; margin-bottom: 10px;">
                     Upload Furniture
                </button>
                <!-- Upload Wallpaper feature temporarily disabled as of Nov 2024 -->
                <!-- <button onclick="toggleWallpaperUploadModal()" class="modal-button primary" style="width: 100%; padding: 12px; font-size: 0.9rem; background: rgba(163, 113, 247, 0.15); border: 1px solid rgba(163, 113, 247, 0.3); color: #a371f7; border-radius: 12px; transition: all 0.2s ease;">
                     Upload Wallpaper
                </button> -->
            </div>
            
            <!-- Navigation Links -->
            <div class="sidebar-section">
                <div class="sidebar-nav-title"> Pages</div>
                <div class="sidebar-nav-links">
                    <button class="sidebar-nav-link active" data-page="dashboard" onclick="navigateToPage('dashboard')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Dashboard</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="images" onclick="navigateToPage('images')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Images</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="users" onclick="navigateToPage('users')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Users</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="feedback" onclick="navigateToPage('feedback')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Feedback</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="requests" onclick="navigateToPage('requests')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Requests</span>
                    </button>
                </div>
            </div>
            
            <!-- Customers Section -->
            <div class="sidebar-customers" style="margin-top: 5px;">
                <div class="sidebar-customers-header">
                    <span class="sidebar-customers-title">Customers</span>
                    <button class="add-customer-btn" onclick="openUserModalForCustomer()">+ Add</button>
                </div>
                
                <!-- Add Customer Form -->
                <div class="add-customer-form" id="addCustomerForm">
                    <input type="text" class="add-customer-input" placeholder="Customer name" id="addCustomerNameInput" onkeydown="handleCustomerNameKeydown(event)" />
                    <div class="add-customer-actions">
                        <button class="add-customer-save" onclick="saveNewCustomer()">Save</button>
                        <button class="add-customer-cancel" onclick="hideAddCustomerForm()">Cancel</button>
                    </div>
                </div>
                
                <ul class="customer-list" id="customerList">
                    <!-- Customer items will be populated here -->
                </ul>
            </div>
            
            <!-- Logout Section -->
            <div class="sidebar-logout">
                <div class="logout-user-info">
                    <span class="logout-username" id="loggedInUsername">admin</span>
                    <span class="logout-role">Administrator</span>
                </div>
                <button class="logout-button" onclick="logout()">Sign Out</button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <div class="page" id="dashboardPage" style="display: block;">
                <div class="header">
                    <div class="header-content">
                        <h1> Dashboard</h1>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Total Furniture</div>
                        <div class="stat-value" id="totalModels">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Total Views</div>
                        <div class="stat-value" id="totalViews">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Storage Used</div>
                        <div class="stat-value" id="totalSize">-</div>
                    </div>
                    </div>

                    <!-- Review Status Statistics -->
                    <div class="section" style="margin-top: 30px; margin-bottom: 30px;">
                        <h3 style="color: #e6edf3; margin-bottom: 20px; font-size: 1.2rem;">Review Status Overview</h3>
                        <div class="stats-grid">
                            <div class="stat-card" style="border-color: rgba(107, 114, 128, 0.3);">
                                <div class="stat-icon"></div>
                                <div class="stat-label">Pending Review</div>
                                <div class="stat-value" id="pendingReviewCount" style="color: #6b7280;">-</div>
                            </div>
                            <div class="stat-card" style="border-color: rgba(245, 158, 11, 0.3);">
                                <div class="stat-icon"></div>
                                <div class="stat-label">Partially Reviewed</div>
                                <div class="stat-value" id="partialReviewCount" style="color: #f59e0b;">-</div>
                            </div>
                            <div class="stat-card" style="border-color: rgba(59, 130, 246, 0.3);">
                                <div class="stat-icon"></div>
                                <div class="stat-label">All Reviewed</div>
                                <div class="stat-value" id="allReviewedCount" style="color: #3b82f6;">-</div>
                            </div>
                            <div class="stat-card" style="border-color: rgba(16, 185, 129, 0.3);">
                                <div class="stat-icon"></div>
                                <div class="stat-label">All Approved</div>
                                <div class="stat-value" id="allApprovedCount" style="color: #10b981;">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="models-section">
                        <div class="section-header">
                            <h2 class="section-title">Uploaded Furniture</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="refresh-button" onclick="loadModels()">Refresh</button>
                                <button class="refresh-button" onclick="exportDataAndOpen()" style="background: linear-gradient(135deg, #48bb78, #56c77c);">
                                     Export Data
                                </button>
                                <button class="refresh-button" onclick="cleanupSheetsData()" style="background: linear-gradient(135deg, #f85149, #ff7b7b);">
                                     Clean Sheets
                                </button>
                            </div>
                        </div>

                        <!-- Category Filter Section -->
                        <div class="filters-section" style="margin-top: 20px; margin-bottom: 20px; padding: 15px; background: rgba(22, 27, 34, 0.5); border-radius: 12px;">
                            <div class="filter-group" style="display: inline-block; margin-right: 20px;">
                                <label class="filter-label" style="display: block; margin-bottom: 5px; color: #7d8590; font-size: 0.85rem;">Filter by Category:</label>
                                <select id="categoryFilterDashboard" onchange="filterByCategory()" class="filter-select" style="padding: 8px 12px; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 6px; background: rgba(13, 17, 23, 0.8); color: #e6edf3;">
                                    <option value="">All Categories</option>
                                    <option value="uncategorized">Uncategorized</option>
                                </select>
                            </div>
                            <div class="filter-group" style="display: inline-block; margin-right: 10px;">
                                <button onclick="clearCategoryFilter()" style="padding: 8px 16px; background: rgba(240, 246, 252, 0.1); color: #e6edf3; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 6px; cursor: pointer;">Clear Filter</button>
                            </div>
                            <div class="filter-group" style="display: inline-block;">
                                <button onclick="openCategoryManager()" style="padding: 8px 16px; background: rgba(88, 166, 255, 0.15); color: #58a6ff; border: 1px solid rgba(88, 166, 255, 0.3); border-radius: 6px; cursor: pointer;">
                                     Manage Categories
                                </button>
                            </div>
                        </div>

                        <div id="modelsContainer">
                            <div class="loading">Loading furniture...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Images Page -->
            <div class="page" id="imagesPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> Images Library</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="showImageUploadModal()" class="action-button primary">
                             Upload Image
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Filter by Type:</label>
                            <select id="imageTypeFilter" class="filter-select" onchange="filterImages()">
                                <option value="all">All Types</option>
                                <option value="logo">Company Logo</option>
                                <option value="customer_logo">Customer Logo</option>
                                <option value="brand">Brand Asset</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filter by Customer:</label>
                            <select id="imageCustomerFilter" class="filter-select" onchange="filterImages()">
                                <option value="all">All Customers</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <input type="text" id="imageSearchFilter" class="filter-input" placeholder="Search images..." oninput="filterImages()">
                        </div>
                    </div>
                    
                    <div class="images-grid" id="imagesGrid">
                        <div class="loading">Loading images...</div>
                    </div>
                </div>
            </div>
            
            <!-- Users Page -->
            <div class="page" id="usersPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> User Management</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="toggleUserModal()" class="action-button primary">
                             Add User
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="users-section">
                        <div id="usersContainer">
                            <div class="loading">Loading users...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Page -->
            <div class="page" id="feedbackPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> Customer Feedback</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="loadFeedback()" class="action-button primary">
                             Refresh
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <!-- Filter Section -->
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Total Feedback</div>
                            <div class="stat-value" id="totalFeedback">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Positive</div>
                            <div class="stat-value" id="positiveFeedback">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Negative</div>
                            <div class="stat-value" id="negativeFeedback">-</div>
                        </div>
                        <div class="stat-card" style="border-color: rgba(46, 160, 67, 0.3);">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Approved</div>
                            <div class="stat-value" id="approvedFeedback" style="color: #2ea043;">-</div>
                        </div>
                        <div class="stat-card" style="border-color: rgba(255, 187, 0, 0.3);">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Changes Requested</div>
                            <div class="stat-value" id="changesRequestedFeedback" style="color: #ffbb00;">-</div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="section" style="margin-bottom: 30px;">
                        <div class="section-header">
                            <h2 class="section-title">Filter Feedback</h2>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                            <select id="customerFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 200px;">
                                <option value="">All Customers</option>
                            </select>
                            <select id="typeFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 150px;">
                                <option value="">All Types</option>
                                <option value="positive"> Positive</option>
                                <option value="negative"> Negative</option>
                                <option value="approved"> Approved</option>
                                <option value="changes_requested"> Changes Requested</option>
                            </select>
                            <select id="modelFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 200px;">
                                <option value="">All Products</option>
                            </select>
                            <select id="categoryFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 180px;">
                                <option value="">All Categories</option>
                                <option value="Quality"> Quality</option>
                                <option value="Design"> Design</option>
                                <option value="AR not working"> AR Issues</option>
                                <option value="Size"> Size</option>
                                <option value="Loading issues"> Loading</option>
                                <option value="Performance"> Performance</option>
                                <option value="Functionality"> Functionality</option>
                                <option value="Color incorrect"> Color</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Feedback Table -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Feedback Details</h2>
                        </div>
                        <div class="feedback-view-toggle">
                            <button class="toggle-btn active" onclick="toggleFeedbackView('active')"> Active</button>
                            <button class="toggle-btn" onclick="toggleFeedbackView('archived')"> Archived</button>
                        </div>
                        <div id="feedbackContainer">
                            <div class="loading">Loading feedback...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Requests Page -->
            <div class="page" id="requestsPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> Customer Requests</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="loadRequests()" class="action-button primary">
                             Refresh
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Total Requests</div>
                            <div class="stat-value" id="totalRequestsAdmin">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="pendingRequestsAdmin">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">In Progress</div>
                            <div class="stat-value" id="inProgressRequestsAdmin">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Completed</div>
                            <div class="stat-value" id="completedRequestsAdmin">0</div>
                        </div>
                    </div>
                    
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Filter by Status:</label>
                            <select id="statusFilterAdmin" onchange="loadRequests()" class="filter-select">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filter by Customer:</label>
                            <select id="customerFilterAdmin" onchange="loadRequests()" class="filter-select">
                                <option value="">All Customers</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="requestsContainer">
                        <div class="loading">Loading requests...</div>
                    </div>
                </div>
            </div>


        </div>
    </div>


    <!-- Category Manager Modal -->
    <div class="password-modal" id="categoryManagerModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; padding: 30px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #e6edf3;">Manage Categories</h3>

            <div style="margin-bottom: 20px;">
                <h4 style="color: #7d8590; font-size: 0.9rem; margin-bottom: 10px;">Add New Category</h4>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCategoryName" placeholder="Category name"
                           class="futuristic-input" style="flex: 1;">
                    <button onclick="addCustomerCategory()" class="futuristic-button"
                            style="background: linear-gradient(135deg, #48bb78, #56c77c); padding: 10px 20px;">
                        Add Category
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="color: #7d8590; font-size: 0.9rem; margin-bottom: 10px;">Existing Categories</h4>
                <div id="categoryList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closeCategoryManager()" class="futuristic-button"
                        style="background: rgba(240, 246, 252, 0.1);">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Modern Category Edit Modal -->
    <div class="settings-modal" id="categoryEditModal" style="display: none;">
        <div class="settings-modal-content" style="max-width: 500px;">
            <div class="settings-modal-header">
                <h3 class="settings-modal-title">
                     Select Product Category
                </h3>
            </div>

            <div class="settings-modal-body">
                <input type="hidden" id="editModelId">

                <div style="margin-bottom: 20px;">
                    <div style="position: relative;">
                        <select id="editCategorySelect" class="futuristic-input"
                                style="width: 100%; padding: 12px; font-size: 14px; background: #0d1117; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 8px; color: #e6edf3;">
                            <option value="">No Category</option>
                        </select>
                        <button onclick="showAddCategoryInput()"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #48bb78, #56c77c); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 12px;">
                            + New
                        </button>
                    </div>
                </div>

                <div id="newCategorySection" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(72, 187, 120, 0.1); border: 1px solid rgba(72, 187, 120, 0.3); border-radius: 8px;">
                    <label style="color: #7d8590; font-size: 0.85rem; margin-bottom: 8px; display: block;">Create New Category</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newCategoryInput" placeholder="Enter category name"
                               class="futuristic-input" style="flex: 1;">
                        <button onclick="createAndSelectCategory()"
                                style="background: linear-gradient(135deg, #48bb78, #56c77c); color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">
                            Create
                        </button>
                        <button onclick="hideAddCategoryInput()"
                                style="background: rgba(240, 246, 252, 0.1); color: #e6edf3; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 6px; padding: 8px 16px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>

                <div style="color: #7d8590; font-size: 0.85rem; margin-bottom: 20px;">
                    Categories are customer-specific and help organize products for easier management and filtering.
                </div>
            </div>

            <div class="settings-modal-footer">
                <button onclick="saveCategoryEdit()" class="settings-action-button"
                        style="background: linear-gradient(135deg, #58a6ff, #6ba3f5); margin-right: 10px;">
                    Save Category
                </button>
                <button onclick="closeCategoryEditModal()" class="settings-close-button">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div class="password-modal" id="uploadModal">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L15.09 8.26L22 9L17 14.74L18.18 21.02L12 18L5.82 21.02L7 14.74L2 9L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title">Upload New Furniture</h3>
                <p class="upload-subtitle">Transform your 3D furniture into AR experiences</p>
            </div>
            
            <form id="uploadForm">
                <div class="futuristic-drop-zone" id="dropZone">
                    <input type="file" id="fileInput" accept=".glb,.gltf" style="display: none;">
                    <div class="drop-zone-content">
                        <div class="drop-animation">
                            <div class="drop-ring"></div>
                            <div class="drop-ring"></div>
                            <div class="drop-ring"></div>
                        </div>
                        <div class="upload-text">
                            <span class="primary-text">Drag & drop your 3D furniture</span>
                            <span class="secondary-text">or <span class="click-text">click to browse</span></span>
                        </div>
                        <div class="format-info">
                            <span class="format-badge">GLB</span>
                            <span class="format-badge">GLTF</span>
                            <span class="size-limit">Max 50MB</span>
                        </div>
                    </div>
                    <div class="drag-overlay">
                        <div class="drag-content">
                            <div class="drag-icon"></div>
                            <span>Drop to upload</span>
                        </div>
                    </div>
                </div>
                
                <div class="file-preview-container" id="filePreviewContainer" style="display: none;">
                    <div class="file-preview-card">
                        <div class="file-icon"></div>
                        <div class="file-info">
                            <div class="file-name" id="previewFileName"></div>
                            <div class="file-size" id="previewFileSize"></div>
                        </div>
                        <button type="button" class="remove-file-btn" onclick="removeFile()"></button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <select id="customerSelect" class="futuristic-input customer-select">
                            <option value="napo:NAPO">NAPO</option>
                            <option value="unassigned:Unassigned">Unassigned</option>
                        </select>
                        <div class="input-line"></div>
                    </div>

                    <div class="input-group">
                        <input type="text" id="titleInput" placeholder="Furniture Title" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 10px;">
                    <div style="position: relative;">
                        <select id="categorySelect" class="futuristic-input" style="padding-right: 70px;">
                            <option value="">Select Category (Optional)</option>
                        </select>
                        <button type="button" onclick="showUploadCategoryInput()"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #48bb78, #56c77c); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 12px; z-index: 10;">
                            + New
                        </button>
                    </div>
                    <div class="input-line"></div>
                    <small class="field-hint">Choose a category to help organize products</small>
                </div>

                <div id="uploadNewCategorySection" style="display: none; margin-top: 10px; padding: 12px; background: rgba(72, 187, 120, 0.1); border: 1px solid rgba(72, 187, 120, 0.3); border-radius: 8px;">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="uploadNewCategoryInput" placeholder="New category name"
                               class="futuristic-input" style="flex: 1; padding: 8px;">
                        <button type="button" onclick="createUploadCategory()"
                                style="background: linear-gradient(135deg, #48bb78, #56c77c); color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 12px;">
                            Add
                        </button>
                        <button type="button" onclick="hideUploadCategoryInput()"
                                style="background: rgba(240, 246, 252, 0.1); color: #e6edf3; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 12px;">
                            
                        </button>
                    </div>
                </div>
                
                <div class="input-group">
                    <textarea id="descriptionInput" placeholder="Description (optional)" rows="2" class="futuristic-input textarea"></textarea>
                    <div class="input-line"></div>
                </div>
                
                <div class="input-group">
                    <input type="url" id="productUrlInput" placeholder="Product URL (where users return after AR)" class="futuristic-input">
                    <div class="input-line"></div>
                    <small class="field-hint">Example: https://yourstore.com/products/sofa-123</small>
                </div>

                <div class="input-group">
                    <input type="text" id="skuInput" placeholder="SKU (optional)" class="futuristic-input">
                    <div class="input-line"></div>
                    <small class="field-hint">Stock Keeping Unit - any unique identifier</small>
                </div>

                <!-- AR Placement Type Toggle -->
                <div class="input-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0;">
                        <div>
                            <span style="font-weight: 500; color: #e6edf3;">AR Placement Type</span>
                            <small style="display: block; color: #7d8590; margin-top: 4px;">How this item anchors in AR space</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; background: rgba(240, 246, 252, 0.05); border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 25px; padding: 4px;">
                            <button type="button" id="placementFloor" class="placement-option active"
                                    onclick="setPlacementType('floor')"
                                    style="padding: 8px 16px; border: none; background: linear-gradient(135deg, #58a6ff, #6ba3f5); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                                 Floor
                            </button>
                            <button type="button" id="placementWall" class="placement-option"
                                    onclick="setPlacementType('wall')"
                                    style="padding: 8px 16px; border: none; background: transparent; color: #7d8590; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                                 Wall
                            </button>
                        </div>
                    </label>
                    <input type="hidden" id="arPlacementInput" name="ar_placement" value="floor">
                    <small class="field-hint">Floor: Tables, chairs, sofas | Wall: Artwork, mirrors, wallpaper</small>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeUploadModal()">Cancel</button>
                    <button type="submit" class="modal-button primary futuristic-primary" id="uploadButton">
                        <span class="button-text">Upload Furniture</span>
                        <div class="button-glow"></div>
                    </button>
                </div>
            </form>
            
            <div id="uploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-label" id="uploadStatus">Uploading...</div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div id="progressBar" class="progress-fill"></div>
                        <div class="progress-glow"></div>
                    </div>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallpaper Upload Modal - DISABLED as of Nov 2024 -->
    <!--
    <div class="password-modal" id="wallpaperUploadModal" style="display: none;">
        <div class="modal-content futuristic-upload" style="max-height: 85vh; overflow-y: auto; max-width: 600px;">
            <div class="upload-header" style="padding: 15px 20px 10px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="width: 32px; height: 32px; background: rgba(163, 113, 247, 0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        
                    </div>
                    <h3 style="margin: 0; font-size: 18px; color: #e6edf3;">Upload Wallpaper</h3>
                </div>
                <p style="margin: 0; color: #7d8590; font-size: 13px;">Create AR wallpaper from texture maps</p>
            </div>

            <form id="wallpaperUploadForm" style="padding: 0 20px 15px;">
                <!-- Basic Info Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div style="margin-bottom: 0;">
                        <label style="display: block; color: #58a6ff; font-size: 13px; margin-bottom: 6px;">Customer</label>
                        <select class="futuristic-input" id="wallpaperCustomerSelect" required style="padding: 8px 12px; font-size: 14px; width: 100%;">
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0;">
                        <label style="display: block; color: #58a6ff; font-size: 13px; margin-bottom: 6px;">Title</label>
                        <input type="text" class="futuristic-input" id="wallpaperTitle" placeholder="e.g., Vintage Brick" required style="padding: 8px 12px; font-size: 14px; width: 100%;">
                    </div>
                </div>

                <!-- Texture Upload Section -->
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #a371f7; margin-bottom: 8px; font-size: 15px;"> Textures</h4>
                    <p style="color: #7d8590; font-size: 12px; margin-bottom: 12px;">Albedo required, others optional</p>

                    <!-- Texture Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <!-- Albedo Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #a371f7;">Albedo*</label>
                            </div>
                            <input type="file" id="wallpaperAlbedoInput" accept="image/*" onchange="handleWallpaperTextureUpload('albedo', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperAlbedoInput').click()" style="border: 2px dashed rgba(163, 113, 247, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(163, 113, 247, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="albedoPreview"></div>
                                <div id="albedoPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Base Color</div>
                                </div>
                            </div>
                        </div>

                        <!-- Normal Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #58a6ff;">Normal</label>
                            </div>
                            <input type="file" id="wallpaperNormalInput" accept="image/*" onchange="handleWallpaperTextureUpload('normal', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperNormalInput').click()" style="border: 2px dashed rgba(88, 166, 255, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(88, 166, 255, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="normalPreview"></div>
                                <div id="normalPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Bumps</div>
                                </div>
                            </div>
                        </div>

                        <!-- Roughness Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #ffa500;">Roughness</label>
                            </div>
                            <input type="file" id="wallpaperRoughnessInput" accept="image/*" onchange="handleWallpaperTextureUpload('roughness', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperRoughnessInput').click()" style="border: 2px dashed rgba(255, 165, 0, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(255, 165, 0, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="roughnessPreview"></div>
                                <div id="roughnessPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Shine</div>
                                </div>
                            </div>
                        </div>

                        <!-- Height Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #10b981;">Height</label>
                            </div>
                            <input type="file" id="wallpaperHeightInput" accept="image/*" onchange="handleWallpaperTextureUpload('height', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperHeightInput').click()" style="border: 2px dashed rgba(16, 185, 129, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(16, 185, 129, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="heightPreview"></div>
                                <div id="heightPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Depth</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wall Dimensions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; color: #58a6ff; font-size: 12px; margin-bottom: 4px;">Width (m)</label>
                        <input type="number" class="futuristic-input" id="wallWidth" value="2.4" min="0.5" max="10" step="0.1" style="padding: 6px 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; color: #58a6ff; font-size: 12px; margin-bottom: 4px;">Height (m)</label>
                        <input type="number" class="futuristic-input" id="wallHeight" value="2.4" min="0.5" max="5" step="0.1" style="padding: 6px 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; color: #58a6ff; font-size: 12px; margin-bottom: 4px;">Tile Repeat</label>
                        <input type="number" class="futuristic-input" id="tileRepeat" value="4" min="1" max="10" step="1" style="padding: 6px 8px; font-size: 13px;">
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="wallpaperUploadProgress" style="display: none; margin-bottom: 15px;">
                    <div style="background: rgba(240, 246, 252, 0.1); border-radius: 6px; overflow: hidden; height: 6px; margin-bottom: 8px;">
                        <div id="wallpaperProgressBar" style="background: linear-gradient(90deg, #a371f7, #667eea); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="text-align: center; font-size: 12px; color: #7d8590;">
                        <span id="wallpaperProgressPercentage">0%</span> - Generating wallpaper...
                    </div>
                </div>

                <div style="display: flex; gap: 10px; padding: 0 20px 20px; margin-top: 10px;">
                    <button type="button" onclick="closeWallpaperUploadModal()" style="flex: 1; padding: 10px; background: rgba(240, 246, 252, 0.1); color: #7d8590; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 8px; cursor: pointer; font-size: 14px;">Cancel</button>
                    <button type="button" onclick="uploadWallpaper()" id="wallpaperUploadButton" disabled style="flex: 2; padding: 10px; background: rgba(163, 113, 247, 0.2); color: #a371f7; border: 1px solid rgba(163, 113, 247, 0.3); border-radius: 8px; cursor: pointer; font-size: 14px; opacity: 0.6;"> Upload Albedo first</button>
                </div>
            </form>

            <div id="wallpaperUploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-label" id="wallpaperUploadStatus">Processing textures...</div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div id="wallpaperProgressBar" class="progress-fill"></div>
                        <div class="progress-glow"></div>
                    </div>
                    <div class="progress-percentage" id="wallpaperProgressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>
    -->

    <!-- User Edit Modal -->
    <div class="password-modal" id="userEditModal" style="display: none;">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title" id="editModalTitle"> Manage User</h3>
                <p class="upload-subtitle" id="editModalSubtitle">Edit user settings and permissions</p>
            </div>
            
            <div class="user-edit-sections">
                <!-- Password Reset Section -->
                <div class="edit-section">
                    <h4 class="section-title"> Password Management</h4>
                    
                    <!-- Current Password Display -->
                    <div class="input-group">
                        <label class="input-label">Current Password:</label>
                        <div class="input-group password-input-group">
                            <input type="password" id="currentPasswordDisplay" value="" class="futuristic-input" readonly>
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('currentPasswordDisplay')" title="Show/Hide Password">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle class="eye-open" cx="12" cy="12" r="3"/>
                                    <path class="eye-closed" d="m9.88 9.88a3 3 0 1 0 4.24 4.24" style="display: none;"/>
                                    <path class="eye-closed" d="m2 2 20 20" style="display: none;"/>
                                    <path class="eye-closed" d="M6.71 6.71C4.5 8.82 2 12 2 12s4 8 11 8c1.78 0 3.3-.46 4.65-1.15" style="display: none;"/>
                                    <path class="eye-closed" d="M17.29 17.29C19.5 15.18 22 12 22 12s-4-8-11-8c-1.78 0-3.3.46-4.65 1.15" style="display: none;"/>
                                </svg>
                            </button>
                            <div class="input-line"></div>
                        </div>
                        <div class="password-note">
                            <small style="color: #7d8590; font-style: italic;">
                                 Passwords are securely hashed - original password cannot be displayed
                            </small>
                        </div>
                    </div>
                    
                    <!-- New Password Field -->
                    <div class="input-group">
                        <label class="input-label">New Password (optional):</label>
                        <div class="input-group password-input-group">
                            <input type="password" id="editNewPassword" placeholder="Enter new password to change" class="futuristic-input">
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('editNewPassword')" title="Show/Hide Password">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle class="eye-open" cx="12" cy="12" r="3"/>
                                    <path class="eye-closed" d="m9.88 9.88a3 3 0 1 0 4.24 4.24" style="display: none;"/>
                                    <path class="eye-closed" d="m2 2 20 20" style="display: none;"/>
                                    <path class="eye-closed" d="M6.71 6.71C4.5 8.82 2 12 2 12s4 8 11 8c1.78 0 3.3-.46 4.65-1.15" style="display: none;"/>
                                    <path class="eye-closed" d="M17.29 17.29C19.5 15.18 22 12 22 12s-4-8-11-8c-1.78 0-3.3.46-4.65 1.15" style="display: none;"/>
                                </svg>
                            </button>
                            <div class="input-line"></div>
                        </div>
                    </div>
                    <button type="button" class="modal-button secondary" onclick="resetUserPassword()" style="width: 100%; margin-top: 10px;">
                        Generate Random Password
                    </button>
                </div>
                
                <!-- Customer Info Section (only for customer role) -->
                <div class="edit-section" id="customerInfoSection" style="display: none;">
                    <h4 class="section-title"> Customer Information</h4>
                    <div class="input-group">
                        <input type="text" id="editCustomerId" placeholder="Customer ID (e.g., napo)" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="editCustomerName" placeholder="Customer Display Name" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                    
                    <!-- Customer Logo Section -->
                    <div class="customer-logo-section">
                        <h5 class="subsection-title"> Customer Logo</h5>
                        <div class="logo-management">
                            <div class="current-logo" id="currentCustomerLogo">
                                <div class="logo-placeholder">No logo uploaded</div>
                            </div>
                            <div class="logo-actions">
                                <button type="button" class="action-button secondary" onclick="showCustomerLogoUpload()">
                                     Upload Logo
                                </button>
                                <button type="button" class="action-button danger" id="removeLogoBtn" onclick="removeCustomerLogo()" style="display: none;">
                                     Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Status Section -->
                <div class="edit-section">
                    <h4 class="section-title"> Account Status</h4>
                    <button type="button" id="toggleStatusBtn" class="modal-button danger" onclick="toggleUserStatus()" style="width: 100%;">
                        Deactivate Account
                    </button>
                    <p id="protectedUserNote" style="display: none; color: #7d8590; font-size: 0.8rem; text-align: center; margin-top: 10px;">
                        Admin users are protected and cannot be deactivated.
                    </p>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="modal-button secondary" onclick="closeUserEditModal()">Cancel</button>
                <button type="button" class="modal-button primary futuristic-primary" onclick="saveUserChanges()">
                    <span class="button-text">Save Changes</span>
                    <div class="button-glow"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="password-modal" id="userModal" style="display: none;">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M12.5 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8ZM16 11l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title">Create New User</h3>
                <p class="upload-subtitle">Add customer or admin accounts</p>
            </div>
            
            <form id="userForm">
                <div class="input-group">
                    <input type="text" id="newUsername" placeholder="Username" class="futuristic-input" required>
                    <div class="input-line"></div>
                </div>
                
                <div class="input-group">
                    <input type="password" id="newPassword" placeholder="Password" class="futuristic-input" required>
                    <div class="input-line"></div>
                </div>
                
                <div class="input-group">
                    <select id="newRole" class="futuristic-input" required>
                        <option value="">Select Role</option>
                        <option value="customer">Customer</option>
                        <option value="admin">Administrator</option>
                    </select>
                    <div class="input-line"></div>
                </div>
                
                <div id="customerFields" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="newCustomerId" placeholder="Customer ID (e.g., napo)" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="newCustomerName" placeholder="Customer Display Name (e.g., Napo)" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="modal-button primary futuristic-primary" id="createUserButton">
                        <span class="button-text">Create User</span>
                        <div class="button-glow"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Variant Modal -->
    <div class="password-modal" id="variantModal" style="display: none;">
        <div class="modal-content futuristic-upload" style="max-width: 500px;">
            <h3 class="upload-title" id="variantModalTitle" style="margin-bottom: 20px;">Add Variant</h3>
            
            <form id="variantForm">
                <!-- Title Input -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <input type="text" id="variantName" placeholder="Variant title" required class="futuristic-input" style="font-size: 1rem;">
                    <div class="input-line"></div>
                </div>

                <!-- Variant Type Selection -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <label style="color: #e6edf3; font-size: 0.9rem; margin-bottom: 10px; display: block;">Variant Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="colorVariantBtn" class="variant-type-btn active" onclick="selectVariantType('color')" style="flex: 1; padding: 12px; border: 2px solid #58a6ff; background: rgba(88, 166, 255, 0.1); color: #58a6ff; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                             Color Variant
                        </button>
                        <button type="button" id="sizeVariantBtn" class="variant-type-btn" onclick="selectVariantType('size')" style="flex: 1; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: #7d8590; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                             Size Variant
                        </button>
                    </div>
                </div>

                <!-- Color Variant Fields -->
                <div id="colorVariantFields" style="margin-bottom: 25px;">
                    <div class="input-group">
                        <label style="color: #e6edf3; font-size: 0.9rem; margin-bottom: 8px; display: block;">Color</label>
                        <input type="color" id="variantColor" value="#6b7280" class="futuristic-input" style="height: 50px; cursor: pointer;">
                        <div class="input-line"></div>
                    </div>
                </div>

                <!-- Size Variant Fields -->
                <div id="sizeVariantFields" style="display: none; margin-bottom: 25px;">
                    <div class="input-group">
                        <input type="text" id="variantDimensions" placeholder="Dimensions (e.g., 60x40cm, Large, XL)" class="futuristic-input">
                        <div class="input-line"></div>
                        <small class="field-hint">Text shown on the size variant button</small>
                    </div>
                </div>
                
                <!-- Product URL Input -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <input type="url" id="variantProductUrl" placeholder="Variant Product URL (optional)" class="futuristic-input">
                    <div class="input-line"></div>
                    <small class="field-hint">URL where users return after viewing this variant in AR</small>
                </div>

                <!-- SKU Input -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <input type="text" id="variantSkuInput" placeholder="Variant SKU (optional)" class="futuristic-input">
                    <div class="input-line"></div>
                    <small class="field-hint">Stock Keeping Unit for this variant</small>
                </div>

                <!-- Upload Area -->
                <div class="modern-file-upload" onclick="document.getElementById('variantFile').click()" id="fileUploadArea" style="margin-bottom: 25px;">
                    <div class="upload-content">
                        <div class="upload-icon-modern">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </div>
                        <div class="upload-text-modern">
                            <span class="upload-primary">Drop GLB file or click to browse</span>
                            <span class="upload-secondary">Max 50MB</span>
                        </div>
                    </div>
                    <div class="upload-border"></div>
                </div>
                
                <input type="file" id="variantFile" accept=".glb,.gltf" style="display: none;" onchange="updateVariantFileName()" required>
                <div id="variantFileName" class="file-name-modern" style="display: none;"></div>
                
                <input type="hidden" name="variantType" value="upload">
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeVariantModal()">Close</button>
                    <div style="font-size: 0.9rem; color: #7d8590; text-align: center; margin-left: 10px;">
                        File will upload automatically when selected
                    </div>
                </div>
            </form>
            
            <div id="variantUploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-label" id="variantUploadStatus">Creating variant...</div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div class="progress-fill" id="variantProgressBar" style="width: 0%;">
                            <div class="progress-glow"></div>
                        </div>
                    </div>
                    <div class="progress-percentage" id="variantProgressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Upload Modal -->
    <div class="password-modal" id="imageUploadModal" style="display: none;">
        <div class="modal-content futuristic-upload" style="max-width: 500px;">
            <h3 class="upload-title">Upload Image</h3>
            <p class="upload-subtitle">Upload logos and brand assets</p>
            
            <form id="imageUploadForm">
                <!-- Image Type Selection -->
                <div class="input-group" style="margin-bottom: 20px;">
                    <select id="imageType" class="futuristic-input" style="width: 100%; background: rgba(13, 17, 23, 0.8); color: #f0f6fc;">
                        <option value="logo">Company Logo</option>
                        <option value="customer_logo">Customer Logo</option>
                        <option value="brand">Brand Asset</option>
                        <option value="general">General Image</option>
                    </select>
                    <div class="input-line"></div>
                </div>
                
                <!-- Upload Area -->
                <div class="modern-file-upload" onclick="document.getElementById('imageFile').click()" id="imageFileUploadArea" style="margin-bottom: 25px;">
                    <div class="upload-content">
                        <div class="upload-icon-modern">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <div class="upload-text-modern">
                            <span class="upload-primary">Drop image or click to browse</span>
                            <span class="upload-secondary">JPG, PNG, WebP, SVG (Max 10MB)</span>
                        </div>
                    </div>
                    <div class="upload-border"></div>
                </div>
                
                <input type="file" id="imageFile" accept=".jpg,.jpeg,.png,.webp,.svg" style="display: none;" onchange="updateImageFileName()">
                <div id="imageFileName" class="file-name-modern" style="display: none;"></div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeImageUploadModal()">Close</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Furniture Settings Modal -->
    <div class="settings-modal" id="furnitureSettingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3 class="settings-modal-title" id="settingsModalTitle">
                     Furniture Settings - Loading...
                </h3>
            </div>
            
            <div class="settings-modal-body">
                <!-- Sharing & Links Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Sharing & Links</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Product URL</div>
                            <div class="settings-action-desc" id="productUrlDesc">Add or edit the product page URL</div>
                        </div>
                        <button class="settings-action-button" id="editUrlButton" onclick="handleEditUrl()">
                            Edit
                        </button>
                    </div>

                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Product SKU</div>
                            <div class="settings-action-desc" id="skuDesc">Unique Stock Keeping Unit</div>
                        </div>
                        <button class="settings-action-button" id="editSkuButton" onclick="handleEditSku()">
                            Edit
                        </button>
                    </div>

                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Copy AR Link</div>
                            <div class="settings-action-desc">Copy the shareable AR viewing link</div>
                        </div>
                        <button class="settings-action-button" id="copyLinkButton" onclick="handleCopyLink()">
                            Copy
                        </button>
                    </div>
                </div>
                
                <!-- Customer Management Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Customer Management</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Assign to Customer</div>
                            <div class="settings-action-desc" id="assignmentDesc">Not assigned to any customer</div>
                        </div>
                        <div style="position: relative;">
                            <button class="settings-action-button" id="assignButton" onclick="toggleCustomerDropdown()">
                                <span id="assignButtonText">Assign</span> 
                            </button>
                            <div id="customerDropdown" style="display: none; position: absolute; top: 100%; right: 0; z-index: 1000; background: #161b22; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 8px; min-width: 200px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                                <!-- Customer options will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Organization Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Organization</div>

                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Product Category</div>
                            <div class="settings-action-desc" id="categoryDesc">Organize by category</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <select id="quickCategorySelect" class="settings-action-button"
                                    style="flex: 1; text-align: left; padding-right: 30px; min-width: 150px; background: #1c2128;">
                                <option value="">No Category</option>
                            </select>
                            <button class="settings-action-button" onclick="showQuickCategoryInput()"
                                    style="background: linear-gradient(135deg, #48bb78, #56c77c); padding: 8px 12px;">
                                + New
                            </button>
                        </div>
                    </div>

                    <div id="quickCategoryInputSection" style="display: none; margin-top: 10px; padding: 12px; background: rgba(72, 187, 120, 0.1); border: 1px solid rgba(72, 187, 120, 0.3); border-radius: 8px;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="quickCategoryInput" placeholder="New category name"
                                   style="flex: 1; padding: 8px; background: #0d1117; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 6px; color: #e6edf3;">
                            <button onclick="createQuickCategory()"
                                    style="background: linear-gradient(135deg, #48bb78, #56c77c); color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">
                                Create
                            </button>
                            <button onclick="hideQuickCategoryInput()"
                                    style="background: rgba(240, 246, 252, 0.1); color: #e6edf3; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 6px; padding: 8px 16px; cursor: pointer;">
                                
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customization Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Customization</div>

                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Add Variant</div>
                            <div class="settings-action-desc">Add color or texture variants</div>
                        </div>
                        <button class="settings-action-button" id="addVariantButton" onclick="handleAddVariant()">
                            Add
                        </button>
                    </div>

                    <div class="settings-action" id="manageVariantsAction" style="display: flex; align-items: center; justify-content: space-between;">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Manage Variants</div>
                            <div class="settings-action-desc" id="variantCountDesc">No variants available</div>
                        </div>
                        <button class="settings-action-button" id="manageVariantsButton" onclick="handleManageVariants()">
                            Manage
                        </button>
                    </div>
                </div>
                
                <!-- Danger Zone Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Danger Zone</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Delete Furniture</div>
                            <div class="settings-action-desc">Permanently remove this furniture and all variants</div>
                        </div>
                        <button class="settings-action-button danger" id="deleteButton" onclick="handleDeleteFurniture()">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="settings-modal-footer">
                <button class="settings-close-button" onclick="closeFurnitureSettingsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        // Admin dashboard loaded - AWS S3 migration active
        let deleteTarget = null;

        // Global feedback management variables
        let currentFeedbackView = 'active';
        let selectedFeedbackIds = new Set();

        // ==================== SEO URL Generation ====================

        /**
         * Generate SEO-friendly URL for a model and variant
         * @param {Object} model - Model object with url_slug, customer_slug, id
         * @param {string|null} variantId - Optional variant ID
         * @param {string|null} variantName - Optional variant name for slug
         * @returns {string} SEO-friendly URL
         */
        function generateSEOUrl(model, variantId = null, variantName = null) {
            if (!model || !model.customer_slug || !model.url_slug) {
                console.warn(' Model missing SEO data, fallback to old URL:', model);
                return `https://newfurniture.live/view?id=${model.id}`;
            }

            // Base SEO URL: /f/{customer-slug}/{product-slug-id}
            const baseUrl = `https://newfurniture.live/f/${model.customer_slug}/${model.url_slug}-${model.id}`;

            if (variantId && variantId !== 'original' && variantName) {
                // Add variant slug if specified
                const variantSlug = variantName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                return `${baseUrl}/${variantSlug}`;
            }

            return baseUrl;
        }

        /**
         * Generate local SEO URL (for same-origin navigation)
         */
        function generateLocalSEOUrl(model, variantId = null, variantName = null) {
            const fullUrl = generateSEOUrl(model, variantId, variantName);
            return fullUrl.replace('https://newfurniture.live', '');
        }

        // Error reporting utility
        async function showErrorReporting(errorMessage, reportData) {
            const reportButton = document.createElement('button');
            reportButton.innerHTML = ' Report this issue to support';
            reportButton.style.cssText = 'margin-top: 10px; padding: 8px 16px; background: #f85149; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;';
            
            reportButton.onclick = async () => {
                const userDescription = prompt('Please describe what you were doing when this error occurred (optional):');
                
                try {
                    await fetch('/api/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'error',
                            comment: `Error: ${errorMessage}\n\nUser description: ${userDescription || 'None provided'}\n\nTechnical details: ${JSON.stringify(reportData, null, 2)}`,
                            customerId: 'admin',
                            itemId: 'system',
                            itemName: 'Admin System',
                            userAgent: navigator.userAgent
                        })
                    });
                    
                    alert(' Issue reported successfully! Our team will investigate.');
                    reportButton.remove();
                } catch (error) {
                    alert(' Unable to submit report. Please contact support directly.');
                }
            };
            
            return reportButton;
        }

        // Enhanced error handling with report option
        function handleAPIError(error, response) {
            console.error('API Error:', error);
            
            if (response && response.showReportButton && response.reportData) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'margin: 10px; padding: 15px; background: #ffeaea; border: 1px solid #f85149; border-radius: 6px;';
                errorDiv.innerHTML = `<p style="color: #d1242f; margin: 0 0 10px 0;">${response.error}</p>`;
                
                showErrorReporting(response.error, response.reportData).then(reportButton => {
                    errorDiv.appendChild(reportButton);
                });
                
                // Try to find a suitable container to show the error
                const container = document.getElementById('modelsContainer') || document.body;
                container.insertBefore(errorDiv, container.firstChild);
            }
        }
        
        // Check authentication before loading any data
        let isAuthenticated = false;
        
        function checkAuthentication() {
            // Check if user is authenticated via session storage
            const authToken = sessionStorage.getItem('adminAuthenticated');
            const userRole = localStorage.getItem('user_role');
            
            // Verify both tokens exist and role is admin
            if (!authToken || authToken !== 'true' || userRole !== 'admin') {
                // Clear any invalid tokens
                sessionStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('user_role');
                localStorage.removeItem('username');
                localStorage.removeItem('customer_id');
                
                // Redirect to login page if not authenticated
                window.location.href = '/login.html';
                return false;
            }
            isAuthenticated = true;
            return true;
        }
        
        // Load models ONLY if authenticated
        if (checkAuthentication()) {
            // Show the body content after authentication is verified
            document.body.style.display = 'block';
            loadModels();
        }
        
        // Initialize customers after customerManager is defined
        // This will be called after the CustomerDataManager class is instantiated
        
        function updateReviewStatusCounts(models) {
            const counts = {
                pending: 0,
                partial: 0,
                all_reviewed: 0,
                all_approved: 0
            };

            models.forEach(model => {
                if (!model.feedback_status || model.feedback_status.status === 'pending') {
                    counts.pending++;
                } else {
                    const status = model.feedback_status.status;
                    if (counts.hasOwnProperty(status)) {
                        counts[status]++;
                    }
                }
            });

            // Update the display
            document.getElementById('pendingReviewCount').textContent = counts.pending;
            document.getElementById('partialReviewCount').textContent = counts.partial;
            document.getElementById('allReviewedCount').textContent = counts.all_reviewed;
            document.getElementById('allApprovedCount').textContent = counts.all_approved;

            console.log(' Review Status Counts:', counts);
        }

        async function loadModels() {
            try {
                // Save current collapse states before refreshing
                saveCurrentCollapseStates();

                console.log(' Fetching fresh data from /api/models...');
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error('Failed to load models');

                const data = await response.json();
                console.log(' Fresh data received from server:', data.models?.length, 'models');

                // Check if any models have SKUs in the fresh data
                const modelsWithSkus = data.models?.filter(m => m.sku);
                console.log(' Models with SKUs in fresh data:', modelsWithSkus.map(m => ({ id: m.id, sku: m.sku })));

                // Store models data globally for variant switching
                window.currentModelsData = data.models;
                console.log(' Updated window.currentModelsData with fresh data');
                
                // Initialize all product URL buttons to show original state
                setTimeout(() => {
                    data.models.forEach(model => {
                        const modelCard = document.querySelector(`[data-model-id="${model.id}"]`);
                        if (modelCard) {
                            const card = modelCard.closest('.model-card');
                            if (card) {
                                updateProductUrlButton(card, model.id, 'original');
                            }
                        }
                        
                        // Trigger dimension validation if dimensions exist
                        if (model.width_meters || model.height_meters || model.depth_meters) {
                            console.log(' Triggering dimension validation for model:', model.id);
                            validateModelDimensions(
                                model.id,
                                model.width_meters,
                                model.height_meters, 
                                model.depth_meters,
                                model.dimension_unit || 'cm'
                            );
                        }
                    });
                }, 100);
                
                // Update main stats
                document.getElementById('totalModels').textContent = data.stats.totalModels || 0;
                document.getElementById('totalViews').textContent = data.stats.totalViews || 0;
                document.getElementById('totalSize').textContent = formatFileSize(data.stats.totalSize || 0);

                // Fetch models with review status for statistics
                try {
                    const statusResponse = await fetch('/api/models-with-status');
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        updateReviewStatusCounts(statusData.models);
                    }
                } catch (error) {
                    console.error('Error fetching review status:', error);
                }

                
                // Group models by customer
                displayGroupedModels(data.models);
                
            } catch (error) {
                console.error('Error loading furniture:', error);
                document.getElementById('modelsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Furniture</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Initialize customers using centralized manager
        async function initializeCustomers() {
            await customerManager.loadFromAPI();
        }
        
        // Legacy function for backward compatibility
        async function loadCustomers() {
            await customerManager.loadFromAPI();
        }
        
        // Update sidebar customer count for specific customer
        function updateSidebarCustomerCount(customerId, count) {
            const customerItems = document.querySelectorAll('.customer-item');
            customerItems.forEach(item => {
                const customerName = item.querySelector('.customer-name').textContent.trim();
                const customer = customerManager.getAllCustomers().find(c => c.name === customerName);
                
                if (customer && customer.id === customerId) {
                    const countBadge = item.querySelector('.customer-count');
                    if (countBadge) {
                        countBadge.textContent = count;
                    }
                }
            });
        }
        
        // Refresh all assign dropdowns with latest customer data
        function refreshAssignDropdowns() {
            // This will be called when assign dropdowns are opened
            // No need to update all at once for performance
        }
        
        function updateCustomerSelect(customers) {
            const select = document.getElementById('customerSelect');
            select.innerHTML = '';
            
            // Add default customers
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = `${customer.id}:${customer.name}`;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            
            // Ensure NAPO is always available
            if (!customers.find(c => c.id === 'napo')) {
                const napoOption = document.createElement('option');
                napoOption.value = 'napo:NAPO';
                napoOption.textContent = 'NAPO';
                select.insertBefore(napoOption, select.firstChild);
            }
        }
        
        function displayGroupedModels(models) {
            if (!models || models.length === 0) {
                document.getElementById('modelsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>No Furniture Yet</h3>
                        <p>Upload your first furniture piece to get started!</p>
                        <br>
                        <button class="action-button" onclick="toggleUploadModal()"> Upload Furniture</button>
                    </div>
                `;
                return;
            }
            
            // Group models by customer
            const customerGroups = {};
            models.forEach(model => {
                const customerKey = model.customer_id || 'unassigned';
                const customerName = model.customer_name || 'Unassigned';
                
                if (!customerGroups[customerKey]) {
                    customerGroups[customerKey] = {
                        id: customerKey,
                        name: customerName,
                        models: [],
                        totalViews: 0,
                        totalSize: 0
                    };
                }
                
                customerGroups[customerKey].models.push(model);
                customerGroups[customerKey].totalViews += model.view_count || 0;
                customerGroups[customerKey].totalSize += model.file_size || 0;
            });
            
            let html = '<div class="customer-groups">';
            
            // Sort customers (NAPO first, then others)
            const sortedCustomers = Object.values(customerGroups).sort((a, b) => {
                if (a.id === 'napo') return -1;
                if (b.id === 'napo') return 1;
                return a.name.localeCompare(b.name);
            });
            
            sortedCustomers.forEach(customer => {
                html += `
                    <div class="customer-group collapsed" data-customer="${customer.id}">
                        <div class="customer-header" onclick="toggleCustomerGroup('${customer.id.replace(/'/g, "\\'")}')">
                            <div class="customer-name">
                                ${customer.name}
                                <span class="customer-badge">${customer.models.length}</span>
                            </div>
                            <div class="customer-stats">
                                ${customer.totalViews} views  ${formatFileSize(customer.totalSize)}
                                <span class="expand-icon"></span>
                            </div>
                        </div>
                        <div class="customer-content">
                            <div class="models-grid">
                                ${customer.models.map(model => generateModelCard(model)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('modelsContainer').innerHTML = html;

            // Restore saved collapse states from localStorage
            const collapsedGroups = JSON.parse(localStorage.getItem('collapsedCustomerGroups') || '{}');
            document.querySelectorAll('[data-customer]').forEach(group => {
                const customerId = group.getAttribute('data-customer');
                // If we have a saved state for this customer
                if (collapsedGroups.hasOwnProperty(customerId)) {
                    if (collapsedGroups[customerId] === false) {
                        // User wants this group expanded
                        group.classList.remove('collapsed');
                    } else {
                        // User wants this group collapsed (or it's the default)
                        group.classList.add('collapsed');
                    }
                }
                // If no saved state, keep default collapsed state
            });
        }
        
        function generateModelCard(model) {
            const viewUrl = generateSEOUrl(model);
            const localViewUrl = generateLocalSEOUrl(model);
            // PRIORITY: Use AWS S3 URL if available, otherwise fall back to Cloudinary
            let modelUrl = model.aws_url || model.cloudinary_url || `/api/model/${model.id}`;

            if (!model.aws_url && model.cloudinary_url && model.cloudinary_url.includes('1756571179025-couch.glb')) {
                modelUrl = 'https://newfurniture-ar-assets.s3.amazonaws.com/furniture-models/Groove_grey-scaled%20(1).glb';
                // Using fallback URL for couch model
            }

            // Check if this is a wallpaper
            const isWallpaper = model.metadata && model.metadata.type === 'wallpaper';
            const albedoUrl = isWallpaper && model.metadata ? model.metadata.albedoUrl : null;

            return `
                <div class="model-card">
                    <div class="model-preview">
                        ${isWallpaper && albedoUrl ? `
                            <div class="wallpaper-preview" onclick="window.open('${viewUrl}', '_blank')" style="width: 100%; height: 200px; background: url('${albedoUrl}') center/cover; border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"> Wallpaper</div>
                                <div style="background: rgba(0,0,0,0.5); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px;">Click to View in AR</div>
                            </div>
                        ` : `
                            <model-viewer
                                class="model-viewer"
                                src="${modelUrl}"
                                alt="${model.title || 'Furniture Piece'}"
                                camera-controls
                                auto-rotate
                                auto-rotate-delay="2000"
                                rotation-per-second="15deg"
                                shadow-intensity="1"
                                camera-orbit="45deg 55deg auto"
                                loading="eager"
                                poster=""
                                environment-image="neutral"
                                exposure="1"
                                onloading=""
                                onload=""
                                onerror="console.error(' Model failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div slot="progress-bar" style="display: none;"></div>
                            </model-viewer>
                            <div style="display: none; align-items: center; justify-content: center; height: 200px; background: #1c2128; color: #7d8590; font-size: 14px;">
                                 Preview not available
                            </div>
                        `}
                    </div>
                    
                    <div class="model-info">
                        <div class="model-title editable-title" data-model-id="${model.id}" ondblclick="startEditTitle(this)">${model.title || 'Untitled'}</div>
                        <div class="model-description">${model.description || 'No description provided'}</div>

                        ${model.product_category ? `
                            <div style="margin: 8px 0;">
                                <span class="category-tag">${formatCategoryName(model.product_category)}</span>
                            </div>
                        ` : ''}

                        <div class="model-meta">
                            <span class="model-id" style="display: none;">${model.id}</span>
                            <span>${formatDate(model.upload_date)}</span>
                        </div>

                        <!-- SKU Section -->
                        ${(() => {
                            return model.sku ? `
                                <div class="sku-info" style="margin: 8px 0; padding: 6px 8px; background: rgba(120, 119, 198, 0.1); border-radius: 6px; border: 1px solid rgba(120, 119, 198, 0.2);">
                                    <div style="font-size: 10px; color: #7877c6; font-weight: 500; margin-bottom: 2px;">SKU</div>
                                    <div class="sku-value" style="font-size: 11px; color: #e6edf3; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; user-select: all;">${model.sku}</div>
                                </div>
                            ` : '';
                        })()}

                        <div class="model-stats">
                            <div class="stat-item">
                                <div class="stat-value">${model.view_count || 0}</div>
                                <div class="stat-label">Views</div>
                            </div>
                        </div>
                        
                        <!-- Dimensions Section -->
                        ${model.width_meters || model.height_meters || model.depth_meters ? `
                            <div class="dimensions-info" data-model-id="${model.id}" style="margin: 12px 0; padding: 8px; background: rgba(88, 166, 255, 0.1); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                <div style="font-size: 11px; color: #58a6ff; font-weight: 500; margin-bottom: 4px;"> Dimensions (${model.dimension_unit || 'cm'})</div>
                                <div style="font-size: 10px; color: #7d8590;">
                                    ${[
                                        model.width_meters ? `W: ${formatDimensionFromMeters(model.width_meters, model.dimension_unit || 'cm')}` : null,
                                        model.height_meters ? `H: ${formatDimensionFromMeters(model.height_meters, model.dimension_unit || 'cm')}` : null,
                                        model.depth_meters ? `D: ${formatDimensionFromMeters(model.depth_meters, model.dimension_unit || 'cm')}` : null
                                    ].filter(Boolean).join('  ')}
                                </div>
                                <div class="dimension-validation" id="validation-${model.id}" style="margin-top: 4px; font-size: 9px; display: none;"></div>
                            </div>
                        ` : ''}
                        
                        ${model.variants && model.variants.length > 0 ? `
                            <div class="variants-circles">
                                <!-- Always show original as first variant with extracted color -->
                                <div class="variant-wrapper">
                                    <div class="variant-circle original-variant"
                                         style="background: ${model.dominant_color || '#6b7280'};"
                                         title="Original"
                                         data-model-id="${model.id}"
                                         onclick="switchToVariant('${model.id}', 'original', '${modelUrl}')">
                                    </div>
                                    <div class="variant-delete"
                                         title="Delete Original"
                                         onclick="deleteVariant('${model.id}-original', '${model.id}', event)"></div>
                                </div>
                                ${model.variants.map(variant => {
                                    const isColorVariant = variant.variant_type === 'color' || (!variant.variant_type && variant.hex_color && variant.hex_color !== '#6b7280');
                                    const isSizeVariant = variant.variant_type === 'size' || variant.dimensions_text;

                                    if (isSizeVariant) {
                                        // Size variant - show as rounded button with color indicator
                                        return `
                                            <div class="variant-wrapper">
                                                <div class="variant-button ${variant.is_primary ? 'primary' : ''}"
                                                     style="border-left: 4px solid ${variant.hex_color || '#6b7280'};"
                                                     title="${variant.variant_name}"
                                                     onclick="switchToVariant('${model.id}', '${variant.id}', '${variant.aws_url || variant.cloudinary_url}', '${variant.hex_color}', '${variant.variant_type || 'upload'}')">
                                                     ${variant.dimensions_text || variant.variant_name}${variant.is_primary ? ' ' : ''}
                                                </div>
                                                <div class="variant-edit-color"
                                                     title="Edit Color"
                                                     onclick="editVariantColorInline('${variant.id}', '${variant.hex_color}', event)"></div>
                                                <div class="variant-delete"
                                                     title="Delete ${variant.variant_name}"
                                                     onclick="deleteVariant('${variant.id}', '${model.id}', event)"></div>
                                            </div>
                                        `;
                                    } else {
                                        // Color variant - show as circle
                                        return `
                                            <div class="variant-wrapper">
                                                <div class="variant-circle ${variant.is_primary ? 'primary' : ''}"
                                                     style="background-color: ${variant.hex_color};"
                                                     title="${variant.variant_name}"
                                                     onclick="switchToVariant('${model.id}', '${variant.id}', '${variant.aws_url || variant.cloudinary_url}', '${variant.hex_color}', '${variant.variant_type || 'upload'}')">
                                                     ${variant.is_primary ? '' : ''}
                                                </div>
                                                <div class="variant-edit-color"
                                                     title="Edit Color"
                                                     onclick="editVariantColorInline('${variant.id}', '${variant.hex_color}', event)"></div>
                                                <div class="variant-delete"
                                                     title="Delete ${variant.variant_name}"
                                                     onclick="deleteVariant('${variant.id}', '${model.id}', event)"></div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="card-actions-consolidated" style="grid-template-columns: repeat(4, 1fr);">
                            <a href="${localViewUrl}" target="_blank" class="action-button primary">
                                 View
                            </a>
                            <button class="action-button primary" onclick="copyToClipboard('${viewUrl}', this)">
                                 Copy
                            </button>
                            <button class="action-button settings" onclick="openFurnitureSettingsModal(${JSON.stringify(model).replace(/"/g, '&quot;')})">
                                 Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function saveCurrentCollapseStates() {
            const collapsedGroups = JSON.parse(localStorage.getItem('collapsedCustomerGroups') || '{}');
            document.querySelectorAll('[data-customer]').forEach(group => {
                const customerId = group.getAttribute('data-customer');
                collapsedGroups[customerId] = group.classList.contains('collapsed');
            });
            localStorage.setItem('collapsedCustomerGroups', JSON.stringify(collapsedGroups));
        }

        function toggleCustomerGroup(customerId) {
            // Find the group by iterating through all customer groups to avoid CSS selector escaping issues
            const groups = document.querySelectorAll('[data-customer]');
            let group = null;
            for (const g of groups) {
                if (g.getAttribute('data-customer') === customerId) {
                    group = g;
                    break;
                }
            }
            console.log('Found group element:', group);
            if (!group) {
                console.error('Could not find group with ID:', customerId);
                return;
            }
            group.classList.toggle('collapsed');

            // Save state to localStorage
            const collapsedGroups = JSON.parse(localStorage.getItem('collapsedCustomerGroups') || '{}');
            collapsedGroups[customerId] = group.classList.contains('collapsed');
            localStorage.setItem('collapsedCustomerGroups', JSON.stringify(collapsedGroups));
        }
        
        function deleteModel(id, cloudinaryPublicId) {
            deleteTarget = { id, cloudinaryPublicId };
            
            if (confirm('Are you sure you want to delete this model?')) {
                // Find the delete button and show loading state
                const deleteButton = document.querySelector(`button[onclick*="${id}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<span class="loading-spinner"></span> Removing...';
                    deleteButton.style.opacity = '0.7';
                }
                confirmDelete();
            }
        }
        
        async function confirmDelete() {
            try {
                const response = await fetch('/api/models', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deleteTarget)
                });
                
                if (!response.ok) throw new Error('Failed to delete model');
                
                // Reload models
                loadModels();
                
            } catch (error) {
                alert('Error deleting model: ' + error.message);
                
                // Reset button state on error
                if (deleteTarget) {
                    const deleteButton = document.querySelector(`button[onclick*="${deleteTarget.id}"]`);
                    if (deleteButton) {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = ' Remove';
                        deleteButton.style.opacity = '1';
                    }
                }
            }
        }
        
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 MB';
            const mb = bytes / (1024 * 1024);
            if (mb < 1) {
                const kb = bytes / 1024;
                return kb.toFixed(1) + ' KB';
            }
            return mb.toFixed(1) + ' MB';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatCategoryName(category) {
            if (!category) return '';
            // Convert from slug format to display format
            return category.split('-').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Format dimensions from meters to display unit
        function formatDimensionFromMeters(meters, unit) {
            if (!meters) return '0';
            
            switch(unit) {
                case 'm': 
                    return meters.toFixed(2);
                case 'in':
                    return (meters / 0.0254).toFixed(1);
                case 'ft':
                    return (meters / 0.3048).toFixed(2);
                default: // cm
                    return (meters * 100).toFixed(0);
            }
        }
        
        // Validate model dimensions against user input
        function validateModelDimensions(modelId, expectedWidth, expectedHeight, expectedDepth, unit) {
            const modelViewer = document.querySelector(`[data-model-id="${modelId}"] model-viewer`);
            if (!modelViewer) return;
            
            const validationDiv = document.getElementById(`validation-${modelId}`);
            if (!validationDiv) return;
            
            // Add small delay to ensure model is loaded
            setTimeout(() => {
                try {
                    const actualDimensions = modelViewer.getDimensions();
                    if (actualDimensions) {
                        console.log(` Model ${modelId} actual dimensions (meters):`, actualDimensions);
                        
                        const tolerance = 0.1; // 10cm tolerance
                        const warnings = [];
                        
                        const checkDimension = (actual, expected, name) => {
                            if (expected && actual && Math.abs(actual - expected) > tolerance) {
                                const actualFormatted = formatDimensionFromMeters(actual, unit);
                                const expectedFormatted = formatDimensionFromMeters(expected, unit);
                                warnings.push(`${name}: model ${actualFormatted}${unit} vs input ${expectedFormatted}${unit}`);
                            }
                        };
                        
                        checkDimension(actualDimensions.x, expectedWidth, 'Width');
                        checkDimension(actualDimensions.y, expectedHeight, 'Height');  
                        checkDimension(actualDimensions.z, expectedDepth, 'Depth');
                        
                        if (warnings.length > 0) {
                            validationDiv.innerHTML = ` Scale mismatch: ${warnings.join(', ')}`;
                            validationDiv.style.color = '#f59e0b';
                            validationDiv.style.display = 'block';
                        } else if (expectedWidth || expectedHeight || expectedDepth) {
                            validationDiv.innerHTML = ` Dimensions match input`;
                            validationDiv.style.color = '#10b981';
                            validationDiv.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.warn('Could not validate dimensions for model', modelId, error);
                }
            }, 2000);
        }
        
        let selectedFile = null;

        // Upload modal functions
        function toggleUploadModal() {
            document.getElementById('uploadModal').style.display = 'flex';
            setupDragAndDrop();
        }
        
        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            selectedFile = null;
            hideFilePreview();
            // Reset AR placement to default
            setPlacementType('floor');
            // Refresh models when modal closes after upload
            if (document.getElementById('uploadProgress').style.display !== 'none') {
                loadModels();
            }
        }

        // AR Placement Type Toggle Function
        function setPlacementType(type) {
            const floorBtn = document.getElementById('placementFloor');
            const wallBtn = document.getElementById('placementWall');
            const placementInput = document.getElementById('arPlacementInput');

            if (type === 'floor') {
                floorBtn.style.background = 'linear-gradient(135deg, #58a6ff, #6ba3f5)';
                floorBtn.style.color = 'white';
                wallBtn.style.background = 'transparent';
                wallBtn.style.color = '#7d8590';
                placementInput.value = 'floor';
            } else {
                wallBtn.style.background = 'linear-gradient(135deg, #58a6ff, #6ba3f5)';
                wallBtn.style.color = 'white';
                floorBtn.style.background = 'transparent';
                floorBtn.style.color = '#7d8590';
                placementInput.value = 'wall';
            }
        }
        
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.onclick = () => fileInput.click();
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, handleDragEnter, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, handleDragLeave, false);
            });

            dropZone.addEventListener('drop', handleFileDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDragEnter(e) {
            document.getElementById('dropZone').classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            document.getElementById('dropZone').classList.remove('drag-over');
        }
        
        function handleFileDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }
        
        function handleFile(file) {
            if (!file.name.match(/\.(glb|gltf)$/i)) {
                alert('Please select a GLB or GLTF file');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                alert('File size must be less than 50MB');
                return;
            }
            
            selectedFile = file;
            showFilePreview(file);
            
            // Auto-fill title
            if (!document.getElementById('titleInput').value) {
                document.getElementById('titleInput').value = file.name.replace(/\.(glb|gltf)$/i, '');
            }
        }
        
        function showFilePreview(file) {
            document.getElementById('previewFileName').textContent = file.name;
            document.getElementById('previewFileSize').textContent = formatFileSize(file.size);
            document.getElementById('filePreviewContainer').style.display = 'block';
            document.getElementById('dropZone').style.display = 'none';
        }
        
        function hideFilePreview() {
            document.getElementById('filePreviewContainer').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
        }
        
        function removeFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            hideFilePreview();
        }
        
        function formatFileSize(bytes) {
            const mb = bytes / (1024 * 1024);
            if (mb < 1) {
                return (bytes / 1024).toFixed(1) + ' KB';
            }
            return mb.toFixed(1) + ' MB';
        }
        
        // Handle upload form with direct Cloudinary upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedFile) {
                alert('Please select a furniture file');
                return;
            }

            const titleInput = document.getElementById('titleInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const productUrlInput = document.getElementById('productUrlInput');
            const skuInput = document.getElementById('skuInput');
            const customerSelect = document.getElementById('customerSelect');
            const categorySelect = document.getElementById('categorySelect');

            // Parse customer selection
            const [customerId, customerName] = customerSelect.value.split(':');

            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadStatus').textContent = 'Uploading furniture...';

            try {
                // Use direct S3 upload for files over 4MB, regular upload for smaller files
                let result;
                const fileSizeMB = selectedFile.size / (1024 * 1024);

                if (fileSizeMB > 4) {
                    // Use direct S3 upload for large files
                    document.getElementById('uploadStatus').textContent = 'Uploading large file directly to AWS S3...';
                    document.getElementById('progressBar').style.width = '30%';
                    document.getElementById('progressPercentage').textContent = '30%';

                    result = await uploadToS3Direct(selectedFile, {
                        title: titleInput.value || selectedFile.name.replace(/\.(glb|gltf)$/i, ''),
                        description: descriptionInput.value || '',
                        sku: skuInput.value.trim() || '',
                        customerId: customerId,
                        customerName: customerName,
                        category: categorySelect.value || '',
                        ar_placement: document.getElementById('arPlacementInput').value || 'floor'
                    });

                    console.log(' Direct S3 upload successful:', result.awsUrl);
                } else {
                    // Use regular upload for small files (under 4MB)
                    document.getElementById('uploadStatus').textContent = 'Uploading to AWS S3...';
                    document.getElementById('progressBar').style.width = '50%';
                    document.getElementById('progressPercentage').textContent = '50%';

                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('title', titleInput.value || selectedFile.name.replace(/\.(glb|gltf)$/i, ''));
                    formData.append('description', descriptionInput.value || '');
                    formData.append('sku', skuInput.value.trim() || '');
                    formData.append('customerId', customerId);
                    formData.append('customerName', customerName);
                    formData.append('category', categorySelect.value || '');
                    formData.append('ar_placement', document.getElementById('arPlacementInput').value || 'floor');

                    const uploadResponse = await fetch('/api/upload-simple', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        throw new Error(`Upload failed: ${errorText}`);
                    }

                    result = await uploadResponse.json();
                    console.log(' AWS upload successful:', result.awsUrl);
                }

                // Update progress
                document.getElementById('uploadStatus').textContent = 'Processing...';
                document.getElementById('progressBar').style.width = '80%';
                document.getElementById('progressPercentage').textContent = '80%';

                // Step 3: Complete
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressPercentage').textContent = '100%';
                document.getElementById('uploadStatus').textContent = ' Upload successful!';

                console.log(' Model uploaded successfully:', result);

                // Close modal and refresh models after 2 seconds
                setTimeout(() => {
                    closeUploadModal();
                    // Models will refresh automatically when modal closes
                }, 1000);

            } catch (error) {
                console.error('Upload failed:', error);
                document.getElementById('uploadStatus').textContent = ' Upload failed: ' + error.message;
                document.getElementById('uploadButton').disabled = false;
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressPercentage').textContent = '0%';
            }
        });
        
        // Auto-refresh removed - models only reload when needed
        
        // Centralized Customer Data Management
        class CustomerDataManager {
            constructor() {
                this.customers = new Map();
                this.listeners = new Set();
            }
            
            // Add or update customer
            setCustomer(customer) {
                const existed = this.customers.has(customer.id);
                this.customers.set(customer.id, customer);
                
                if (existed) {
                    this.notifyListeners('customerUpdated', customer);
                } else {
                    this.notifyListeners('customerAdded', customer);
                }
            }
            
            // Get customer by ID
            getCustomer(customerId) {
                return this.customers.get(customerId);
            }
            
            // Get all customers as array
            getAllCustomers() {
                return Array.from(this.customers.values()).sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Update customer count
            updateCustomerCount(customerId, count) {
                const customer = this.customers.get(customerId);
                if (customer) {
                    customer.count = count;
                    this.notifyListeners('customerCountUpdated', customer);
                }
            }
            
            // Check if customer exists
            hasCustomer(customerId) {
                return this.customers.has(customerId);
            }
            
            // Add event listener
            addListener(callback) {
                this.listeners.add(callback);
            }
            
            // Remove event listener
            removeListener(callback) {
                this.listeners.delete(callback);
            }
            
            // Notify all listeners of changes
            notifyListeners(event, data) {
                this.listeners.forEach(listener => {
                    try {
                        listener(event, data);
                    } catch (error) {
                        console.error('Customer data listener error:', error);
                    }
                });
            }
            
            // Load customers from API
            async loadFromAPI() {
                try {
                    const response = await fetch('/api/customers');
                    if (!response.ok) throw new Error('Failed to load customers');
                    
                    const data = await response.json();
                    data.customers.forEach(customer => {
                        this.customers.set(customer.id, customer);
                    });
                    
                    this.notifyListeners('customersLoaded', this.getAllCustomers());
                } catch (error) {
                    console.error('Error loading customers:', error);
                }
            }
        }
        
        // Global customer manager instance
        const customerManager = new CustomerDataManager();
        
        // Initialize customer data manager listeners and start initialization
        customerManager.addListener((event, data) => {
            switch(event) {
                case 'customersLoaded':
                case 'customerAdded':
                case 'customerUpdated':
                    // Update sidebar customer list
                    updateSidebarCustomers(customerManager.getAllCustomers());
                    // Update assign dropdowns
                    refreshAssignDropdowns();
                    // Update upload modal dropdown
                    updateCustomerSelect(customerManager.getAllCustomers());
                    break;
                    
                case 'customerCountUpdated':
                    // Update sidebar counts
                    updateSidebarCustomerCount(data.id, data.count);
                    break;
            }
        });
        
        // Now initialize customers (after customerManager is ready) - ONLY if authenticated
        if (isAuthenticated) {
            initializeCustomers();
        }
        
        // Sidebar functionality
        let currentCustomerFilter = null;
        let currentCategoryFilter = null;
        let searchQuery = '';
        let allCustomers = []; // Keep for backward compatibility
        
        
        function updateSidebarCustomers(customers) {
            allCustomers = customers;
            const customerList = document.getElementById('customerList');
            customerList.innerHTML = '';
            
            // Add "All Furniture" option
            const totalCount = customers.reduce((sum, c) => sum + c.count, 0);
            const allItem = document.createElement('li');
            allItem.className = `customer-item ${currentCustomerFilter === null ? 'active' : ''}`;
            allItem.setAttribute('data-customer-id', 'all');
            allItem.innerHTML = `
                <span class="customer-name">All Furniture</span>
            `;
            allItem.onclick = () => filterByCustomer(null);
            customerList.appendChild(allItem);
            
            // Add "Unassigned" option - only show if there are unassigned items
            const unassignedCustomer = customers.find(c => c.id === 'unassigned');
            const unassignedCount = unassignedCustomer?.count || 0;
            
            // Only show Unassigned section if there are unassigned items
            if (unassignedCount > 0) {
                const unassignedItem = document.createElement('li');
                unassignedItem.className = `customer-item ${currentCustomerFilter === 'unassigned' ? 'active' : ''}`;
                unassignedItem.setAttribute('data-customer-id', 'unassigned');
                unassignedItem.innerHTML = `
                    <span class="customer-name">Unassigned</span>
                `;
                unassignedItem.onclick = () => filterByCustomer('unassigned', 'Unassigned');
                customerList.appendChild(unassignedItem);
            } else if (currentCustomerFilter === 'unassigned') {
                // If currently filtering by unassigned but no unassigned items exist, reset to "All"
                filterByCustomer(null);
            }
            
            // Customer data loaded successfully
            
            // Add customer items (excluding unassigned which we show separately)
            customers.filter(customer => customer.id !== 'unassigned').forEach(customer => {
                const item = document.createElement('li');
                item.className = `customer-item ${currentCustomerFilter === customer.id ? 'active' : ''}`;
                item.setAttribute('data-customer-id', customer.id);
                item.innerHTML = `
                    <span class="customer-name">${customer.name}</span>
                `;
                item.onclick = () => filterByCustomer(customer.id, customer.name);
                customerList.appendChild(item);
            });
            
        }
        
        function filterByCustomer(customerId, customerName = null) {
            // Always navigate to Dashboard first (if not already there)
            if (currentPage !== 'dashboard') {
                navigateToPage('dashboard');
            }
            
            currentCustomerFilter = customerId;
            
            // Update active state in sidebar
            document.querySelectorAll('.customer-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and highlight the clicked customer
            const customerIdToFind = customerId === null ? 'all' : customerId;
            const clickedCustomer = document.querySelector(`.customer-item[data-customer-id="${customerIdToFind}"]`);
            if (clickedCustomer) {
                clickedCustomer.classList.add('active');
            } else if (event && event.target) {
                // Fallback to event target if available
                const customerItem = event.target.closest('.customer-item');
                if (customerItem) {
                    customerItem.classList.add('active');
                }
            }
            
            // Update header to show current filter
            const headerTitle = document.querySelector('#dashboardPage .header h1');
            if (customerId === null) {
                headerTitle.textContent = ' Admin Dashboard';
            } else {
                headerTitle.textContent = ` ${customerName || 'Customer'} Dashboard`;
            }

            // Apply all filters including category
            applyFilters();
        }

        // Category filtering functions
        function filterByCategory() {
            const categorySelect = document.getElementById('categoryFilterDashboard');
            if (!categorySelect) return;

            currentCategoryFilter = categorySelect.value || null;
            applyFilters();
        }

        function clearCategoryFilter() {
            const categorySelect = document.getElementById('categoryFilterDashboard');
            if (categorySelect) {
                categorySelect.value = '';
            }
            currentCategoryFilter = null;
            applyFilters();
        }

        function applyFilters() {
            const modelCards = document.querySelectorAll('.model-card');
            const customerGroups = document.querySelectorAll('.customer-group');

            // First hide all customer groups
            customerGroups.forEach(group => {
                group.style.display = 'none';
            });

            let hasResults = false;

            modelCards.forEach(card => {
                // Get model data
                const modelId = card.querySelector('.model-id')?.textContent;
                const model = window.currentModelsData?.find(m => m.id === modelId);

                // Check customer filter
                let matchesCustomer = true;
                if (currentCustomerFilter) {
                    const cardCustomerId = card.getAttribute('data-customer-id');
                    matchesCustomer = cardCustomerId === currentCustomerFilter;
                }

                // Check category filter
                let matchesCategory = true;
                if (currentCategoryFilter) {
                    if (currentCategoryFilter === 'uncategorized') {
                        matchesCategory = !model?.product_category;
                    } else {
                        matchesCategory = model?.product_category === currentCategoryFilter;
                    }
                }

                // Check search query
                let matchesSearch = true;
                if (searchQuery) {
                    const title = card.querySelector('.model-title')?.textContent?.toLowerCase() || '';
                    const description = card.querySelector('.model-description')?.textContent?.toLowerCase() || '';
                    const customerName = card.closest('.customer-group')?.querySelector('.customer-name')?.textContent?.toLowerCase() || '';

                    matchesSearch = title.includes(searchQuery) ||
                                  description.includes(searchQuery) ||
                                  customerName.includes(searchQuery);
                }

                // Show/hide card based on all filters
                if (matchesCustomer && matchesCategory && matchesSearch) {
                    card.style.display = '';
                    hasResults = true;
                    // Show the parent group
                    const group = card.closest('.customer-group');
                    if (group) {
                        group.style.display = 'block';
                    }
                } else {
                    card.style.display = 'none';
                }
            });

            // Show empty state if no results
            const modelsContainer = document.getElementById('modelsContainer');
            if (!hasResults && modelsContainer) {
                modelsContainer.innerHTML = '<div class="empty-state">No furniture matches the selected filters.</div>';
            }
        }
        
        function handleSearch(query) {
            searchQuery = query.toLowerCase();
            
            // If no query, show current filter
            if (!searchQuery) {
                filterByCustomer(currentCustomerFilter);
                return;
            }
            
            // Search through all cards
            const modelCards = document.querySelectorAll('.model-card');
            const customerGroups = document.querySelectorAll('.customer-group');
            
            // First hide all groups
            customerGroups.forEach(group => {
                group.style.display = 'none';
            });
            
            // Show cards that match search
            let hasResults = false;
            modelCards.forEach(card => {
                const title = card.querySelector('.model-title')?.textContent?.toLowerCase() || '';
                const description = card.querySelector('.model-description')?.textContent?.toLowerCase() || '';
                const customerName = card.closest('.customer-group')?.querySelector('.customer-name')?.textContent?.toLowerCase() || '';
                
                const matches = title.includes(searchQuery) || 
                               description.includes(searchQuery) || 
                               customerName.includes(searchQuery);
                
                if (matches) {
                    hasResults = true;
                    // Show the parent group
                    const group = card.closest('.customer-group');
                    if (group) {
                        group.style.display = 'block';
                    }
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            if (!hasResults) {
                // Show empty state in main area
                document.getElementById('modelsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>No Results Found</h3>
                        <p>No furniture matches "${query}"</p>
                    </div>
                `;
            }
        }
        
        // Open user modal with customer role pre-selected
        function openUserModalForCustomer() {
            toggleUserModal();
            // Pre-select customer role
            document.getElementById('newRole').value = 'customer';
            // Trigger change event to show customer fields
            document.getElementById('newRole').dispatchEvent(new Event('change'));
            // Focus on username field
            setTimeout(() => {
                document.getElementById('newUsername').focus();
            }, 100);
        }

        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
            document.getElementById('addCustomerNameInput').focus();
        }
        
        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.getElementById('addCustomerNameInput').value = '';
        }
        
        function handleCustomerNameKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveNewCustomer();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                hideAddCustomerForm();
            }
        }
        
        async function saveNewCustomer() {
            const customerName = document.getElementById('addCustomerNameInput').value.trim();
            if (!customerName) return;
            
            try {
                hideAddCustomerForm();
                
                // Create customer ID from name (simple slug)
                const customerId = customerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
                
                // Check if already exists in centralized manager
                if (customerManager.hasCustomer(customerId)) {
                    alert('Customer already exists!');
                    return;
                }
                
                // Add to centralized customer manager
                customerManager.setCustomer({
                    id: customerId,
                    name: customerName,
                    count: 0
                });
                
            } catch (error) {
                alert('Failed to add customer: ' + error.message);
            }
        }
        
        // Update the existing loadCustomers function to also update sidebar
        const originalLoadCustomers = loadCustomers;
        loadCustomers = async function() {
            await originalLoadCustomers();
            
            // Also fetch for sidebar
            try {
                const response = await fetch('/api/customers');
                if (response.ok) {
                    const data = await response.json();
                    updateSidebarCustomers(data.customers);
                }
            } catch (error) {
                console.error('Error loading customers for sidebar:', error);
            }
        };
        
        
        
        function updateCustomerBadges() {
            document.querySelectorAll('.customer-group').forEach(group => {
                const badge = group.querySelector('.customer-badge');
                const cards = group.querySelectorAll('.model-card');
                if (badge) {
                    badge.textContent = cards.length;
                }
            });
        }
        
        // Assign Dropdown Functions
        function toggleAssignDropdown(button, modelId, currentCustomerId, currentCustomerName) {
            // Close any other open dropdowns
            document.querySelectorAll('.assign-dropdown.show').forEach(dropdown => {
                if (dropdown !== button.parentNode) {
                    dropdown.classList.remove('show');
                }
            });
            
            const dropdown = button.parentNode;
            const content = dropdown.querySelector('.assign-dropdown-content');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                return;
            }
            
            // Populate dropdown with customers
            populateAssignDropdown(content, modelId, currentCustomerId, currentCustomerName);
            dropdown.classList.add('show');
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        function populateAssignDropdown(content, modelId, currentCustomerId, currentCustomerName) {
            content.innerHTML = '';
            
            // Show current assignment
            if (currentCustomerId && currentCustomerName) {
                const currentOption = document.createElement('div');
                currentOption.className = 'assign-option current';
                currentOption.innerHTML = ` Currently: ${currentCustomerName}`;
                content.appendChild(currentOption);
            }
            
            // Add all customers from centralized manager
            const customers = customerManager.getAllCustomers();
            customers.forEach(customer => {
                if (customer.id !== currentCustomerId) {
                    const option = document.createElement('div');
                    option.className = 'assign-option';
                    option.textContent = customer.name;
                    option.onclick = () => assignFurnitureToCustomer(modelId, customer.id, customer.name);
                    content.appendChild(option);
                }
            });
            
            // Add "Create New Customer" option
            const newOption = document.createElement('div');
            newOption.className = 'assign-option new-customer';
            newOption.innerHTML = '+ Create New Customer';
            newOption.onclick = () => assignToNewCustomer(modelId);
            content.appendChild(newOption);
        }
        
        async function assignFurnitureToCustomer(modelId, customerId, customerName) {
            try {
                // Close dropdown
                document.querySelectorAll('.assign-dropdown.show').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                
                // No confirmation needed - just assign directly
                
                // Update database via API
                const response = await fetch('/api/assign', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ modelId, customerId, customerName })
                });
                
                if (!response.ok) {
                    const responseText = await response.text();
                    console.error('Assignment API Error Response:', responseText);
                    
                    try {
                        const error = JSON.parse(responseText);
                        throw new Error(error.error || 'Assignment failed');
                    } catch (jsonError) {
                        throw new Error(`API returned non-JSON response: ${responseText.substring(0, 100)}...`);
                    }
                }
                
                const responseText = await response.text();
                console.log('Assignment API Success Response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('Success response is not valid JSON:', responseText);
                    throw new Error(`API returned non-JSON success response: ${responseText.substring(0, 100)}...`);
                }
                
                // Update UI immediately
                updateModelCardAssignment(modelId, customerId, customerName);
                
                alert(` Furniture assigned to ${customerName}!`);
                
                // Refresh data to ensure consistency
                loadModels();
                loadCustomers();
                
            } catch (error) {
                console.error('Assignment error:', error);
                alert('Failed to assign furniture: ' + error.message);
            }
        }
        
        function updateModelCardAssignment(modelId, customerId, customerName) {
            // Find the model card
            const modelCard = Array.from(document.querySelectorAll('.model-card')).find(card => 
                card.querySelector('.model-id').textContent === modelId
            );
            
            if (!modelCard) return;
            
            // Find or create target customer group
            let targetGroup = document.querySelector(`[data-customer="${customerId}"]`);
            
            if (!targetGroup) {
                // Create new customer group
                const groupsContainer = document.querySelector('.customer-groups');
                targetGroup = document.createElement('div');
                targetGroup.className = 'customer-group collapsed';
                targetGroup.setAttribute('data-customer', customerId);
                targetGroup.innerHTML = `
                    <div class="customer-header" onclick="toggleCustomerGroup('${customerId.replace(/'/g, "\\'")}')">
                        <div class="customer-name">
                            ${customerName}
                            <span class="customer-badge">0</span>
                        </div>
                        <div class="customer-stats">
                            0 views  0 B
                            <span class="expand-icon"></span>
                        </div>
                    </div>
                    <div class="customer-content">
                        <div class="models-grid">
                        </div>
                    </div>
                `;
                
                // Insert in alphabetical order
                const existingGroups = Array.from(groupsContainer.children);
                let inserted = false;
                for (let group of existingGroups) {
                    const groupName = group.querySelector('.customer-name')?.textContent.trim() || '';
                    if (customerName.localeCompare(groupName) < 0) {
                        groupsContainer.insertBefore(targetGroup, group);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    groupsContainer.appendChild(targetGroup);
                }
            }
            
            // Move the card
            const targetGrid = targetGroup.querySelector('.models-grid');
            targetGrid.appendChild(modelCard);
            
            // Update assign button to reflect new assignment
            const assignButton = modelCard.querySelector('.assign-button');
            assignButton.setAttribute('onclick', `toggleAssignDropdown(this, '${modelId}', '${customerId}', '${customerName}')`);
            
            // Update customer badges
            updateCustomerBadges();
        }
        
        async function assignToNewCustomer(modelId) {
            const customerName = prompt('Enter new customer name:');
            if (!customerName?.trim()) return;
            
            const customerId = customerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
            
            // Check if already exists in centralized manager
            if (customerManager.hasCustomer(customerId)) {
                alert('Customer already exists!');
                return;
            }
            
            // Add to centralized customer manager (this will trigger all UI updates)
            customerManager.setCustomer({
                id: customerId,
                name: customerName,
                count: 0
            });
            
            // Now assign to this customer
            await assignFurnitureToCustomer(modelId, customerId, customerName);
        }

        // Feedback Management Functions
        async function loadFeedback() {
            try {
                console.log(' Loading feedback...');
                
                // Get filter values
                const customerFilter = document.getElementById('customerFilter')?.value || '';
                const typeFilter = document.getElementById('typeFilter')?.value || '';
                const modelFilter = document.getElementById('modelFilter')?.value || '';
                const categoryFilter = document.getElementById('categoryFilter')?.value || '';
                
                // Build query string
                let queryParams = new URLSearchParams();

                // IMPORTANT: Always include the status filter based on current view
                const statusFilter = currentFeedbackView === 'active' ? 'active' : 'archived';
                queryParams.append('status', statusFilter);

                if (customerFilter) queryParams.append('customer', customerFilter);
                if (typeFilter) queryParams.append('type', typeFilter);
                if (modelFilter) queryParams.append('model', modelFilter);

                const queryString = queryParams.toString();
                const url = `/api/feedback${queryString ? '?' + queryString : ''}`;

                console.log(` Loading feedback with status: ${statusFilter}, URL: ${url}`);
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load feedback');
                
                const data = await response.json();
                console.log(' Feedback data:', data);

                // Debug image counts
                if (data.feedback && data.feedback.length > 0) {
                    console.log('Sample feedback with images:', data.feedback.filter(fb => fb.image_url || fb.imageCount > 0).slice(0, 3).map(fb => ({
                        id: fb.id,
                        image_url: fb.image_url,
                        imageCount: fb.imageCount
                    })));
                }

                // Apply client-side category filtering
                let filteredFeedback = data.feedback || [];
                if (categoryFilter) {
                    filteredFeedback = filteredFeedback.filter(fb =>
                        fb.categories && fb.categories.includes(categoryFilter)
                    );
                }

                displayFeedback(filteredFeedback);
                updateFeedbackStats(filteredFeedback);
                
            } catch (error) {
                console.error('Error loading feedback:', error);
                document.getElementById('feedbackContainer').innerHTML = `
                    <div class="error-message">
                        <p> Failed to load feedback</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function getFeedbackIcon(feedbackType, approvalStatus) {
            // New 3-level approval system
            if (approvalStatus === 'perfect' || feedbackType === 'perfect') {
                return '';
            }
            if (approvalStatus === 'approved_with_notes' || feedbackType === 'approved_with_notes') {
                return '';
            }
            if (approvalStatus === 'rejected' || feedbackType === 'rejected') {
                return '';
            }
            // Backward compatibility
            if (approvalStatus === 'approved' || feedbackType === 'approved') {
                return '';
            }
            if (approvalStatus === 'changes_requested' || feedbackType === 'changes_requested') {
                return '';
            }
            if (feedbackType === 'positive') {
                return '';
            }
            if (feedbackType === 'negative') {
                return '';
            }
            return '';
        }

        function getStatusBadge(feedbackType, approvalStatus) {
            let status, icon, text;

            // New 3-level approval system
            if (approvalStatus === 'perfect' || feedbackType === 'perfect') {
                status = 'perfect';
                icon = '';
                text = 'Perfect';
            } else if (approvalStatus === 'approved_with_notes' || feedbackType === 'approved_with_notes') {
                status = 'approved_with_notes';
                icon = '';
                text = 'Good Enough';
            } else if (approvalStatus === 'rejected' || feedbackType === 'rejected') {
                status = 'rejected';
                icon = '';
                text = 'Needs Revision';
            }
            // Backward compatibility
            else if (approvalStatus === 'approved' || feedbackType === 'approved') {
                status = 'approved';
                icon = '';
                text = 'Approved';
            } else if (approvalStatus === 'changes_requested' || feedbackType === 'changes_requested') {
                status = 'changes_requested';
                icon = '';
                text = 'Changes Requested';
            } else if (feedbackType === 'positive') {
                status = 'positive';
                icon = '';
                text = 'Positive';
            } else if (feedbackType === 'negative') {
                status = 'negative';
                icon = '';
                text = 'Needs Work';
            } else {
                status = 'pending';
                icon = '';
                text = 'Pending';
            }

            return `<span class="status-badge ${status}"><span class="status-icon">${icon}</span><span>${text}</span></span>`;
        }

        function displayFeedback(feedback) {
            console.log(' DisplayFeedback called with:', feedback?.length || 0, 'items');

            // Debug: Check image data for all feedback
            if (feedback && feedback.length > 0) {
                console.log(' Image data for feedback:', feedback.map(fb => ({
                    id: fb.id,
                    image_url: fb.image_url,
                    imageCount: fb.imageCount,
                    shouldShowIcon: fb.image_url || (fb.imageCount && fb.imageCount > 0)
                })));
            }

            const container = document.getElementById('feedbackContainer');

            if (!feedback || feedback.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No feedback found</h3>
                        <p>No customer feedback matches your current filters.</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="feedback-table">
                    ${currentFeedbackView === 'archived' ? `
                        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(22, 27, 34, 0.8); border-radius: 8px; border: 1px solid rgba(240, 246, 252, 0.2);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <span id="selectedCount" style="color: #e6edf3; font-weight: 500;">0 selected</span>
                                    <button onclick="restoreSelected()" class="action-btn" style="background: linear-gradient(135deg, #48bb78, #56c77c);">
                                         Restore Selected
                                    </button>
                                    <button onclick="deleteSelected()" class="action-btn" style="background: linear-gradient(135deg, #f85149, #ff7b7b);">
                                         Delete Selected
                                    </button>
                                </div>
                                <button onclick="clearSelection()" class="action-btn" style="background: rgba(240, 246, 252, 0.1);">
                                    Clear Selection
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    <div class="feedback-header">
                        ${currentFeedbackView === 'archived' ? '<div class="feedback-col" style="width: 50px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="cursor: pointer;"></div>' : ''}
                        <div class="feedback-col">Actions</div>
                        <div class="feedback-col">Date</div>
                        <div class="feedback-col">Customer</div>
                        <div class="feedback-col">Product</div>
                        <div class="feedback-col">Variant</div>
                        <div class="feedback-col">Status</div>
                        <div class="feedback-col">Comment</div>
                    </div>
                    ${feedback.map(fb => `
                        <div class="feedback-row ${fb.feedback_type || fb.approval_status}" data-feedback-id="${fb.id}">
                            ${currentFeedbackView === 'archived' ? `<div class="feedback-col" style="width: 50px;"><input type="checkbox" class="feedback-checkbox" value="${fb.id}" onchange="updateSelection()" style="cursor: pointer;"></div>` : ''}
                            <div class="feedback-col" data-label="Actions">
                                <div class="feedback-actions">
                                    ${(fb.status !== 'archived') ? `
                                        ${(fb.approval_status === 'rejected' || fb.feedback_type === 'rejected') ? `
                                            <button class="action-btn revision-complete-btn" onclick="markRevisionComplete('${fb.id}')" title="Mark revision complete - ready for client review">
                                                 Revision Complete
                                            </button>
                                        ` : `
                                            <button class="action-btn mark-done" onclick="markFeedbackDone('${fb.id}')" title="Mark as Done">
                                                 Done
                                            </button>
                                        `}
                                    ` : `
                                        <button class="action-btn restore-btn" onclick="restoreFeedback('${fb.id}')" title="Restore to Active">
                                             Restore
                                        </button>
                                        <button class="action-btn delete-btn" onclick="deleteFeedback('${fb.id}')" title="Delete Permanently" style="background: linear-gradient(135deg, #f85149, #ff7b7b);">
                                             Delete
                                        </button>
                                    `}
                                </div>
                            </div>
                            <div class="feedback-col" data-label="Date">
                                <div class="feedback-date">
                                    ${new Date(fb.created_at).toLocaleDateString()}
                                    <span class="feedback-time">${new Date(fb.created_at).toLocaleTimeString()}</span>
                                </div>
                            </div>
                            <div class="feedback-col" data-label="Customer">
                                <span class="feedback-customer">${fb.customer_id}</span>
                            </div>
                            <div class="feedback-col" data-label="Product">
                                <span class="feedback-model" title="${fb.model_id}">${fb.model_name || 'Unknown'}</span>
                            </div>
                            <div class="feedback-col" data-label="Variant">
                                <div class="feedback-variant" title="${fb.variant_name || 'Original'}">
                                    ${fb.variant_name ? `
                                        <span class="variant-badge" style="background-color: ${fb.variant_color || '#6b7280'};" title="${fb.variant_name}">
                                            ${fb.variant_name}
                                        </span>
                                    ` : '<span class="variant-badge original" title="Original">Original</span>'}
                                </div>
                            </div>
                            <div class="feedback-col" data-label="Status">
                                ${getStatusBadge(fb.feedback_type, fb.approval_status)}
                            </div>
                            <div class="feedback-col" data-label="Comment">
                                <div class="feedback-comment">
                                    ${fb.comment || '<em>No comment</em>'}
                                    <span class="image-indicator" onclick="toggleFeedbackImages(event, '${fb.id}')" title="Click to view images" style="margin-left: 8px;">
                                         ${fb.imageCount || 0}
                                    </span>
                                </div>
                                <div class="feedback-images-gallery" id="images-${fb.id}" style="display: none;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function updateFeedbackStats(feedback) {
            const total = feedback.length;
            const positive = feedback.filter(fb => fb.feedback_type === 'positive').length;
            const negative = feedback.filter(fb => fb.feedback_type === 'negative').length;
            // New 3-level approval counts
            const perfect = feedback.filter(fb => fb.approval_status === 'perfect' || fb.feedback_type === 'perfect').length;
            const approvedWithNotes = feedback.filter(fb => fb.approval_status === 'approved_with_notes' || fb.feedback_type === 'approved_with_notes').length;
            const rejected = feedback.filter(fb => fb.approval_status === 'rejected' || fb.feedback_type === 'rejected').length;

            // Combined approved count (perfect + approved_with_notes + old approved)
            const totalApproved = perfect + approvedWithNotes + feedback.filter(fb => fb.approval_status === 'approved' || fb.feedback_type === 'approved').length;
            const totalRejected = rejected + feedback.filter(fb => fb.approval_status === 'changes_requested' || fb.feedback_type === 'changes_requested').length;
            
            document.getElementById('totalFeedback').textContent = total;
            document.getElementById('positiveFeedback').textContent = positive;
            document.getElementById('negativeFeedback').textContent = negative;
            document.getElementById('approvedFeedback').textContent = totalApproved;
            document.getElementById('changesRequestedFeedback').textContent = totalRejected;
        }
        
        async function loadFeedbackFilters() {
            try {
                // Load customers for filter
                const customersResponse = await fetch('/api/customers');
                if (customersResponse.ok) {
                    const customersData = await customersResponse.json();
                    const customerFilter = document.getElementById('customerFilter');
                    if (customerFilter && customersData.customers) {
                        customersData.customers.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = `${customer.customer_name} (${customer.customer_id})`;
                            customerFilter.appendChild(option);
                        });
                    }
                }
                
                // Load models for filter
                const modelsResponse = await fetch('/api/models');
                if (modelsResponse.ok) {
                    const modelsData = await modelsResponse.json();
                    const modelFilter = document.getElementById('modelFilter');
                    if (modelFilter && modelsData.models) {
                        const uniqueModels = {};
                        modelsData.models.forEach(model => {
                            if (!uniqueModels[model.id]) {
                                uniqueModels[model.id] = model.title;
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = model.title;
                                modelFilter.appendChild(option);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading feedback filters:', error);
            }
        }
        
        // User Management Functions - Moved to dedicated page
        
        function toggleUserModal() {
            document.getElementById('userModal').style.display = 'flex';
        }
        
        async function loadUsers() {
            const userList = document.getElementById('usersContainer');
            if (!userList) {
                console.error('usersContainer element not found');
                return;
            }
            userList.innerHTML = '<div class="loading-users" style="padding: 20px; text-align: center; color: #7d8590;">Loading users...</div>';
            
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                } else {
                    userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f85149;">Failed to load users</div>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f85149;">Error loading users</div>';
            }
        }
        
        function displayUsers(users) {
            const userList = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #7d8590;">No users found</div>';
                return;
            }
            
            const userHTML = users.map(user => {
                const isAdmin = user.username === 'admin' || user.role === 'admin';
                return `
                    <div class="user-item">
                        <div class="user-item-content">
                            <div class="user-info">
                                <div class="user-name">${user.username}</div>
                                <div class="user-role-container">
                                    <span class="user-role">${user.role}</span>
                                    <button class="user-settings-btn" onclick="openUserEditModal('${user.id}', '${user.username}', '${user.role}', '${user.customer_id || ''}', '${user.customer_name || ''}', ${user.is_active}, ${isAdmin})" title="Manage User">
                                        
                                    </button>
                                </div>
                            </div>
                            ${user.total_views ? `<div class="user-views">Views: ${user.total_views}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            userList.innerHTML = userHTML;
        }
        
        // Global variables for user edit modal
        let currentEditUserId = null;
        let currentEditUserData = {};
        
        function openUserEditModal(userId, username, role, customerId, customerName, isActive, isAdmin) {
            currentEditUserId = userId;
            currentEditUserData = {
                username,
                role,
                customerId,
                customerName,
                isActive,
                isAdmin
            };
            
            // Update modal title
            document.getElementById('editModalTitle').textContent = ` Manage User: ${username}`;
            
            // Show/hide customer info section
            const customerSection = document.getElementById('customerInfoSection');
            if (role === 'customer') {
                customerSection.style.display = 'block';
                document.getElementById('editCustomerId').value = customerId || '';
                document.getElementById('editCustomerName').value = customerName || '';
            } else {
                customerSection.style.display = 'none';
            }
            
            // Update status button
            const statusBtn = document.getElementById('toggleStatusBtn');
            const protectedNote = document.getElementById('protectedUserNote');
            
            if (isAdmin) {
                statusBtn.style.display = 'none';
                protectedNote.style.display = 'block';
            } else {
                statusBtn.style.display = 'block';
                protectedNote.style.display = 'none';
                statusBtn.textContent = isActive ? 'Deactivate Account' : 'Activate Account';
                statusBtn.className = isActive ? 'modal-button danger' : 'modal-button primary';
            }
            
            // Clear password field
            document.getElementById('editNewPassword').value = '';
            
            // Show modal
            document.getElementById('userEditModal').style.display = 'flex';
        }
        
        function closeUserEditModal() {
            document.getElementById('userEditModal').style.display = 'none';
            currentEditUserId = null;
            currentEditUserData = {};
        }
        
        function resetUserPassword() {
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('editNewPassword').value = password;
        }
        
        async function toggleUserStatus() {
            if (!currentEditUserId) return;
            
            const action = currentEditUserData.isActive ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} user "${currentEditUserData.username}"?`)) return;
            
            try {
                const response = await fetch(`/api/users/${currentEditUserId}/toggle`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    currentEditUserData.isActive = !currentEditUserData.isActive;
                    const statusBtn = document.getElementById('toggleStatusBtn');
                    statusBtn.textContent = currentEditUserData.isActive ? 'Deactivate Account' : 'Activate Account';
                    statusBtn.className = currentEditUserData.isActive ? 'modal-button danger' : 'modal-button primary';
                    
                    loadUsers(); // Refresh the list
                    alert(`User ${action}d successfully`);
                } else {
                    alert('Failed to update user status');
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Error updating user status');
            }
        }
        
        async function saveUserChanges() {
            if (!currentEditUserId) return;
            
            const newPassword = document.getElementById('editNewPassword').value.trim();
            const customerId = document.getElementById('editCustomerId').value.trim();
            const customerName = document.getElementById('editCustomerName').value.trim();
            
            try {
                let hasChanges = false;
                
                // Update password if provided
                if (newPassword) {
                    const passwordResponse = await fetch(`/api/users/${currentEditUserId}/password`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: newPassword })
                    });
                    
                    if (!passwordResponse.ok) {
                        alert('Failed to update password');
                        return;
                    }
                    hasChanges = true;
                }
                
                // Update customer info if role is customer and fields have changed
                if (currentEditUserData.role === 'customer' && 
                    (customerId !== currentEditUserData.customerId || customerName !== currentEditUserData.customerName)) {
                    
                    const customerResponse = await fetch(`/api/users/${currentEditUserId}/customer`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            customerId: customerId || currentEditUserData.customerId,
                            customerName: customerName || currentEditUserData.customerName
                        })
                    });
                    
                    if (!customerResponse.ok) {
                        alert('Failed to update customer information');
                        return;
                    }
                    hasChanges = true;
                }
                
                if (hasChanges) {
                    alert('User updated successfully!');
                    loadUsers(); // Refresh the list
                    closeUserEditModal();
                } else {
                    alert('No changes made');
                    closeUserEditModal();
                }
                
            } catch (error) {
                console.error('Error saving user changes:', error);
                alert('Error saving changes');
            }
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentElement.querySelector('.password-toggle-btn');
            const eyeIcon = button.querySelector('.eye-icon');
            const openPaths = eyeIcon.querySelectorAll('.eye-open');
            const closedPaths = eyeIcon.querySelectorAll('.eye-closed');
            
            if (input.type === 'password') {
                // Show password
                input.type = 'text';
                // Hide open eye, show closed eye
                openPaths.forEach(path => path.style.display = 'none');
                closedPaths.forEach(path => path.style.display = 'block');
            } else {
                // Hide password
                input.type = 'password';
                // Show open eye, hide closed eye
                openPaths.forEach(path => path.style.display = 'block');
                closedPaths.forEach(path => path.style.display = 'none');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear authentication tokens
                sessionStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('user_role');
                localStorage.removeItem('username');
                localStorage.removeItem('customer_id');
                
                // Clear session and redirect to login
                fetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login.html';
                    })
                    .catch(() => {
                        // Even if logout API fails, redirect anyway
                        window.location.href = '/login.html';
                    });
            }
        }
        
        // Title editing functions (same as customer view)
        let currentEditElement = null;
        
        function startEditTitle(element) {
            if (currentEditElement) {
                cancelEdit();
            }
            
            currentEditElement = element;
            const currentTitle = element.textContent;
            
            element.innerHTML = `
                <input type="text" 
                       class="title-edit-input" 
                       value="${currentTitle}" 
                       onblur="saveTitle(this)"
                       onkeydown="handleTitleKeydown(event, this)"
                       style="
                           background: rgba(22, 27, 34, 0.8);
                           border: 1px solid rgba(88, 166, 255, 0.5);
                           border-radius: 4px;
                           color: #e6edf3;
                           padding: 4px 8px;
                           font-size: inherit;
                           font-weight: inherit;
                           width: 100%;
                           outline: none;
                       ">
            `;
            
            const input = element.querySelector('.title-edit-input');
            input.focus();
            input.select();
        }
        
        function handleTitleKeydown(event, input) {
            if (event.key === 'Enter') {
                saveTitle(input);
            } else if (event.key === 'Escape') {
                cancelEdit();
            }
        }
        
        async function saveTitle(input) {
            if (!currentEditElement) return;
            
            const newTitle = input.value.trim();
            const modelId = currentEditElement.getAttribute('data-model-id');
            
            if (!newTitle) {
                cancelEdit();
                return;
            }
            
            try {
                // Show loading state
                input.disabled = true;
                input.style.opacity = '0.7';
                
                // API call to update title
                const response = await fetch('/api/models', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: modelId,
                        title: newTitle
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update title');
                }
                
                // Update the display
                currentEditElement.textContent = newTitle;
                console.log(`Updated model ${modelId} title to: ${newTitle}`);
                
                currentEditElement = null;
                
            } catch (error) {
                console.error('Error updating title:', error);
                alert('Failed to save title. Please try again.');
                cancelEdit();
            }
        }
        
        function cancelEdit() {
            if (currentEditElement) {
                const originalTitle = currentEditElement.getAttribute('data-original-title') || currentEditElement.textContent;
                currentEditElement.textContent = originalTitle;
                currentEditElement = null;
            }
        }

        // Product URL editing functions
        let currentEditUrlElement = null;

        function startEditProductUrl(element) {
            if (currentEditUrlElement) {
                cancelUrlEdit();
            }
            
            currentEditUrlElement = element;
            
            // Check if we're editing a variant URL (when a variant is selected)
            const isEditingVariant = element.getAttribute('data-editing-variant') === 'true';
            const variantId = element.getAttribute('data-variant-id');
            const modelId = element.getAttribute('data-model-id');
            
            if (isEditingVariant && variantId) {
                // Redirect to variant editing
                startEditVariantUrl(element);
                return;
            }
            const isEmptyState = element.getAttribute('data-empty') === 'true';
            
            // Store the original URL (if any) as a data attribute
            const originalUrl = isEmptyState ? '' : (element.getAttribute('data-url') || '');
            element.setAttribute('data-original-url', originalUrl);
            
            // Create a form container
            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(22, 27, 34, 0.98), rgba(30, 35, 42, 0.98));
                border: 1px solid rgba(88, 166, 255, 0.3);
                border-radius: 12px;
                padding: 24px;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                min-width: 400px;
            `;
            
            formContainer.innerHTML = `
                <h3 style="color: #e6edf3; margin: 0 0 16px 0; font-size: 1.1rem;">
                    ${isEmptyState ? 'Add Product URL' : 'Edit Product URL'}
                </h3>
                <input type="url" 
                       id="productUrlEditInput"
                       data-model-id="${modelId}"
                       value="${originalUrl}" 
                       placeholder="https://example.com/product" 
                       style="
                           width: 100%;
                           background: rgba(240, 246, 252, 0.1);
                           border: 1px solid rgba(88, 166, 255, 0.5);
                           color: #e6edf3;
                           padding: 10px 14px;
                           border-radius: 8px;
                           font-size: 0.95rem;
                           outline: none;
                           font-family: inherit;
                           margin-bottom: 16px;
                       ">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="cancelUrlEdit()" style="
                        padding: 8px 16px;
                        background: rgba(125, 133, 144, 0.2);
                        border: 1px solid rgba(125, 133, 144, 0.3);
                        color: #7d8590;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Cancel</button>
                    <button onclick="saveProductUrlFromInput()" style="
                        padding: 8px 16px;
                        background: rgba(88, 166, 255, 0.2);
                        border: 1px solid rgba(88, 166, 255, 0.5);
                        color: #58a6ff;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Save</button>
                </div>
            `;
            
            document.body.appendChild(formContainer);
            currentEditUrlElement.formContainer = formContainer;
            
            // Focus the input
            const input = document.getElementById('productUrlEditInput');
            input.focus();
            input.select();
            
            // Handle Enter key
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveProductUrlFromInput();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelUrlEdit();
                }
            });
        }
        
        function saveProductUrlFromInput() {
            const input = document.getElementById('productUrlEditInput');
            if (input) {
                saveProductUrl(input);
            }
        }
        
        function handleUrlKeydown(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveProductUrl(input);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelUrlEdit();
            }
        }
        
        async function saveProductUrl(input) {
            const newUrl = input.value.trim();
            
            // Get model ID from the input's data attribute (set when modal was created)
            const modelId = input.getAttribute('data-model-id');
            
            if (!modelId) {
                console.error('No model ID found');
                return;
            }
            
            // Store references before they might become null
            const buttonElement = currentEditUrlElement;
            const formContainer = currentEditUrlElement ? currentEditUrlElement.formContainer : null;
            
            if (!buttonElement) {
                console.error('No button element found');
                return;
            }
            
            try {
                const response = await fetch('/api/models', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: modelId,
                        product_url: newUrl
                    })
                });
                
                if (response.ok) {
                    // Update the button display using stored reference
                    if (newUrl) {
                        buttonElement.innerHTML = ' Edit URL';
                        buttonElement.removeAttribute('data-empty');
                        buttonElement.setAttribute('data-url', newUrl);
                    } else {
                        buttonElement.innerHTML = ' Add URL';
                        buttonElement.setAttribute('data-empty', 'true');
                        buttonElement.removeAttribute('data-url');
                    }
                    console.log(`Updated model ${modelId} product URL to: ${newUrl}`);
                    
                    // Clean up the form using stored reference
                    if (formContainer) {
                        formContainer.remove();
                    }
                    currentEditUrlElement = null;
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update product URL');
                }
                
            } catch (error) {
                console.error('Error updating product URL:', error);
                alert(`Failed to update product URL: ${error.message}`);
            }
        }
        
        function cancelUrlEdit() {
            if (currentEditUrlElement && currentEditUrlElement.formContainer) {
                // Simply remove the modal
                currentEditUrlElement.formContainer.remove();
                currentEditUrlElement = null;
            }
        }

        // Variant URL editing functions
        let currentEditVariantElement = null;

        function startEditVariantUrl(element) {
            if (currentEditVariantElement) {
                cancelVariantUrlEdit();
            }
            
            currentEditVariantElement = element;
            
            const variantId = element.getAttribute('data-variant-id');
            const isEmptyState = element.getAttribute('data-empty') === 'true';
            
            // Get the original URL - check if it's stored in data attribute or fetch from models data
            let originalUrl = element.getAttribute('data-url') || '';
            
            if (!originalUrl && !isEmptyState && window.currentModelsData) {
                // Try to find the variant's current URL from models data
                const modelId = element.getAttribute('data-model-id') || element.closest('.model-card')?.querySelector('.model-id')?.textContent;
                const model = window.currentModelsData.find(m => m.id === modelId);
                const variant = model?.variants?.find(v => v.id === variantId);
                if (variant?.product_url) {
                    originalUrl = variant.product_url;
                }
            }
            
            // Create modal for variant URL editing
            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(13, 17, 23, 0.95);
                border: 1px solid rgba(240, 246, 252, 0.1);
                border-radius: 12px;
                padding: 24px;
                z-index: 10000;
                min-width: 400px;
                backdrop-filter: blur(10px);
            `;
            
            formContainer.innerHTML = `
                <h3 style="color: #e6edf3; margin: 0 0 16px 0; font-size: 1.1rem;">
                    ${isEmptyState ? 'Add Variant URL' : 'Edit Variant URL'}
                </h3>
                <input type="url" 
                       id="variantUrlEditInput"
                       data-variant-id="${variantId}"
                       value="${originalUrl}" 
                       placeholder="https://example.com/product-variant" 
                       style="
                           width: 100%;
                           background: rgba(240, 246, 252, 0.1);
                           border: 1px solid rgba(88, 166, 255, 0.5);
                           color: #e6edf3;
                           padding: 10px 14px;
                           border-radius: 8px;
                           font-size: 0.95rem;
                           outline: none;
                           font-family: inherit;
                           margin-bottom: 16px;
                       ">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="cancelVariantUrlEdit()" style="
                        padding: 8px 16px;
                        background: rgba(125, 133, 144, 0.2);
                        border: 1px solid rgba(125, 133, 144, 0.3);
                        color: #7d8590;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Cancel</button>
                    <button onclick="saveVariantUrlFromInput()" style="
                        padding: 8px 16px;
                        background: rgba(88, 166, 255, 0.2);
                        border: 1px solid rgba(88, 166, 255, 0.5);
                        color: #58a6ff;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Save</button>
                </div>
            `;
            
            document.body.appendChild(formContainer);
            currentEditVariantElement.formContainer = formContainer;
            
            const input = document.getElementById('variantUrlEditInput');
            input.focus();
            input.select();
        }

        function saveVariantUrlFromInput() {
            const input = document.getElementById('variantUrlEditInput');
            if (input) {
                saveVariantUrl(input);
            }
        }

        async function saveVariantUrl(input) {
            const newUrl = input.value.trim();
            const variantId = input.getAttribute('data-variant-id');
            
            if (!variantId) {
                console.error('No variant ID found');
                return;
            }
            
            const buttonElement = currentEditVariantElement;
            const formContainer = currentEditVariantElement ? currentEditVariantElement.formContainer : null;
            
            if (!buttonElement) {
                console.error('No button element found');
                return;
            }
            
            try {
                const response = await fetch('/api/variants', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: variantId,
                        product_url: newUrl
                    })
                });
                
                if (response.ok) {
                    // Update the button display
                    if (newUrl) {
                        buttonElement.innerHTML = '';
                        buttonElement.removeAttribute('data-empty');
                        buttonElement.setAttribute('data-url', newUrl);
                    } else {
                        buttonElement.innerHTML = '';
                        buttonElement.setAttribute('data-empty', 'true');
                        buttonElement.removeAttribute('data-url');
                    }
                    console.log(`Updated variant ${variantId} product URL to: ${newUrl}`);
                    
                    // Clean up the form
                    if (formContainer) {
                        formContainer.remove();
                    }
                    currentEditVariantElement = null;
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update variant URL');
                }
            } catch (error) {
                console.error('Error updating variant URL:', error);
                alert(`Failed to update variant URL: ${error.message}`);
            }
        }

        function cancelVariantUrlEdit() {
            if (currentEditVariantElement && currentEditVariantElement.formContainer) {
                currentEditVariantElement.formContainer.remove();
                currentEditVariantElement = null;
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
            document.getElementById('customerFields').style.display = 'none';
        }

        // Show/hide customer fields based on role selection
        document.getElementById('newRole').addEventListener('change', function() {
            const customerFields = document.getElementById('customerFields');
            if (this.value === 'customer') {
                customerFields.style.display = 'block';
                document.getElementById('newCustomerId').required = true;
                document.getElementById('newCustomerName').required = true;
            } else {
                customerFields.style.display = 'none';
                document.getElementById('newCustomerId').required = false;
                document.getElementById('newCustomerName').required = false;
            }
        });

        // Handle user creation form submission
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = document.getElementById('createUserButton');
            const buttonText = button.querySelector('.button-text');
            
            // Get form data
            const formData = new FormData(e.target);
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newRole').value
            };

            // Add customer fields if role is customer
            if (userData.role === 'customer') {
                userData.customerId = document.getElementById('newCustomerId').value;
                userData.customerName = document.getElementById('newCustomerName').value;
            }

            // Show loading state
            button.disabled = true;
            buttonText.textContent = 'Creating User...';

            try {
                const response = await fetch('/api/create-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`User "${userData.username}" created successfully!\n\nLogin credentials:\nUsername: ${userData.username}\nPassword: ${userData.password}\nRole: ${userData.role}${userData.role === 'customer' ? `\nCustomer: ${userData.customerName}` : ''}`);
                    closeUserModal();
                    
                    // If creating a customer, immediately add to universal customer manager
                    if (userData.role === 'customer' && userData.customerId && userData.customerName) {
                        customerManager.setCustomer({
                            id: userData.customerId,
                            name: userData.customerName,
                            count: 0
                        });
                    }
                    
                    // Refresh all customer-related UI
                    await customerManager.loadFromAPI();
                } else {
                    alert('Failed to create user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user: ' + error.message);
            } finally {
                // Reset button state
                button.disabled = false;
                buttonText.textContent = 'Create User';
            }
        });

        // Variant Modal Functions
        let currentModelId = null;

        function openVariantModal(modelId, title) {
            currentModelId = modelId;
            document.getElementById('variantModal').style.display = 'flex';
            document.getElementById('variantModalTitle').textContent = 'Add Variant';

            // Reset to color variant type by default
            selectVariantType('color');
        }

        function closeVariantModal() {
            document.getElementById('variantModal').style.display = 'none';
            document.getElementById('variantForm').reset();
            document.getElementById('variantFileName').style.display = 'none';
            document.getElementById('variantProductUrl').value = ''; // Clear product URL
            document.getElementById('variantSkuInput').value = ''; // Clear SKU input
            // Reset upload area appearance
            const uploadArea = document.getElementById('fileUploadArea');
            uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
            uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
            // Variant type is always upload now
            currentModelId = null;
        }

        // Variant type selection functions
        function selectVariantType(type) {
            const colorBtn = document.getElementById('colorVariantBtn');
            const sizeBtn = document.getElementById('sizeVariantBtn');
            const colorFields = document.getElementById('colorVariantFields');
            const sizeFields = document.getElementById('sizeVariantFields');

            // Reset button styles
            colorBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            colorBtn.style.background = 'rgba(255, 255, 255, 0.05)';
            colorBtn.style.color = '#7d8590';
            sizeBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            sizeBtn.style.background = 'rgba(255, 255, 255, 0.05)';
            sizeBtn.style.color = '#7d8590';

            if (type === 'color') {
                // Activate color variant
                colorBtn.style.borderColor = '#58a6ff';
                colorBtn.style.background = 'rgba(88, 166, 255, 0.1)';
                colorBtn.style.color = '#58a6ff';
                colorFields.style.display = 'block';
                sizeFields.style.display = 'none';

                // Clear size fields
                document.getElementById('variantDimensions').value = '';
            } else if (type === 'size') {
                // Activate size variant
                sizeBtn.style.borderColor = '#58a6ff';
                sizeBtn.style.background = 'rgba(88, 166, 255, 0.1)';
                sizeBtn.style.color = '#58a6ff';
                colorFields.style.display = 'none';
                sizeFields.style.display = 'block';

                // Set default color for size variants
                document.getElementById('variantColor').value = '#6b7280';
            }

            // Store selected type
            window.selectedVariantType = type;
        }

        function updateVariantFileName() {
            const fileInput = document.getElementById('variantFile');
            const fileName = document.getElementById('variantFileName');
            const uploadArea = document.getElementById('fileUploadArea');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.style.display = 'block';
                
                // Validate file type
                if (!file.name.match(/\.(glb|gltf)$/i)) {
                    fileName.textContent = ' Invalid file type (GLB/GLTF only)';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                } else if (file.size > 50 * 1024 * 1024) {
                    fileName.textContent = ' File too large (max 50MB)';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                } else {
                    fileName.textContent = ` ${file.name} (${(file.size / (1024 * 1024)).toFixed(1)} MB)`;
                    fileName.style.background = 'rgba(88, 166, 255, 0.1)';
                    fileName.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                    fileName.style.color = '#58a6ff';
                    
                    // Auto-fill variant name from filename (without extension)
                    const variantNameInput = document.getElementById('variantName');
                    if (!variantNameInput.value.trim()) {
                        const nameWithoutExtension = file.name.replace(/\.(glb|gltf)$/i, '');
                        variantNameInput.value = nameWithoutExtension;
                        variantNameInput.placeholder = nameWithoutExtension;
                    }
                    
                    // Auto-upload the variant immediately after file selection
                    setTimeout(() => {
                        uploadVariantFile(file, variantNameInput.value || nameWithoutExtension);
                    }, 500); // Small delay to let UI update
                }
                
                // Update upload area appearance
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.6)';
                uploadArea.style.background = 'rgba(88, 166, 255, 0.05)';
            } else {
                fileName.style.display = 'none';
                // Reset upload area
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
            }
        }

        // Auto-upload function for variants - DIRECT CLOUDINARY UPLOAD
        async function uploadVariantFile(file, variantName) {
            // Capture the modelId early to ensure we have it
            const modelId = currentModelId;
            console.log(' Direct variant upload starting - modelId:', modelId);

            if (!modelId) {
                alert('Error: No model selected');
                return;
            }

            if (!file || !variantName.trim()) {
                console.error('Missing file or variant name');
                return;
            }

            // Update UI to show upload progress
            const fileName = document.getElementById('variantFileName');

            // Get color from user selection
            const variantType = window.selectedVariantType || 'color';
            const hexColor = variantType === 'color' ?
                document.getElementById('variantColor').value : '#6b7280';

            // Show file size for debugging
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            console.log(` Starting direct variant upload: ${fileSizeMB}MB`);

            try {
                // Get variant product URL and SKU from form
                const variantProductUrl = document.getElementById('variantProductUrl').value.trim();
                const variantSku = document.getElementById('variantSkuInput').value.trim();

                // Get variant type and dimensions text
                const variantType = window.selectedVariantType || 'color';
                const dimensionsText = variantType === 'size' ?
                    document.getElementById('variantDimensions').value.trim() || null : null;

                let result;

                // Use direct S3 upload for files over 4MB
                if (file.size > 4 * 1024 * 1024) {
                    fileName.textContent = `Uploading large variant (${fileSizeMB}MB) directly to S3...`;
                    fileName.style.color = '#f1c40f';

                    result = await uploadToS3Direct(file, {
                        parentModelId: modelId,
                        variantName: variantName,
                        hexColor: hexColor,
                        sku: variantSku || '',
                        isVariant: true,
                        variantProductUrl: variantProductUrl || '',
                        variantType: variantType,
                        dimensionsText: dimensionsText || ''
                    });
                } else {
                    // Use regular upload for small files
                    fileName.textContent = `Uploading ${fileSizeMB}MB to AWS S3...`;
                    fileName.style.color = '#f1c40f';

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('parentModelId', modelId);
                    formData.append('variantName', variantName);
                    formData.append('hexColor', hexColor);
                    formData.append('sku', variantSku || '');
                    formData.append('isVariant', 'true');
                    formData.append('variantProductUrl', variantProductUrl || '');
                    formData.append('variantType', variantType);
                    formData.append('dimensionsText', dimensionsText || '');

                    fileName.textContent = 'Uploading to AWS S3...';
                    fileName.style.color = '#58a6ff';

                    const uploadResponse = await fetch('/api/upload-simple', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        console.error(' Upload variant error response:', errorText);
                        throw new Error(`Failed to upload variant: ${errorText}`);
                    }

                    result = await uploadResponse.json();
                }

                console.log(' Variant uploaded successfully via AWS S3:', result);

                // Update UI to show success
                fileName.textContent = ' Variant uploaded!';
                fileName.style.color = '#27ae60';

                // No popup alert - just close modal and reload
                closeVariantModal();

                // Extract and save dominant color for the new variant AFTER page reload
                if (result.success && result.id) {
                    // Store the variant ID for color extraction after reload
                    console.log(' Storing color extraction data:', { variantId: result.id, modelId: modelId });
                    sessionStorage.setItem('extractColorForVariant', JSON.stringify({
                        variantId: result.id,
                        modelId: modelId
                    }));
                }
                
                // Models will refresh when variant modal closes
                
            } catch (error) {
                console.error(' Direct variant upload failed:', error);

                // Show error in filename area
                fileName.textContent = ` Upload failed: ${error.message}`;
                fileName.style.color = '#f85149';
            }
        }

        // Keep the form submission handler for backwards compatibility (but it won't be used)
        document.getElementById('variantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Auto-upload is now handled in updateVariantFileName()
            console.log('Form submission prevented - using auto-upload instead');
        });

        // Convert hex color to RGBA array (0-1 range) for model-viewer
        function hexToRGBA(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return [r, g, b, 1.0];
        }
        
        // Extract dominant color from rendered GLB using model-viewer screenshot
        async function extractDominantColor(modelViewer) {
            try {
                console.log(' Starting color extraction for model-viewer...');
                
                // Use model-viewer's toDataURL method to get a screenshot
                const dataURL = await modelViewer.toDataURL('image/png', 0.9);
                console.log(' Screenshot captured, analyzing pixels...');
                
                // Create an image and canvas to analyze pixels
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas size to sample area
                        const sampleSize = 150;
                        canvas.width = sampleSize;
                        canvas.height = sampleSize;
                        
                        // Draw the image scaled down to sample size
                        ctx.drawImage(img, 0, 0, sampleSize, sampleSize);
                        
                        // Get pixel data from center area (avoid background)
                        const centerSize = 100;
                        const centerOffset = (sampleSize - centerSize) / 2;
                        const imageData = ctx.getImageData(centerOffset, centerOffset, centerSize, centerSize);
                        const pixels = imageData.data;
                        
                        console.log(` Analyzing ${pixels.length / 4} pixels from center area...`);
                        
                        // Calculate dominant color with more lenient filtering
                        const colorCounts = {};
                        const threshold = 20; // Group similar colors (increased for better grouping)
                        let totalValidPixels = 0;
                        
                        for (let i = 0; i < pixels.length; i += 4) {
                            const r = pixels[i];
                            const g = pixels[i + 1];
                            const b = pixels[i + 2];
                            const a = pixels[i + 3];
                            
                            // More lenient filtering - accept more pixels
                            // Skip only fully transparent or pure black/white pixels
                            if (a < 100) continue; // Less strict alpha filtering
                            
                            const brightness = (r + g + b) / 3;
                            // Skip only very dark (< 30) or very bright (> 225) pixels
                            if (brightness < 30 || brightness > 225) continue;
                            
                            totalValidPixels++;
                            
                            // Group similar colors to find dominant shade
                            const groupedR = Math.floor(r / threshold) * threshold;
                            const groupedG = Math.floor(g / threshold) * threshold;
                            const groupedB = Math.floor(b / threshold) * threshold;
                            
                            const colorKey = `${groupedR},${groupedG},${groupedB}`;
                            colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;
                        }
                        
                        console.log(` Found ${totalValidPixels} valid pixels in ${Object.keys(colorCounts).length} color groups`);
                        
                        // Debug: Log top 5 colors
                        const sortedColors = Object.entries(colorCounts)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5);
                        
                        console.log(' Top colors found:', sortedColors.map(([color, count]) => {
                            const [r, g, b] = color.split(',').map(Number);
                            const hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                            return `${hex} (${count} pixels)`;
                        }));
                        
                        // Find the most common color
                        let dominantColor = '#6b7280';
                        let maxCount = 0;
                        
                        for (const [colorKey, count] of Object.entries(colorCounts)) {
                            if (count > maxCount) {
                                maxCount = count;
                                const [r, g, b] = colorKey.split(',').map(Number);
                                const hexR = Math.max(0, Math.min(255, r)).toString(16).padStart(2, '0');
                                const hexG = Math.max(0, Math.min(255, g)).toString(16).padStart(2, '0');
                                const hexB = Math.max(0, Math.min(255, b)).toString(16).padStart(2, '0');
                                dominantColor = `#${hexR}${hexG}${hexB}`;
                            }
                        }
                        
                        console.log(' Final dominant color:', dominantColor, `(${maxCount} pixels, ${(maxCount/totalValidPixels*100).toFixed(1)}%)`);
                        
                        // If we didn't find enough valid pixels, return a neutral color
                        if (totalValidPixels < 10) {
                            console.warn(' Not enough valid pixels found, using fallback color');
                            dominantColor = '#8b9198'; // Slightly warmer gray
                        }
                        
                        resolve(dominantColor);
                    };
                    
                    img.onerror = () => {
                        console.warn(' Failed to load model screenshot');
                        resolve('#6b7280');
                    };
                    
                    img.src = dataURL;
                });
                
            } catch (error) {
                console.warn(' Failed to extract visual dominant color:', error);
                return '#6b7280'; // Fallback gray
            }
        }
        
        function rgbToHsl(r, g, b) {
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }
        
        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [r, g, b];
        }
        
        function intelligentColorRemap(originalRgba, targetRgba) {
            const [or, og, ob] = originalRgba;
            const [tr, tg, tb] = targetRgba;
            
            // Convert to HSL for better color manipulation
            const [oh, os, ol] = rgbToHsl(or, og, ob);
            const [th, ts, tl] = rgbToHsl(tr, tg, tb);
            
            // Preserve original lightness and saturation characteristics
            // but shift the hue towards the target color
            const newH = th; // Use target hue
            const newS = Math.max(os * 0.7, ts * 0.5); // Blend saturation
            const newL = ol * (tl / 0.5); // Adjust lightness proportionally
            
            const [newR, newG, newB] = hslToRgb(newH, Math.min(newS, 1), Math.min(newL, 1));
            return [newR, newG, newB, originalRgba[3]];
        }
        
        function detectMaterialType(material) {
            // Analyze PBR properties to determine material type
            const pbr = material.pbrMetallicRoughness;
            if (!pbr) return 'unknown';
            
            const baseColor = pbr.baseColorFactor || [1, 1, 1, 1];
            const roughness = pbr.roughnessFactor || 1.0;
            const metallic = pbr.metallicFactor || 0.0;
            
            // Calculate material brightness
            const brightness = (baseColor[0] + baseColor[1] + baseColor[2]) / 3;
            
            // Wood detection: Low metallic, medium-high roughness, brownish tones
            const isWoodish = (
                metallic < 0.1 && // Wood is non-metallic
                roughness > 0.6 && // Wood is rougher
                (baseColor[0] > baseColor[2] || baseColor[1] > baseColor[2]) // Wood tends to be warmer (more red/yellow than blue)
            );
            
            // Fabric detection: Low metallic, high roughness, varied colors
            const isFabric = (
                metallic < 0.1 && // Fabric is non-metallic
                roughness > 0.7 && // Fabric is very rough
                brightness > 0.3 && // Not too dark (unlike leather)
                !isWoodish // Not wood
            );
            
            // Metal detection: High metallic
            const isMetal = metallic > 0.8;
            
            // Leather detection: Low metallic, medium roughness, darker colors
            const isLeather = (
                metallic < 0.1 &&
                roughness > 0.5 && roughness < 0.8 &&
                brightness < 0.4 // Leather tends to be darker
            );
            
            if (isMetal) return 'metal';
            if (isWoodish) return 'wood';
            if (isFabric) return 'fabric';
            if (isLeather) return 'leather';
            
            return 'unknown';
        }
        
        function shouldColorMaterial(materialType) {
            // Only color fabric-like materials, leave wood/metal/leather unchanged
            return materialType === 'fabric';
        }

        // Image Management Functions - Moved to dedicated page
        
        function showImageUploadModal() {
            document.getElementById('imageUploadModal').style.display = 'flex';
        }
        
        function closeImageUploadModal() {
            document.getElementById('imageUploadModal').style.display = 'none';
            document.getElementById('imageUploadForm').reset();
            document.getElementById('imageFileName').style.display = 'none';
            const uploadArea = document.getElementById('imageFileUploadArea');
            uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
            uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
        }
        
        // Furniture Settings Modal Functions
        let currentSettingsModel = null;
        
        function openFurnitureSettingsModal(model) {
            currentSettingsModel = model;
            
            // Update modal title
            document.getElementById('settingsModalTitle').textContent = 
                ` Furniture Settings - ${model.title}`;
            
            // Update Product URL section
            const editUrlButton = document.getElementById('editUrlButton');
            const productUrlDesc = document.getElementById('productUrlDesc');
            if (model.product_url) {
                productUrlDesc.textContent = `Current URL: ${model.product_url}`;
                editUrlButton.textContent = 'Edit';
            } else {
                productUrlDesc.textContent = 'Add a product page URL';
                editUrlButton.textContent = 'Add';
            }

            // Update SKU section
            const editSkuButton = document.getElementById('editSkuButton');
            const skuDesc = document.getElementById('skuDesc');
            if (model.sku) {
                skuDesc.textContent = `Current SKU: ${model.sku}`;
                editSkuButton.textContent = 'Edit';
            } else {
                skuDesc.textContent = 'Auto-generated or add custom SKU';
                editSkuButton.textContent = 'Add';
            }

            // Update Category section
            const categoryDesc = document.getElementById('categoryDesc');
            const quickCategorySelect = document.getElementById('quickCategorySelect');

            // Load categories for this customer
            if (model.customer_id) {
                loadCategoriesForDropdown('quickCategorySelect', model.customer_id);
            }

            // Set current category after loading
            setTimeout(() => {
                quickCategorySelect.value = model.product_category || '';

                // Update description based on selection
                if (model.product_category) {
                    categoryDesc.textContent = `Current: ${formatCategoryName(model.product_category)}`;
                } else {
                    categoryDesc.textContent = 'No category assigned';
                }
            }, 200);

            // Add change listener
            quickCategorySelect.onchange = async function() {
                await saveQuickCategory(model.id, this.value);
            };

            // Update Assignment section
            const assignmentDesc = document.getElementById('assignmentDesc');
            const assignButtonText = document.getElementById('assignButtonText');
            if (model.customer_name) {
                assignmentDesc.textContent = `Assigned to ${model.customer_name}`;
                assignButtonText.textContent = model.customer_name;
            } else {
                assignmentDesc.textContent = 'Not assigned to any customer';
                assignButtonText.textContent = 'Assign';
            }
            
            // Update Variants section
            const manageVariantsAction = document.getElementById('manageVariantsAction');
            const variantCountDesc = document.getElementById('variantCountDesc');
            if (model.variants && model.variants.length > 0) {
                const variantCount = model.variants.length;
                variantCountDesc.textContent = `${variantCount} variant${variantCount === 1 ? '' : 's'} available`;
                manageVariantsAction.style.display = 'flex';
            } else {
                manageVariantsAction.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('furnitureSettingsModal').style.display = 'flex';
        }
        
        function closeFurnitureSettingsModal() {
            console.log(' closeFurnitureSettingsModal called!');
            console.trace(' Call stack:');
            document.getElementById('furnitureSettingsModal').style.display = 'none';
            currentSettingsModel = null;
        }

        function refreshSettingsModalDisplay() {
            if (!currentSettingsModel) {
                console.error(' refreshSettingsModalDisplay: NO currentSettingsModel!');
                return;
            }

            console.log(' Refreshing settings modal display with model:', currentSettingsModel);
            console.log(' Model SKU value:', currentSettingsModel.sku, 'Type:', typeof currentSettingsModel.sku);

            // Update SKU section
            const editSkuButton = document.getElementById('editSkuButton');
            const skuDesc = document.getElementById('skuDesc');

            console.log(' Found elements:', { editSkuButton, skuDesc });
            console.log(' Current skuDesc text:', skuDesc?.textContent);

            if (currentSettingsModel.sku) {
                const newText = `Current SKU: ${currentSettingsModel.sku}`;
                console.log(' Setting skuDesc text to:', newText);
                skuDesc.textContent = newText;
                editSkuButton.textContent = 'Edit';
                console.log(' AFTER UPDATE - skuDesc text:', skuDesc.textContent);
                console.log(' AFTER UPDATE - button text:', editSkuButton.textContent);
            } else {
                console.log(' Setting skuDesc to default text (no SKU)');
                skuDesc.textContent = 'Auto-generated or add custom SKU';
                editSkuButton.textContent = 'Add';
                console.log(' AFTER UPDATE - skuDesc text:', skuDesc.textContent);
            }

            // Also update product URL section for completeness
            const editUrlButton = document.getElementById('editUrlButton');
            const productUrlDesc = document.getElementById('productUrlDesc');
            if (currentSettingsModel.product_url) {
                productUrlDesc.textContent = `Current URL: ${currentSettingsModel.product_url}`;
                editUrlButton.textContent = 'Edit';
            } else {
                productUrlDesc.textContent = 'Add a product page URL';
                editUrlButton.textContent = 'Add';
            }
        }
        
        // Settings Modal Action Handlers
        function handleEditUrl() {
            if (!currentSettingsModel) return;
            // Store model data before closing modal
            const modelId = currentSettingsModel.id;
            const productUrl = currentSettingsModel.product_url;
            closeFurnitureSettingsModal();

            // Create a mock element with the required attributes
            const mockElement = {
                getAttribute: function(attr) {
                    if (attr === 'data-model-id') return modelId;
                    if (attr === 'data-empty') return productUrl ? 'false' : 'true';
                    if (attr === 'data-url') return productUrl || '';
                    if (attr === 'data-editing-variant') return 'false';
                    if (attr === 'data-variant-id') return null;
                    return null;
                },
                setAttribute: function(attr, value) {
                    // Mock setAttribute for the function
                },
                removeAttribute: function(attr) {
                    // Mock removeAttribute for the function
                }
            };

            // Call the existing product URL edit function
            startEditProductUrl(mockElement);
        }

        function handleEditSku() {
            if (!currentSettingsModel) return;

            const modelId = currentSettingsModel.id;
            const currentSku = currentSettingsModel.sku;

            console.log(' handleEditSku - modelId:', modelId, 'currentSku:', currentSku);

            // DON'T close settings modal - we'll refresh it after SKU update

            // Create SKU edit modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                background: rgba(13, 17, 23, 0.95);
                border: 1px solid rgba(240, 246, 252, 0.1);
                border-radius: 12px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            `;

            formContainer.innerHTML = `
                <h3 style="color: #e6edf3; margin: 0 0 16px 0; font-size: 1.1rem;">
                    ${currentSku ? 'Edit Product SKU' : 'Add Product SKU'}
                </h3>
                <p style="color: #7d8590; font-size: 12px; margin-bottom: 16px;">
                    Enter any unique identifier for this product
                </p>
                <input type="text"
                       id="skuEditInput"
                       placeholder="Enter any SKU (e.g., SOFA-001)"
                       value="${(() => {
                           console.log(' Setting input value to:', currentSku || '');
                           return currentSku || '';
                       })()}"
                       style="
                           width: 100%;
                           padding: 12px;
                           background: rgba(240, 246, 252, 0.1);
                           border: 1px solid rgba(240, 246, 252, 0.2);
                           border-radius: 8px;
                           color: #e6edf3;
                           font-size: 14px;
                           font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                           margin-bottom: 16px;
                       ">
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="cancelSkuEdit()" style="
                        padding: 8px 16px;
                        background: rgba(240, 246, 252, 0.1);
                        border: 1px solid rgba(240, 246, 252, 0.2);
                        border-radius: 6px;
                        color: #e6edf3;
                        cursor: pointer;
                    ">Cancel</button>
                    <button onclick="saveSkuEdit()" style="
                        padding: 8px 16px;
                        background: #58a6ff;
                        border: none;
                        border-radius: 6px;
                        color: white;
                        cursor: pointer;
                        font-weight: 500;
                    ">Save SKU</button>
                </div>
            `;

            modal.appendChild(formContainer);
            document.body.appendChild(modal);

            // Focus input
            const input = document.getElementById('skuEditInput');
            input.focus();
            input.select();

            // Handle Enter key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveSkuEdit();
                } else if (e.key === 'Escape') {
                    cancelSkuEdit();
                }
            });

            // Store modal reference
            window.currentSkuModal = modal;
            window.currentSkuModelId = modelId;
        }

        function cancelSkuEdit() {
            if (window.currentSkuModal) {
                document.body.removeChild(window.currentSkuModal);
                window.currentSkuModal = null;
                window.currentSkuModelId = null;
            }
        }

        async function saveSkuEdit() {
            const input = document.getElementById('skuEditInput');
            const newSku = input.value.trim().toUpperCase();
            const modelId = window.currentSkuModelId;

            if (!modelId) return;

            try {
                if (newSku && newSku.length > 100) {
                    alert('SKU is too long. Please keep it under 100 characters.');
                    input.focus();
                    return;
                }

                const response = await fetch('/api/models', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: modelId,
                        sku: newSku || null
                    })
                });

                if (response.ok) {
                    console.log(' SKU updated successfully');

                    // Show success message
                    alert(`SKU ${newSku ? `updated to: ${newSku}` : 'removed'} successfully!`);

                    // DIRECT FIX: Update the settings modal display immediately
                    const skuDesc = document.getElementById('skuDesc');
                    const editSkuButton = document.getElementById('editSkuButton');
                    if (skuDesc && editSkuButton) {
                        if (newSku) {
                            skuDesc.textContent = `Current SKU: ${newSku}`;
                            editSkuButton.textContent = 'Edit';
                        } else {
                            skuDesc.textContent = 'Auto-generated or add custom SKU';
                            editSkuButton.textContent = 'Add';
                        }
                    }

                    // Update the model in currentModelsData
                    if (window.currentModelsData) {
                        const model = window.currentModelsData.find(m => m.id === modelId);
                        if (model) {
                            console.log(' BEFORE UPDATE - model.sku:', model.sku);
                            model.sku = newSku;
                            console.log(' AFTER UPDATE - model.sku:', model.sku);
                            console.log(' Updated model data:', model);
                        } else {
                            console.error(' Model not found in currentModelsData:', modelId);
                        }
                    } else {
                        console.error(' currentModelsData not available');
                    }

                    // Refresh the models display
                    console.log(' Calling loadModels() to refresh...');
                    await loadModels();
                    console.log(' loadModels() completed');

                    // Update currentSettingsModel and refresh settings modal display
                    if (window.currentModelsData) {
                        const updatedModel = window.currentModelsData.find(m => m.id === modelId);
                        if (updatedModel) {
                            console.log(' Updating currentSettingsModel with fresh SKU data:', updatedModel.sku);

                            // Update the global reference
                            if (window.currentSettingsModel && window.currentSettingsModel.id === modelId) {
                                window.currentSettingsModel = updatedModel;

                                // Refresh settings modal display if it's open
                                const settingsModal = document.getElementById('furnitureSettingsModal');
                                console.log(' Settings modal state:', {
                                    exists: !!settingsModal,
                                    display: settingsModal?.style.display,
                                    isVisible: settingsModal?.style.display === 'flex'
                                });

                                if (settingsModal && settingsModal.style.display === 'flex') {
                                    console.log(' Settings modal is open - calling refreshSettingsModalDisplay...');
                                    refreshSettingsModalDisplay();
                                } else {
                                    console.log(' Settings modal is NOT open - not refreshing');
                                }
                            }
                        }
                    }

                    cancelSkuEdit();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to update SKU: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating SKU:', error);
                alert(`Failed to update SKU: ${error.message}`);
            }
        }

        function handleCopyLink() {
            if (!currentSettingsModel) return;
            const viewUrl = generateSEOUrl(currentSettingsModel);
            copyToClipboard(viewUrl, document.getElementById('copyLinkButton'));
        }

        // SKU editing functions for variants
        function editProductSku(modelId) {
            // Find the model data
            const model = window.currentModelsData?.find(m => m.id === modelId);
            if (!model) {
                alert('Model not found');
                return;
            }

            // Close current modal
            if (document.querySelector('.variant-management-modal')) {
                document.querySelector('.variant-management-modal').remove();
            }

            // Use the existing SKU edit function but with model data
            const currentSku = model.sku;
            console.log(' editProductSku - modelId:', modelId, 'currentSku:', currentSku);
            createSkuEditModal(modelId, currentSku, 'product');
        }

        function editVariantSku(variantId) {
            // Find the variant data
            let variant = null;
            let parentModel = null;

            for (const model of window.currentModelsData || []) {
                const foundVariant = model.variants?.find(v => v.id === variantId);
                if (foundVariant) {
                    variant = foundVariant;
                    parentModel = model;
                    break;
                }
            }

            if (!variant) {
                alert('Variant not found');
                return;
            }

            // Close current modal
            if (document.querySelector('.variant-management-modal')) {
                document.querySelector('.variant-management-modal').remove();
            }

            // Create variant SKU edit modal
            const currentSku = variant.sku;
            console.log(' editVariantSku - variantId:', variantId, 'currentSku:', currentSku);
            createSkuEditModal(variantId, currentSku, 'variant', parentModel.sku);
        }

        function createSkuEditModal(itemId, currentSku, type, parentSku = null) {
            // Create SKU edit modal
            console.log(' createSkuEditModal - itemId:', itemId, 'currentSku:', currentSku, 'type:', type);
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                background: rgba(13, 17, 23, 0.95);
                border: 1px solid rgba(240, 246, 252, 0.1);
                border-radius: 12px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            `;

            const isProduct = type === 'product';
            const title = isProduct ? 'Edit Product SKU' : 'Edit Variant SKU';
            const formatExample = isProduct ? 'SOFA-001' : 'SOFA-001-RED';
            const formatDescription = isProduct
                ? 'Enter any unique identifier for this product'
                : 'Enter any unique identifier for this variant';

            formContainer.innerHTML = `
                <h3 style="color: #e6edf3; margin: 0 0 16px 0; font-size: 1.1rem;">
                    ${currentSku ? title : title.replace('Edit', 'Add')}
                </h3>
                <p style="color: #7d8590; font-size: 12px; margin-bottom: 16px;">
                    ${formatDescription}
                </p>
                <input type="text"
                       id="skuEditInput"
                       placeholder="Enter any SKU (e.g., ${formatExample})"
                       value="${(() => {
                           console.log(' Setting input value to:', currentSku || '');
                           return currentSku || '';
                       })()}"
                       style="
                           width: 100%;
                           padding: 12px;
                           background: rgba(240, 246, 252, 0.1);
                           border: 1px solid rgba(240, 246, 252, 0.2);
                           border-radius: 8px;
                           color: #e6edf3;
                           font-size: 14px;
                           font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                           margin-bottom: 16px;
                       ">
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="cancelSkuEdit()" style="
                        padding: 8px 16px;
                        background: rgba(240, 246, 252, 0.1);
                        border: 1px solid rgba(240, 246, 252, 0.2);
                        border-radius: 6px;
                        color: #e6edf3;
                        cursor: pointer;
                    ">Cancel</button>
                    <button onclick="saveItemSkuEdit('${itemId}', '${type}')" style="
                        padding: 8px 16px;
                        background: #58a6ff;
                        border: none;
                        border-radius: 6px;
                        color: white;
                        cursor: pointer;
                        font-weight: 500;
                    ">Save SKU</button>
                </div>
            `;

            modal.appendChild(formContainer);
            document.body.appendChild(modal);

            // Focus input
            const input = document.getElementById('skuEditInput');
            input.focus();
            input.select();

            // Handle Enter key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveItemSkuEdit(itemId, type);
                } else if (e.key === 'Escape') {
                    cancelSkuEdit();
                }
            });

            // Store modal reference
            window.currentSkuModal = modal;
        }

        async function saveItemSkuEdit(itemId, type) {
            const input = document.getElementById('skuEditInput');
            const newSku = input.value.trim().toUpperCase();

            if (!itemId) return;

            try {
                // Basic validation - just check for reasonable length and no special characters that could break URLs
                if (newSku && newSku.length > 100) {
                    alert('SKU is too long. Please keep it under 100 characters.');
                    input.focus();
                    return;
                }

                // Use the same endpoints as URL editing
                console.log(' SKU UPDATE DEBUG:', { itemId, type, newSku });
                const endpoint = type === 'product' ? '/api/models' : '/api/variants';
                console.log(' Using endpoint:', endpoint);
                const requestBody = type === 'product'
                    ? { id: itemId, sku: newSku || null }
                    : { id: itemId, sku: newSku || null };
                console.log(' Request body:', requestBody);

                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    console.log(` ${type} SKU updated successfully`);

                    // Show success message
                    alert(`${type === 'product' ? 'Product' : 'Variant'} SKU ${newSku ? `updated to: ${newSku}` : 'removed'} successfully!`);

                    // Update the data in currentModelsData
                    if (window.currentModelsData) {
                        if (type === 'product') {
                            const model = window.currentModelsData.find(m => m.id === itemId);
                            if (model) {
                                model.sku = newSku;
                                console.log(' Updated model data:', model);
                            }
                        } else {
                            // Update variant
                            for (const model of window.currentModelsData) {
                                const variant = model.variants?.find(v => v.id === itemId);
                                if (variant) {
                                    variant.sku = newSku;
                                    console.log(' Updated variant data:', variant);
                                    break;
                                }
                            }
                        }
                    }

                    // Refresh the models display
                    await loadModels();

                    cancelSkuEdit();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to update SKU: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating SKU:', error);
                alert(`Failed to update SKU: ${error.message}`);
            }
        }
        
        function handleAssignCustomer() {
            if (!currentSettingsModel) return;
            // Store model data before closing modal
            const modelTitle = currentSettingsModel.title;
            closeFurnitureSettingsModal();

            // Create a modal-style customer selection UI
            const assignModal = document.createElement('div');
            assignModal.className = 'password-modal';
            assignModal.style.display = 'flex';
            assignModal.innerHTML = `
                <div class="modal-content futuristic-upload" style="max-width: 400px;">
                    <div class="upload-header">
                        <h3 class="upload-title"> Assign to Customer</h3>
                        <p class="upload-subtitle">Select customer for "${modelTitle}"</p>
                    </div>

                    <div id="customerSelectionList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Customer options will be populated here -->
                    </div>

                    <div class="modal-buttons" style="margin-top: 20px;">
                        <button type="button" class="modal-button secondary" onclick="closeAssignModal()">Cancel</button>
                        <button type="button" class="modal-button primary" onclick="assignToNewCustomerFromModal()">Add New Customer</button>
                    </div>
                </div>
            `;

            document.body.appendChild(assignModal);

            // Populate customer list
            const customerList = assignModal.querySelector('#customerSelectionList');
            const customers = customerManager.getAllCustomers();

            if (customers.length === 0) {
                customerList.innerHTML = '<div style="color: #7d8590; text-align: center; padding: 20px;">No customers available</div>';
            } else {
                customers.forEach(customer => {
                    const isSelected = currentSettingsModel.customer_id === customer.id;
                    const customerOption = document.createElement('div');
                    customerOption.className = 'customer-option';
                    customerOption.style.cssText = `
                        padding: 12px 16px;
                        border: 1px solid ${isSelected ? '#58a6ff' : 'rgba(240, 246, 252, 0.1)'};
                        border-radius: 8px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        background: ${isSelected ? 'rgba(88, 166, 255, 0.1)' : 'rgba(240, 246, 252, 0.05)'};
                        transition: all 0.2s ease;
                    `;
                    customerOption.innerHTML = `
                        <div style="font-weight: 500; color: #e6edf3; margin-bottom: 4px;">${customer.name}</div>
                        <div style="font-size: 12px; color: #7d8590;">ID: ${customer.id}</div>
                        ${isSelected ? '<div style="color: #58a6ff; font-size: 12px; margin-top: 4px;"> Currently assigned</div>' : ''}
                    `;

                    customerOption.addEventListener('click', () => window.assignCustomerFromModal(customer.id, customer.name));
                    customerList.appendChild(customerOption);
                });
            }

            // Add global functions for modal actions
            window.closeAssignModal = function() {
                assignModal.remove();
                delete window.closeAssignModal;
                delete window.assignToNewCustomerFromModal;
                delete window.assignCustomerFromModal;
            };

            window.assignToNewCustomerFromModal = function() {
                const customerName = prompt('Enter new customer name:');
                if (!customerName?.trim()) return;

                const customerId = customerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');

                // Check if already exists
                if (customerManager.hasCustomer(customerId)) {
                    alert('Customer already exists!');
                    return;
                }

                // Add to customer manager
                customerManager.addCustomer(customerId, customerName);
                window.closeAssignModal();
                assignFurnitureToCustomer(currentSettingsModel.id, customerId, customerName);
            };

            window.assignCustomerFromModal = function(customerId, customerName) {
                window.closeAssignModal();
                assignFurnitureToCustomer(currentSettingsModel.id, customerId, customerName);
            };
        }

        // Simple dropdown toggle for customer assignment (new implementation)
        function toggleCustomerDropdown() {
            if (!currentSettingsModel) return;

            const dropdown = document.getElementById('customerDropdown');
            const isVisible = dropdown.style.display !== 'none';

            if (isVisible) {
                dropdown.style.display = 'none';
                return;
            }

            // Populate dropdown with customers
            populateCustomerDropdown();
            dropdown.style.display = 'block';

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeDropdownOnOutsideClick);
            }, 0);
        }

        function populateCustomerDropdown() {
            const dropdown = document.getElementById('customerDropdown');
            const customers = customerManager.getAllCustomers();

            let dropdownHTML = '';

            // Add "Unassigned" option
            const isUnassigned = !currentSettingsModel.customer_id || currentSettingsModel.customer_id === 'unassigned';
            dropdownHTML += `
                <div class="dropdown-option" onclick="assignModelToCustomer('${currentSettingsModel.id}', 'unassigned', 'Unassigned'); document.getElementById('customerDropdown').style.display='none';" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(240, 246, 252, 0.1); ${isUnassigned ? 'background: rgba(88, 166, 255, 0.1); color: #58a6ff;' : ''}" onmouseover="this.style.background='rgba(240, 246, 252, 0.05)'" onmouseout="this.style.background='${isUnassigned ? 'rgba(88, 166, 255, 0.1)' : 'transparent'}'">
                    <div style="font-weight: 500;">Unassigned</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">No customer assigned</div>
                </div>
            `;

            // Add customer options
            customers.forEach(customer => {
                const isSelected = currentSettingsModel.customer_id === customer.id;
                dropdownHTML += `
                    <div class="dropdown-option" onclick="assignModelToCustomer('${currentSettingsModel.id}', '${customer.id}', '${customer.name}'); document.getElementById('customerDropdown').style.display='none';" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(240, 246, 252, 0.1); ${isSelected ? 'background: rgba(88, 166, 255, 0.1); color: #58a6ff;' : ''}" onmouseover="this.style.background='rgba(240, 246, 252, 0.05)'" onmouseout="this.style.background='${isSelected ? 'rgba(88, 166, 255, 0.1)' : 'transparent'}'">
                        <div style="font-weight: 500;">${customer.name}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">${customer.id}</div>
                    </div>
                `;
            });

            dropdown.innerHTML = dropdownHTML;
        }

        function closeDropdownOnOutsideClick(event) {
            const dropdown = document.getElementById('customerDropdown');
            const button = document.getElementById('assignButton');

            if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdownOnOutsideClick);
            }
        }

        async function assignModelToCustomer(modelId, customerId, customerName) {
            try {
                // Update the assign button text to show assignment status
                const assignButton = document.getElementById('assignButtonText');
                assignButton.textContent = 'Assigning...';

                // Make API call to assign customer using model-specific endpoint
                const response = await fetch(`/api/model/${modelId}/assign`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customerId: customerId === 'unassigned' ? null : customerId,
                        customerName: customerId === 'unassigned' ? null : customerName
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to assign customer: ${response.status}`);
                }

                // Show success message briefly
                assignButton.textContent = ' Assigned';
                setTimeout(() => {
                    assignButton.textContent = customerId === 'unassigned' ? 'Assign' : customerName;
                }, 1500);

                // Refresh data to ensure consistency - this will update the main model cards
                loadModels();
                loadCustomers();

            } catch (error) {
                console.error('Error assigning customer:', error);

                // Show error state
                const assignButton = document.getElementById('assignButtonText');
                assignButton.textContent = ' Error';
                setTimeout(() => {
                    assignButton.textContent = 'Assign';
                }, 2000);
            }
        }

        function handleAddVariant() {
            if (!currentSettingsModel) return;
            // Store model data before closing modal (which sets currentSettingsModel to null)
            const modelId = currentSettingsModel.id;
            const modelTitle = currentSettingsModel.title;
            closeFurnitureSettingsModal();
            openVariantModal(modelId, modelTitle);
        }
        
        function handleManageVariants() {
            if (!currentSettingsModel) return;
            // Store ALL model data before closing modal (which sets currentSettingsModel to null)
            const modelData = {
                id: currentSettingsModel.id,
                title: currentSettingsModel.title,
                dominant_color: currentSettingsModel.dominant_color,
                cloudinary_url: currentSettingsModel.cloudinary_url,
                aws_url: currentSettingsModel.aws_url,
                variants: currentSettingsModel.variants || []
            };
            closeFurnitureSettingsModal();

            // Create variant management modal
            const variantModal = document.createElement('div');
            variantModal.className = 'password-modal';
            variantModal.style.display = 'flex';
            variantModal.innerHTML = `
                <div class="modal-content futuristic-upload" style="max-width: 600px;">
                    <div class="upload-header">
                        <h3 class="upload-title"> Manage Variants</h3>
                        <p class="upload-subtitle">Manage color and texture variants for "${modelData.title}"</p>
                    </div>

                    <div class="variants-management-section">
                        <!-- Original/Main Variant -->
                        <div class="variant-item" style="padding: 16px; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 8px; margin-bottom: 12px; background: rgba(240, 246, 252, 0.05);">
                            <!-- Single line with all info -->
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                                <div style="font-weight: 500; color: #e6edf3;">Original</div>
                                <div style="font-size: 12px; color: #7d8590;">Main model color</div>
                                ${modelData.sku ?
                                    `<div style="
                                        font-size: 13px;
                                        color: #58a6ff;
                                        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                                        background: rgba(88, 166, 255, 0.1);
                                        padding: 4px 8px;
                                        border-radius: 4px;
                                    ">SKU: ${modelData.sku}</div>` :
                                    `<div style="
                                        font-size: 12px;
                                        color: #7d8590;
                                        font-style: italic;
                                    ">No SKU assigned</div>`
                                }
                                ${modelData.product_url ? `<div style="font-size: 11px; color: #58a6ff;"> Has product URL</div>` : ''}
                            </div>

                            <!-- Color Circle and Action Buttons -->
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="variant-circle"
                                     style="width: 40px; height: 40px; border-radius: 50%; background: ${modelData.dominant_color || '#6b7280'}; border: 2px solid rgba(240, 246, 252, 0.2); flex-shrink: 0;">
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;">
                                    <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="switchToVariantFromModal('${modelData.id}', 'original', '${modelData.aws_url || modelData.cloudinary_url}')">
                                         View
                                    </button>
                                    <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editOriginalVariantColor('${modelData.id}', '${modelData.dominant_color || '#6b7280'}', this)">
                                         Edit Color
                                    </button>
                                    <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editProductSku('${modelData.id}')">
                                         Edit SKU
                                    </button>
                                    <button class="modal-button danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVariantFromModal('${modelData.id}-original', '${modelData.id}')">
                                         Delete
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Variants -->
                        <div id="additionalVariants">
                            <!-- Variants will be populated here -->
                        </div>
                    </div>

                    <div class="modal-buttons" style="margin-top: 20px;">
                        <button type="button" class="modal-button secondary" onclick="closeVariantManagementModal()">Close</button>
                        <button type="button" class="modal-button primary" onclick="addNewVariantFromModal()">+ Add Variant</button>
                    </div>
                </div>
            `;

            document.body.appendChild(variantModal);

            // Populate additional variants
            const additionalVariantsContainer = variantModal.querySelector('#additionalVariants');
            if (modelData.variants && modelData.variants.length > 0) {
                modelData.variants.forEach(variant => {
                    const variantItem = document.createElement('div');
                    variantItem.className = 'variant-item';
                    variantItem.style.cssText = `
                        padding: 16px;
                        border: 1px solid rgba(240, 246, 252, 0.1);
                        border-radius: 8px;
                        margin-bottom: 12px;
                        background: rgba(240, 246, 252, 0.05);
                    `;
                    variantItem.innerHTML = `
                        <!-- Single line with all info -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                            <div style="font-weight: 500; color: #e6edf3;">${variant.variant_name}</div>
                            <div style="font-size: 12px; color: #7d8590;">${variant.variant_type || 'upload'} variant</div>
                            ${variant.sku ?
                                `<div style="
                                    font-size: 13px;
                                    color: #58a6ff;
                                    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                                    background: rgba(88, 166, 255, 0.1);
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                ">SKU: ${variant.sku}</div>` :
                                `<div style="
                                    font-size: 12px;
                                    color: #7d8590;
                                    font-style: italic;
                                ">No SKU assigned</div>`
                            }
                            ${variant.product_url ? `<div style="font-size: 11px; color: #58a6ff;"> Has product URL</div>` : ''}
                        </div>

                        <!-- Color Circle and Action Buttons -->
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="variant-circle"
                                 style="width: 40px; height: 40px; border-radius: 50%; background: ${variant.hex_color}; border: 2px solid rgba(240, 246, 252, 0.2); flex-shrink: 0;">
                                ${variant.is_primary ? '' : ''}
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;">
                                <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="switchToVariantFromModal('${modelData.id}', '${variant.id}', '${variant.aws_url || variant.cloudinary_url}', '${variant.hex_color}', '${variant.variant_type || 'upload'}')">
                                     View
                                </button>
                                <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editVariantColor('${variant.id}', '${variant.hex_color}', this)">
                                     Edit Color
                                </button>
                                <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editVariantSku('${variant.id}')">
                                     Edit SKU
                                </button>
                                <button class="modal-button danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVariantFromModal('${variant.id}', '${modelData.id}')">
                                     Delete
                                </button>
                            </div>
                        </div>
                    `;
                    additionalVariantsContainer.appendChild(variantItem);
                });
            } else {
                additionalVariantsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7d8590;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No variants yet</div>
                        <div style="font-size: 14px;">Add color or texture variants to give customers more options</div>
                    </div>
                `;
            }

            // Add global functions for modal actions
            window.closeVariantManagementModal = function() {
                variantModal.remove();
                delete window.closeVariantManagementModal;
                delete window.addNewVariantFromModal;
                delete window.switchToVariantFromModal;
                delete window.deleteVariantFromModal;
            };

            window.addNewVariantFromModal = function() {
                window.closeVariantManagementModal();
                openVariantModal(modelData.id, modelData.title);
            };

            window.switchToVariantFromModal = function(modelId, variantId, cloudinaryUrl, hexColor, variantType) {
                window.closeVariantManagementModal();
                switchToVariant(modelId, variantId, cloudinaryUrl, hexColor, variantType);
            };

            window.deleteVariantFromModal = function(variantId, modelId) {
                if (confirm('Are you sure you want to delete this variant?')) {
                    // Create a mock event object
                    const mockEvent = {
                        stopPropagation: function() {}
                    };
                    deleteVariant(variantId, modelId, mockEvent);
                    window.closeVariantManagementModal();
                }
            };

            // Color editing function for variants
            window.editVariantColor = function(variantId, currentColor, buttonElement) {
                // Check if already editing this variant
                if (buttonElement.dataset.editing === 'true') {
                    return;
                }

                // Create inline color picker
                const colorPicker = document.createElement('input');
                colorPicker.type = 'color';
                colorPicker.value = currentColor;
                colorPicker.style.cssText = `
                    width: 30px;
                    height: 30px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 0 8px;
                `;

                // Create save button
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save';
                saveBtn.className = 'modal-button primary';
                saveBtn.style.cssText = 'padding: 6px 12px; font-size: 12px; margin-left: 8px;';

                // Store original button content
                const originalContent = buttonElement.innerHTML;
                buttonElement.dataset.editing = 'true';

                // Replace button content with color picker and save button
                buttonElement.innerHTML = '';
                buttonElement.appendChild(colorPicker);
                buttonElement.appendChild(saveBtn);

                // Live preview of color changes
                const variantCircle = buttonElement.closest('.variant-item').querySelector('.variant-circle');
                const originalCircleColor = variantCircle.style.background;

                colorPicker.addEventListener('input', function() {
                    variantCircle.style.background = this.value;
                });

                // Save color
                saveBtn.onclick = async function() {
                    const newColor = colorPicker.value;
                    console.log(' Saving new color for variant:', variantId, newColor);

                    try {
                        const response = await fetch('/api/a3', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                variantId: variantId,
                                hexColor: newColor
                            })
                        });

                        if (response.ok) {
                            console.log(' Color updated successfully');
                            // Update UI permanently
                            variantCircle.style.background = newColor;

                            // Update any corresponding variant circles in the main view
                            const mainVariantCircles = document.querySelectorAll('.variant-circle');
                            mainVariantCircles.forEach(circle => {
                                const onclick = circle.getAttribute('onclick');
                                if (onclick && onclick.includes(variantId)) {
                                    circle.style.backgroundColor = newColor;
                                }
                            });

                            // Restore button
                            buttonElement.innerHTML = originalContent;
                            buttonElement.dataset.editing = 'false';
                        } else {
                            throw new Error('Failed to update color');
                        }
                    } catch (error) {
                        console.error(' Error updating color:', error);
                        alert('Failed to update color. Please try again.');
                        // Restore original color on error
                        variantCircle.style.background = originalCircleColor;
                        // Restore button on error
                        buttonElement.innerHTML = originalContent;
                        buttonElement.dataset.editing = 'false';
                    }
                };
            };

            // Original variant color editing in manage modal
            window.editOriginalVariantColor = function(modelId, currentColor, buttonElement) {
                // Check if already editing this variant
                if (buttonElement.dataset.editing === 'true') {
                    return;
                }

                // Create inline color picker (similar to variant editing)
                const colorPicker = document.createElement('input');
                colorPicker.type = 'color';
                colorPicker.value = currentColor;
                colorPicker.style.cssText = `
                    width: 30px;
                    height: 30px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 0 8px;
                `;

                // Create save button
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save';
                saveBtn.className = 'modal-button primary';
                saveBtn.style.cssText = 'padding: 6px 12px; font-size: 12px; margin-left: 8px;';

                // Store original button content
                const originalContent = buttonElement.innerHTML;
                buttonElement.dataset.editing = 'true';

                // Replace button content with color picker and save button
                buttonElement.innerHTML = '';
                buttonElement.appendChild(colorPicker);
                buttonElement.appendChild(saveBtn);

                // Live preview of color changes
                const variantCircle = buttonElement.closest('.variant-item').querySelector('.variant-circle');
                const originalCircleColor = variantCircle.style.background;

                colorPicker.addEventListener('input', function() {
                    variantCircle.style.background = this.value;
                });

                // Save color
                saveBtn.onclick = async function() {
                    const newColor = colorPicker.value;
                    console.log(' Saving new color for original model:', modelId, newColor);

                    try {
                        // Update original model color (different endpoint than variants)
                        const response = await fetch('/api/a3', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                modelId: modelId, // For original, we send modelId instead of variantId
                                hexColor: newColor,
                                isOriginal: true
                            })
                        });

                        if (response.ok) {
                            console.log(' Original model color updated successfully');
                            // Update UI permanently
                            variantCircle.style.background = newColor;

                            // Update original variant circles in the main view
                            const originalVariantCircles = document.querySelectorAll('.original-variant');
                            originalVariantCircles.forEach(circle => {
                                const modelIdFromClick = circle.getAttribute('data-model-id');
                                if (modelIdFromClick === modelId) {
                                    circle.style.background = newColor;
                                }
                            });

                            // Restore button
                            buttonElement.innerHTML = originalContent;
                            buttonElement.dataset.editing = 'false';
                        } else {
                            throw new Error('Failed to update original color');
                        }
                    } catch (error) {
                        console.error(' Error updating original color:', error);
                        alert('Failed to update color. Please try again.');
                        // Restore original color on error
                        variantCircle.style.background = originalCircleColor;
                        // Restore button on error
                        buttonElement.innerHTML = originalContent;
                        buttonElement.dataset.editing = 'false';
                    }
                };
            };

            // Inline color editing for variants in main view
            window.editVariantColorInline = function(variantId, currentColor, event) {
                // Stop event propagation to prevent variant switching
                event.stopPropagation();

                // Check if a color picker is already open
                if (document.querySelector('.inline-color-picker')) {
                    return;
                }

                // Find the variant element (circle or button)
                const editButton = event.target;
                const variantWrapper = editButton.closest('.variant-wrapper');
                const variantElement = variantWrapper.querySelector('.variant-circle') || variantWrapper.querySelector('.variant-button');

                // Create color picker popup
                const colorPicker = document.createElement('div');
                colorPicker.className = 'inline-color-picker';
                colorPicker.style.cssText = `
                    position: absolute;
                    top: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(13, 17, 23, 0.95);
                    border: 1px solid rgba(88, 166, 255, 0.3);
                    border-radius: 8px;
                    padding: 12px;
                    z-index: 1000;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    backdrop-filter: blur(10px);
                `;

                // Color input
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = currentColor;
                colorInput.style.cssText = `
                    width: 50px;
                    height: 30px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                `;

                // Buttons container
                const buttonsContainer = document.createElement('div');
                buttonsContainer.style.cssText = 'display: flex; gap: 6px; margin-top: 4px;';

                // Save button
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save';
                saveBtn.style.cssText = `
                    background: rgba(46, 160, 67, 0.9);
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 6px 12px;
                    cursor: pointer;
                    font-size: 12px;
                    margin-top: 8px;
                `;

                colorPicker.appendChild(colorInput);
                colorPicker.appendChild(saveBtn);

                // Add to variant wrapper
                variantWrapper.style.position = 'relative';
                variantWrapper.appendChild(colorPicker);

                // Store original color for cancel
                const isButton = variantElement.classList.contains('variant-button');
                const originalColor = isButton ?
                    variantElement.style.borderLeftColor :
                    variantElement.style.backgroundColor;

                // Live preview
                colorInput.addEventListener('input', function() {
                    if (isButton) {
                        variantElement.style.borderLeftColor = this.value;
                    } else {
                        variantElement.style.backgroundColor = this.value;
                    }
                });

                // Save color
                saveBtn.onclick = async function() {
                    const newColor = colorInput.value;
                    console.log(' Saving new color for variant:', variantId, newColor);

                    try {
                        const response = await fetch('/api/a3', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                variantId: variantId,
                                hexColor: newColor
                            })
                        });

                        if (response.ok) {
                            console.log(' Color updated successfully');
                            // Update all instances of this variant across the UI
                            const allVariantCircles = document.querySelectorAll('.variant-circle');
                            const allVariantButtons = document.querySelectorAll('.variant-button');

                            allVariantCircles.forEach(circle => {
                                const onclick = circle.getAttribute('onclick');
                                if (onclick && onclick.includes(variantId)) {
                                    circle.style.backgroundColor = newColor;
                                }
                            });

                            allVariantButtons.forEach(button => {
                                const onclick = button.getAttribute('onclick');
                                if (onclick && onclick.includes(variantId)) {
                                    button.style.borderLeftColor = newColor;
                                }
                            });

                            // Remove color picker
                            colorPicker.remove();
                        } else {
                            throw new Error('Failed to update color');
                        }
                    } catch (error) {
                        console.error(' Error updating color:', error);
                        alert('Failed to update color. Please try again.');
                        // Restore original color
                        if (isButton) {
                            variantElement.style.borderLeftColor = originalColor;
                        } else {
                            variantElement.style.backgroundColor = originalColor;
                        }
                        colorPicker.remove();
                    }
                };

                // Close on click outside (restore original color)
                setTimeout(() => {
                    document.addEventListener('click', function closeColorPicker(e) {
                        if (!colorPicker.contains(e.target) && e.target !== editButton) {
                            if (isButton) {
                                variantElement.style.borderLeftColor = originalColor;
                            } else {
                                variantElement.style.backgroundColor = originalColor;
                            }
                            colorPicker.remove();
                            document.removeEventListener('click', closeColorPicker);
                        }
                    });
                }, 100);
            };
        }

        function handleDeleteFurniture() {
            if (!currentSettingsModel) return;
            // Store model data before closing modal (which sets currentSettingsModel to null)
            const modelId = currentSettingsModel.id;
            const cloudinaryPublicId = currentSettingsModel.cloudinary_public_id;
            closeFurnitureSettingsModal();
            deleteModel(modelId, cloudinaryPublicId);
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const settingsModal = document.getElementById('furnitureSettingsModal');
            if (event.target === settingsModal) {
                closeFurnitureSettingsModal();
            }
        });
        
        async function updateImageFileName() {
            const fileInput = document.getElementById('imageFile');
            const fileName = document.getElementById('imageFileName');
            const uploadArea = document.getElementById('imageFileUploadArea');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.style.display = 'block';
                
                // Validate file type
                if (!file.name.match(/\.(jpg|jpeg|png|webp|svg)$/i)) {
                    fileName.textContent = ' Invalid file type';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                    return;
                } else if (file.size > 10 * 1024 * 1024) {
                    fileName.textContent = ' File too large (max 10MB)';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                    return;
                } else {
                    fileName.textContent = ` Uploading ${file.name}...`;
                    fileName.style.background = 'rgba(88, 166, 255, 0.1)';
                    fileName.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                    fileName.style.color = '#58a6ff';
                }
                
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.6)';
                uploadArea.style.background = 'rgba(88, 166, 255, 0.05)';
                
                // Auto-upload the file
                await uploadImageFile();
            } else {
                fileName.style.display = 'none';
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
            }
        }
        
        async function uploadImageFile() {
            const fileInput = document.getElementById('imageFile');
            const imageType = document.getElementById('imageType').value;
            const fileName = document.getElementById('imageFileName');
            
            if (!fileInput.files.length) return;
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('imageType', imageType);
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    fileName.textContent = ` Uploaded successfully!`;
                    setTimeout(() => {
                        closeImageUploadModal();
                        loadImages();
                    }, 1500);
                } else {
                    fileName.textContent = ` Upload couldn't complete. Please try again.`;
                    fileName.style.color = '#f85149';
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                fileName.textContent = ` Upload error: ${error.message}`;
                fileName.style.color = '#f85149';
            }
        }
        
        // Old image functions removed - now handled by dedicated Images page
        
        // Prevent form submission since we're auto-uploading
        document.getElementById('imageUploadForm').addEventListener('submit', (e) => {
            e.preventDefault();
        });
        
        // Switch to variant function (handles both upload and color variants)
        function switchToVariant(modelId, variantId, variantUrl, hexColor = null, variantType = 'upload') {
            console.log('Switching to variant:', { modelId, variantId, variantUrl, hexColor, variantType });
            
            // Find the model-viewer element for this model
            const modelCards = document.querySelectorAll('.model-card');
            modelCards.forEach(card => {
                const modelViewer = card.querySelector('model-viewer');
                const hiddenModelId = card.querySelector('.model-id');
                
                if (hiddenModelId && hiddenModelId.textContent === modelId) {
                    // All variants are GLB file variants now - no color changing
                    console.log('Loading GLB variant:', variantUrl);
                    modelViewer.src = variantUrl;
                    
                    // Update the copy link URL to include variant parameter
                    updateCopyLinkUrl(card, modelId, variantId);
                    
                    // Update the main product URL button state based on selected variant
                    updateProductUrlButton(card, modelId, variantId);
                }
            });
        }
        
        function updateProductUrlButton(card, modelId, variantId) {
            const productUrlButton = card.querySelector('.product-url-action');
            if (!productUrlButton) return;
            
            // Get the current models data to find the variant info
            const modelsData = window.currentModelsData || [];
            const model = modelsData.find(m => m.id === modelId);
            if (!model) return;
            
            if (variantId === 'original') {
                // Switching to original - use model's product_url
                if (model.product_url) {
                    productUrlButton.innerHTML = ' Edit URL';
                    productUrlButton.removeAttribute('data-empty');
                } else {
                    productUrlButton.innerHTML = ' Add URL';
                    productUrlButton.setAttribute('data-empty', 'true');
                }
                // Clear variant attributes when switching back to original
                productUrlButton.removeAttribute('data-variant-id');
                productUrlButton.removeAttribute('data-editing-variant');
            } else {
                // Switching to a variant - find the variant's product_url
                const variant = model.variants?.find(v => v.id === variantId);
                if (variant) {
                    if (variant.product_url) {
                        productUrlButton.innerHTML = ' Edit Variant URL';
                        productUrlButton.removeAttribute('data-empty');
                        // Store variant info for editing
                        productUrlButton.setAttribute('data-variant-id', variantId);
                        productUrlButton.setAttribute('data-editing-variant', 'true');
                    } else {
                        productUrlButton.innerHTML = ' Add Variant URL';
                        productUrlButton.setAttribute('data-empty', 'true');
                        productUrlButton.setAttribute('data-variant-id', variantId);
                        productUrlButton.setAttribute('data-editing-variant', 'true');
                    }
                } else {
                    // Fallback to model URL if variant not found
                    if (model.product_url) {
                        productUrlButton.innerHTML = ' Edit URL';
                        productUrlButton.removeAttribute('data-empty');
                    } else {
                        productUrlButton.innerHTML = ' Add URL';
                        productUrlButton.setAttribute('data-empty', 'true');
                    }
                    productUrlButton.removeAttribute('data-variant-id');
                    productUrlButton.removeAttribute('data-editing-variant');
                }
            }
        }
        
        function updateCopyLinkUrl(card, modelId, variantId) {
            const copyButton = card.querySelector('button[onclick*="copyToClipboard"]');
            if (copyButton) {
                // Find the model object from the global models data
                const model = findModelById(modelId);
                let newUrl;

                if (model && model.customer_slug && model.url_slug) {
                    // Use SEO URL with variant support
                    if (variantId === 'original') {
                        newUrl = generateSEOUrl(model);
                    } else {
                        // Find variant name for SEO URL
                        const variant = model.variants?.find(v => v.id === variantId);
                        const variantName = variant ? variant.variant_name : null;
                        newUrl = generateSEOUrl(model, variantId, variantName);
                    }
                } else {
                    // Fallback to old URL format if model lacks SEO data
                    console.warn(' Model missing SEO data, using fallback URLs for:', modelId);
                    if (variantId === 'original') {
                        newUrl = `https://newfurniture.live/view?id=${modelId}`;
                    } else {
                        newUrl = `https://newfurniture.live/view?id=${modelId}&variant=${variantId}`;
                    }
                }

                // Update the onclick attribute with the new URL
                copyButton.setAttribute('onclick', `copyToClipboard('${newUrl}', this)`);
                console.log(' Updated copy link URL to SEO format:', newUrl);
            }
        }

        /**
         * Helper function to find model by ID from loaded data
         */
        function findModelById(modelId) {
            // Search through the globally stored models data
            if (window.currentModelsData) {
                return window.currentModelsData.find(model => model.id === modelId);
            }
            return null;
        }
        
        // Update original variant colors ONLY for models without saved colors
        function updateOriginalVariantColors() {
            const modelCards = document.querySelectorAll('.model-card');
            modelCards.forEach(card => {
                const modelViewer = card.querySelector('model-viewer');
                const originalVariant = card.querySelector('.original-variant');
                
                if (modelViewer && originalVariant) {
                    // Check if the model already has a saved dominant color
                    const currentBackground = originalVariant.style.background;
                    const hasDefaultColor = !currentBackground || 
                                          currentBackground.includes('rgb(107, 114, 128)') || 
                                          currentBackground.includes('#6b7280');
                    
                    // Only extract color if it's using the default gray color
                    if (hasDefaultColor) {
                        console.log('Model missing dominant color, extracting...');
                        const updateColor = async () => {
                            // Add a small delay to ensure the model is fully rendered
                            setTimeout(async () => {
                                const dominantColor = await extractDominantColor(modelViewer);
                                console.log('Extracted dominant color for model:', dominantColor);
                                originalVariant.style.background = dominantColor;
                                
                                // Save the extracted color to prevent re-extraction
                                const modelId = card.querySelector('.model-id')?.textContent;
                                if (modelId) {
                                    try {
                                        await fetch('/api/update-color', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                modelId,
                                                dominantColor
                                            })
                                        });
                                    } catch (error) {
                                        console.error('Error saving extracted color:', error);
                                    }
                                }
                            }, 1000);
                        };
                        
                        if (modelViewer.loaded) {
                            updateColor();
                        } else {
                            modelViewer.addEventListener('load', updateColor, { once: true });
                        }
                    }
                }
            });
        }
        
        // Extract and save model color after upload
        async function extractAndSaveModelColor(modelId) {
            try {
                console.log('Extracting color for uploaded model:', modelId);
                
                // Find the model card that was just uploaded
                const modelCards = document.querySelectorAll('.model-card');
                let targetModelViewer = null;
                
                for (const card of modelCards) {
                    const hiddenModelId = card.querySelector('.model-id');
                    if (hiddenModelId && hiddenModelId.textContent === modelId) {
                        targetModelViewer = card.querySelector('model-viewer');
                        break;
                    }
                }
                
                if (!targetModelViewer) {
                    console.warn('Model viewer not found for uploaded model');
                    return;
                }
                
                // Wait for model to load and extract color
                const waitForLoad = () => new Promise(resolve => {
                    if (targetModelViewer.loaded) {
                        resolve();
                    } else {
                        targetModelViewer.addEventListener('load', resolve, { once: true });
                    }
                });
                
                await waitForLoad();
                
                // Small delay to ensure model is rendered
                setTimeout(async () => {
                    const dominantColor = await extractDominantColor(targetModelViewer);
                    console.log('Extracted dominant color for new model:', dominantColor);
                    
                    // Save to database
                    try {
                        const response = await fetch('/api/update-color', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                modelId,
                                dominantColor
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(' Saved dominant color to database:', result);
                            
                            // Update the UI immediately
                            const originalVariant = targetModelViewer.closest('.model-card')?.querySelector('.original-variant');
                            if (originalVariant) {
                                originalVariant.style.background = dominantColor;
                            }
                        } else {
                            console.error('Failed to save dominant color');
                        }
                    } catch (error) {
                        console.error('Error saving dominant color:', error);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error extracting model color:', error);
            }
        }

        // Extract and save variant color after upload - FIXED to load actual variant GLB
        async function extractAndSaveVariantColor(variantId, modelId) {
            try {
                console.log(' Extracting color for uploaded variant:', variantId, 'on model:', modelId);
                
                // Find the model card with this model ID
                const modelCards = document.querySelectorAll('.model-card');
                let targetModelViewer = null;
                let targetVariantElement = null;
                let variantUrl = null;
                
                for (const card of modelCards) {
                    const hiddenModelId = card.querySelector('.model-id');
                    if (hiddenModelId && hiddenModelId.textContent === modelId) {
                        targetModelViewer = card.querySelector('model-viewer');
                        // Find the specific variant element and get its URL
                        const variants = card.querySelectorAll('.variant-circle');
                        for (const variant of variants) {
                            const onclick = variant.getAttribute('onclick');
                            if (onclick && onclick.includes(variantId)) {
                                targetVariantElement = variant;
                                // Extract the variant URL from the onclick attribute (3rd parameter in switchToVariant call)
                                // Format: switchToVariant('modelId', 'variantId', 'variantUrl', 'hexColor', 'variantType')
                                const match = onclick.match(/switchToVariant\('[^']*',\s*'[^']*',\s*'([^']*)'/);
                                if (match) {
                                    variantUrl = match[1];
                                    console.log(' Extracted variant URL:', variantUrl);
                                } else {
                                    console.warn(' Could not extract variant URL from onclick:', onclick);
                                }
                                break;
                            }
                        }
                        break;
                    }
                }
                
                if (!targetModelViewer) {
                    console.warn(' Model viewer not found for variant color extraction');
                    return;
                }
                
                if (!variantUrl) {
                    console.warn(' Variant URL not found for color extraction');
                    return;
                }
                
                console.log(' Found variant URL:', variantUrl);
                
                // Store the original model URL to restore later
                const originalSrc = targetModelViewer.src;
                
                // Load the new variant GLB into the model viewer
                console.log(' Temporarily loading variant GLB for color extraction...');
                targetModelViewer.src = variantUrl;
                
                // Wait for the variant model to load
                const waitForVariantLoad = () => new Promise(resolve => {
                    if (targetModelViewer.loaded) {
                        resolve();
                    } else {
                        targetModelViewer.addEventListener('load', resolve, { once: true });
                    }
                });
                
                await waitForVariantLoad();
                
                // Small delay to ensure variant is rendered
                setTimeout(async () => {
                    try {
                        const dominantColor = await extractDominantColor(targetModelViewer);
                        console.log(' Extracted color from variant GLB:', dominantColor);
                        
                        // Restore original model
                        console.log(' Restoring original model...');
                        targetModelViewer.src = originalSrc;
                        
                        // Save variant color to database
                        const response = await fetch('/api/update-variant-color', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                variantId,
                                dominantColor
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(' Saved variant color to database:', result);
                            
                            // Update the variant circle color in UI
                            if (targetVariantElement) {
                                targetVariantElement.style.background = dominantColor;
                                console.log(' Updated variant circle color in UI');
                            }
                        } else {
                            console.error(' Failed to save variant color to database');
                        }
                    } catch (error) {
                        console.error(' Error during color extraction:', error);
                        // Always restore original model even if error occurs
                        targetModelViewer.src = originalSrc;
                    }
                }, 2000); // Longer delay for variant rendering
                
            } catch (error) {
                console.error(' Error extracting variant color:', error);
            }
        }
        
        // Delete a variant
        async function deleteVariant(variantId, modelId, event) {
            // Stop event propagation to prevent triggering the variant click
            event.stopPropagation();

            try {
                // Check if this is an original variant by checking if it ends with '-original'
                const isOriginalVariant = variantId.endsWith('-original');

                if (isOriginalVariant) {
                    // For original variants, we need to check what other variants exist
                    const currentModels = window.currentModelsData || [];
                    const model = currentModels.find(m => m.id === modelId);
                    const totalVariants = (model?.variants?.length || 0) + 1; // +1 for the original

                    if (totalVariants === 1) {
                        // This is the last variant - delete entire model
                        if (!confirm('This is the last variant. Delete entire furniture item?')) {
                            return;
                        }

                        // Delete the entire model
                        const response = await fetch('/api/models', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id: modelId,
                                type: 'model'
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to delete model');
                        }

                    } else {
                        // There are other variants - delete original and promote first variant
                        if (!confirm('Delete original variant? First variant will become the new original.')) {
                            return;
                        }

                        // Delete the original variant
                        const response = await fetch('/api/models', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id: variantId,
                                type: 'variant'
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to delete original variant');
                        }
                    }

                } else {
                    // Regular variant deletion
                    if (!confirm('Delete this variant?')) {
                        return;
                    }

                    const response = await fetch('/api/models', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: variantId,
                            type: 'variant'
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to delete variant');
                    }
                }

                console.log(' Variant deleted successfully');
                // Refresh the models to reflect the change
                loadModels();

            } catch (error) {
                console.error('Error deleting variant:', error);
                alert('Failed to delete variant: ' + error.message);
            }
        }

        // Note: deleteMainVariant function removed - now using unified deleteVariant function
        
        // Update colors when page loads (for existing models)
        document.addEventListener('DOMContentLoaded', () => {
            // Only update colors if authenticated
            if (isAuthenticated) {
                setTimeout(updateOriginalVariantColors, 3000); // Give models time to load and render
            }
            
            // Check if we need to extract color for a newly uploaded variant
            const extractColorData = sessionStorage.getItem('extractColorForVariant');
            if (extractColorData) {
                try {
                    const { variantId, modelId } = JSON.parse(extractColorData);
                    console.log(' Found variant color extraction request:', variantId, 'for model:', modelId);
                    
                    // Clear the session storage
                    sessionStorage.removeItem('extractColorForVariant');
                    
                    // Extract color after models are loaded and rendered
                    setTimeout(async () => {
                        console.log(' Starting delayed color extraction for new variant...');
                        await extractAndSaveVariantColor(variantId, modelId);
                    }, 5000); // Wait 5 seconds for models to fully load and render
                    
                } catch (error) {
                    console.error('Error parsing variant color extraction data:', error);
                    sessionStorage.removeItem('extractColorForVariant');
                }
            }
        });

        // ========================================
        // MODERN PAGE NAVIGATION SYSTEM
        // ========================================
        
        let currentPage = 'dashboard';
        let allImages = [];
        let filteredImages = [];
        
        // Universal Page Navigation
        function navigateToPage(pageName, updateURL = true) {
            // Navigation request
            
            // Update URL hash to preserve state on refresh
            if (updateURL) {
                window.location.hash = pageName;
            }
            
            // Hide all pages
            const allPages = document.querySelectorAll('.page');
            // Hide all pages
            allPages.forEach(page => {
                page.style.display = 'none';
            });

            // Additional cleanup: hide any potential leaked content
            const modelGrid = document.getElementById('modelGrid');
            if (modelGrid && pageName === 'feedback') {
                modelGrid.style.display = 'none';
            } else if (modelGrid && pageName === 'dashboard') {
                modelGrid.style.display = 'block';
            }

            // Force hide wallpaper elements on any page navigation
            const wallpaperElements = document.querySelectorAll('#wallpaperUploadModal, #wallpaperUploadForm, [id*="wallpaper"], [onclick*="wallpaper"], .wallpaper-preview, [class*="wallpaper"]');
            wallpaperElements.forEach(element => {
                element.style.display = 'none';
                element.style.visibility = 'hidden';
            });
            
            // Show selected page
            const targetPageId = pageName + 'Page';
            const targetPage = document.getElementById(targetPageId);
            // Show target page
            if (targetPage) {
                targetPage.style.display = 'block';
                currentPage = pageName;
            } else {
                console.error(` Target page not found: ${targetPageId}`);
            }
            
            // Update navigation active state
            const allNavLinks = document.querySelectorAll('.sidebar-nav-link');
            console.log(` Found ${allNavLinks.length} nav links`);
            allNavLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`[data-page="${pageName}"]`);
            // Activate nav link
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Initialize page-specific functionality
            console.log(` Initializing page-specific functionality for: ${pageName}`);
            switch(pageName) {
                case 'images':
                    console.log(` Loading images page...`);
                    loadImagesPage();
                    break;
                case 'users':
                    console.log(` Loading users page...`);
                    loadUsersPage();
                    break;
                case 'feedback':
                    console.log(` Loading feedback page...`);
                    loadFeedbackFilters();
                    loadFeedback();
                    break;
                case 'requests':
                    console.log(` Loading requests page...`);
                    loadRequests();
                    loadRequestsFilters();
                    break;
                case 'dashboard':
                    console.log(` Dashboard page (no initialization needed)`);
                    break;
                default:
                    console.warn(` Unknown page: ${pageName}`);
            }
            
            // Navigation completed
        }
        
        // ========================================
        // IMAGES PAGE FUNCTIONALITY
        // ========================================
        
        async function loadImagesPage() {
            try {
                console.log(' Loading images page...');
                const response = await fetch('/api/images');
                console.log(' Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(' API Response:', result);
                    
                    const images = result.images || [];
                    console.log(' Images found:', images.length);
                    
                    allImages = images;
                    filteredImages = [...allImages];
                    
                    populateCustomerFilter();
                    
                    console.log(' Displaying images grid...');
                    displayImagesGrid();
                } else {
                    console.error(' Failed to load images:', response.status, response.statusText);
                    document.getElementById('imagesGrid').innerHTML = `
                        <div class="empty-state">
                            <h3>Failed to Load Images</h3>
                            <p>Status: ${response.status} - ${response.statusText}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(' Error loading images page:', error);
                document.getElementById('imagesGrid').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Images</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function populateCustomerFilter() {
            const customerFilter = document.getElementById('imageCustomerFilter');
            if (!customerFilter) return;
            
            // Clear existing options (keep "All Customers")
            customerFilter.innerHTML = '<option value="all">All Customers</option>';
            
            // Get customers from universal customer manager
            const allCustomers = customerManager.getAllCustomers();
            
            // Add customer options from universal system
            allCustomers.forEach(customer => {
                if (customer.id !== 'unassigned') { // Skip unassigned
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    customerFilter.appendChild(option);
                }
            });
            
            // Also add customers from images that might not be in universal system yet
            const imageCustomers = [...new Set(allImages
                .filter(img => img.customer_id && img.customer_id !== 'unassigned')
                .map(img => ({ id: img.customer_id, name: img.customer_name || img.customer_id }))
            )];
            
            imageCustomers.forEach(imgCustomer => {
                // Only add if not already in the list
                const existingOption = customerFilter.querySelector(`option[value="${imgCustomer.id}"]`);
                if (!existingOption) {
                    const option = document.createElement('option');
                    option.value = imgCustomer.id;
                    option.textContent = imgCustomer.name;
                    customerFilter.appendChild(option);
                }
            });
            
        }
        
        function filterImages() {
            const typeFilter = document.getElementById('imageTypeFilter').value;
            const customerFilter = document.getElementById('imageCustomerFilter').value;
            const searchFilter = document.getElementById('imageSearchFilter').value.toLowerCase();
            
            filteredImages = allImages.filter(image => {
                // Type filter
                if (typeFilter !== 'all' && image.image_type !== typeFilter) return false;
                
                // Customer filter
                if (customerFilter !== 'all' && image.customer_id !== customerFilter) return false;
                
                // Search filter
                if (searchFilter && !image.filename.toLowerCase().includes(searchFilter)) return false;
                
                return true;
            });
            
            displayImagesGrid();
        }
        
        function displayImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            console.log(' Display grid called, grid element:', grid);
            console.log(' Filtered images count:', filteredImages.length);
            
            if (filteredImages.length === 0) {
                console.log(' No images to display');
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No Images Found</h3>
                        <p>Try adjusting your filters or upload some images</p>
                    </div>
                `;
                return;
            }
            
            console.log(' Rendering', filteredImages.length, 'images');
            
            grid.innerHTML = filteredImages.map(image => `
                <div class="image-card">
                    <div class="image-preview">
                        <img src="${image.cloudinary_url}" alt="${image.filename}" loading="lazy">
                    </div>
                    <div class="image-info">
                        <div class="image-title">${image.filename}</div>
                        <div class="image-meta">
                            ${Math.round(image.file_size / 1024)} KB  
                            ${image.width}x${image.height}
                        </div>
                        <div class="image-actions">
                            <span class="image-type-badge">${image.image_type}</span>
                            <button class="image-delete-btn" onclick="deleteImageFromGrid('${image.id}', '${image.cloudinary_public_id}')">
                                
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function deleteImageFromGrid(id, cloudinaryPublicId) {
            if (!confirm('Delete this image?')) return;
            
            try {
                const response = await fetch('/api/images', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, cloudinaryPublicId })
                });
                
                if (response.ok) {
                    // Remove from local arrays
                    allImages = allImages.filter(img => img.id !== id);
                    filteredImages = filteredImages.filter(img => img.id !== id);
                    
                    // Refresh display
                    displayImagesGrid();
                    populateCustomerFilter();
                } else {
                    alert('Failed to delete image');
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            }
        }
        
        // ========================================
        // USERS PAGE FUNCTIONALITY
        // ========================================
        
        async function loadUsersPage() {
            try {
                console.log(' Loading users page...');
                const usersContainer = document.getElementById('usersContainer');
                console.log(' Users container:', usersContainer);
                
                if (!usersContainer) {
                    console.error(' Users container not found!');
                    return;
                }
                
                // Load users from API
                console.log(' Fetching users from API...');
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error(`Failed to load users: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log(' API Response:', responseData);
                
                // Handle both array response and object response
                const users = Array.isArray(responseData) ? responseData : (responseData.users || []);
                console.log(' Users loaded:', users.length);
                
                if (!users || users.length === 0) {
                    usersContainer.innerHTML = `
                        <div class="empty-state" style="padding: 40px; text-align: center; color: #7d8590;">
                            <h3>No Users Found</h3>
                            <p>Create your first user using the "Add User" button above</p>
                        </div>
                    `;
                    return;
                }
                
                // Generate users HTML
                usersContainer.innerHTML = users.map(user => {
                    const isAdmin = user.role === 'admin';
                    const roleDisplay = user.role === 'customer' ? 'Customer' : 'Administrator';
                    const statusClass = user.is_active ? 'active' : 'inactive';
                    const statusText = user.is_active ? 'Active' : 'Inactive';
                    
                    return `
                        <div class="user-card ${statusClass}">
                            <div class="user-avatar">
                                ${user.role === 'admin' ? '' : ''}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${user.username}</div>
                                <div class="user-role-container">
                                    <span class="user-role">${roleDisplay}</span>
                                    ${user.customer_name ? `<span class="user-customer"> ${user.customer_name}</span>` : ''}
                                </div>
                                <div class="user-meta">
                                    <span class="user-status status-${statusClass}">${statusText}</span>
                                    <span class="user-created">Created: ${new Date(user.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="user-action-btn edit" onclick="openUserEditModal('${user.id}', '${user.username}', '${user.role}', '${user.customer_id || ''}', '${user.customer_name || ''}', ${user.is_active}, ${isAdmin})">
                                     Edit
                                </button>
                                ${!isAdmin ? `
                                    <button class="user-action-btn danger" onclick="toggleUserStatus('${user.id}', ${user.is_active})">
                                        ${user.is_active ? ' Deactivate' : ' Activate'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log(' Users page populated successfully');
                
            } catch (error) {
                console.error(' Error loading users page:', error);
                usersContainer.innerHTML = `
                    <div class="empty-state" style="padding: 40px; text-align: center; color: #f85149;">
                        <h3>Error Loading Users</h3>
                        <p>${error.message}</p>
                        <button onclick="loadUsersPage()" class="user-action-btn">Retry</button>
                    </div>
                `;
            }
        }
        
        // ========================================
        // INITIALIZE PAGE SYSTEM
        // ========================================
        
        // Restore page from URL hash on page load
        function restorePageFromURL() {
            const hash = window.location.hash.substring(1); // Remove # from hash
            const validPages = ['dashboard', 'images', 'users', 'feedback', 'requests'];
            
            if (hash && validPages.includes(hash)) {
                navigateToPage(hash, false); // Don't update URL since we're reading from it
            } else {
                navigateToPage('dashboard', false); // Default to dashboard
            }
        }
        
        // Initialize on page load
        // Quick Category Functions (Settings Modal)
        function showQuickCategoryInput() {
            document.getElementById('quickCategoryInputSection').style.display = 'block';
            document.getElementById('quickCategoryInput').focus();
        }

        function hideQuickCategoryInput() {
            document.getElementById('quickCategoryInputSection').style.display = 'none';
            document.getElementById('quickCategoryInput').value = '';
        }

        async function createQuickCategory() {
            const categoryName = document.getElementById('quickCategoryInput').value.trim();
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            const customerId = currentSettingsModel?.customer_id;
            if (!customerId || customerId === 'unassigned') {
                alert('Cannot add category for unassigned products');
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_name: categoryName })
                });

                if (response.ok) {
                    const result = await response.json();
                    const newCategory = result.category;

                    // Reload categories
                    await loadCategoriesForDropdown('quickCategorySelect', customerId);

                    // Select the new category
                    document.getElementById('quickCategorySelect').value = newCategory.category_slug;

                    // Save it to the model
                    await saveQuickCategory(currentSettingsModel.id, newCategory.category_slug);

                    // Hide the input section
                    hideQuickCategoryInput();

                    // Update global category list
                    await loadCustomerCategoriesGlobal(customerId);
                } else {
                    alert('Failed to create category');
                }
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Error creating category');
            }
        }

        async function saveQuickCategory(modelId, categorySlug) {
            try {
                const response = await fetch(`/api/model/${modelId}/category`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category: categorySlug })
                });

                if (response.ok) {
                    // Update the model in memory
                    if (currentSettingsModel) {
                        currentSettingsModel.product_category = categorySlug;
                    }

                    // Update description
                    const categoryDesc = document.getElementById('categoryDesc');
                    if (categorySlug) {
                        categoryDesc.textContent = `Current: ${formatCategoryName(categorySlug)}`;
                    } else {
                        categoryDesc.textContent = 'No category assigned';
                    }

                    // Reload models to reflect the change
                    loadModels();
                } else {
                    alert('Failed to update category');
                    // Reset dropdown to previous value
                    document.getElementById('quickCategorySelect').value = currentSettingsModel?.product_category || '';
                }
            } catch (error) {
                console.error('Error updating category:', error);
                alert('Error updating category');
                // Reset dropdown to previous value
                document.getElementById('quickCategorySelect').value = currentSettingsModel?.product_category || '';
            }
        }

        // Category Edit Modal Functions
        function handleEditCategory() {
            if (!currentSettingsModel) return;

            document.getElementById('editModelId').value = currentSettingsModel.id;

            // Load categories for this customer
            const customerId = currentSettingsModel.customer_id;
            if (customerId) {
                loadCategoriesForDropdown('editCategorySelect', customerId);
            }

            // Set current value
            setTimeout(() => {
                document.getElementById('editCategorySelect').value = currentSettingsModel.product_category || '';
            }, 200);

            document.getElementById('categoryEditModal').style.display = 'flex';
        }

        function closeCategoryEditModal() {
            document.getElementById('categoryEditModal').style.display = 'none';
            document.getElementById('newCategorySection').style.display = 'none';
            document.getElementById('newCategoryInput').value = '';
        }

        function showAddCategoryInput() {
            document.getElementById('newCategorySection').style.display = 'block';
            document.getElementById('newCategoryInput').focus();
        }

        function hideAddCategoryInput() {
            document.getElementById('newCategorySection').style.display = 'none';
            document.getElementById('newCategoryInput').value = '';
        }

        async function createAndSelectCategory() {
            const categoryName = document.getElementById('newCategoryInput').value.trim();
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            const customerId = currentSettingsModel?.customer_id;
            if (!customerId || customerId === 'unassigned') {
                alert('Cannot add category for unassigned products');
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_name: categoryName })
                });

                if (response.ok) {
                    const result = await response.json();
                    const newCategory = result.category;

                    // Reload categories
                    await loadCategoriesForDropdown('editCategorySelect', customerId);

                    // Select the new category
                    document.getElementById('editCategorySelect').value = newCategory.category_slug;

                    // Hide the input section
                    hideAddCategoryInput();

                    // Update global category list
                    await loadCustomerCategoriesGlobal(customerId);
                } else {
                    alert('Failed to create category');
                }
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Error creating category');
            }
        }

        // Upload form category functions
        function showUploadCategoryInput() {
            document.getElementById('uploadNewCategorySection').style.display = 'block';
            document.getElementById('uploadNewCategoryInput').focus();
        }

        function hideUploadCategoryInput() {
            document.getElementById('uploadNewCategorySection').style.display = 'none';
            document.getElementById('uploadNewCategoryInput').value = '';
        }

        async function createUploadCategory() {
            const categoryName = document.getElementById('uploadNewCategoryInput').value.trim();
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            const customerSelect = document.getElementById('customerSelect');
            const [customerId] = customerSelect.value.split(':');

            if (!customerId || customerId === 'unassigned') {
                alert('Please select a customer first');
                return;
            }

            try {
                console.log('Creating category:', { customerId, categoryName });

                const response = await fetch(`/api/customers/${customerId}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_name: categoryName })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert(`Failed to create category: ${errorText}`);
                    return;
                }

                const result = await response.json();
                console.log('Created category:', result);

                const newCategory = result.category;

                // Reload categories for this customer
                await loadCategoriesForDropdown('categorySelect', customerId);

                // Select the new category
                document.getElementById('categorySelect').value = newCategory.category_slug;

                // Hide the input section
                hideUploadCategoryInput();

                // Update global category list
                await loadCustomerCategoriesGlobal(customerId);
            } catch (error) {
                console.error('Error creating category:', error);
                alert(`Error creating category: ${error.message}`);
            }
        }

        async function loadCategoriesForDropdown(selectId, customerId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            try {
                const response = await fetch(`/api/customers/${customerId}/categories`);
                if (response.ok) {
                    const data = await response.json();

                    // Clear existing options except the first
                    if (selectId === 'quickCategorySelect') {
                        selectElement.innerHTML = '<option value="">No Category</option>';
                    } else if (selectId === 'editCategorySelect') {
                        selectElement.innerHTML = '<option value="">No Category</option>';
                    } else {
                        selectElement.innerHTML = '<option value="">Select Category (Optional)</option>';
                    }

                    // Add categories
                    if (data.categories && data.categories.length > 0) {
                        data.categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.category_slug;
                            option.textContent = cat.category_name;
                            selectElement.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }


        async function saveCategoryEdit() {
            const modelId = document.getElementById('editModelId').value;
            const category = document.getElementById('editCategorySelect').value || '';

            console.log('Saving category:', { modelId, category });

            try {
                const response = await fetch(`/api/model/${modelId}/category`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category })
                });

                if (response.ok) {
                    closeCategoryEditModal();
                    loadModels(); // Refresh the display
                    alert('Category updated successfully!');
                } else {
                    alert('Failed to update category');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                alert('Error updating category');
            }
        }

        // Dynamic category management
        let customerCategories = {};
        let currentManagingCustomerId = null;

        // Category Manager Functions
        function openCategoryManager() {
            // Get current customer
            const customerSelect = document.getElementById('customerSelect');
            if (!customerSelect) {
                alert('Please select a customer first');
                return;
            }

            const [customerId, customerName] = customerSelect.value.split(':');
            if (!customerId || customerId === 'unassigned') {
                alert('Please select a specific customer to manage categories');
                return;
            }

            currentManagingCustomerId = customerId;
            document.getElementById('categoryManagerModal').style.display = 'flex';
            loadCategoryList(customerId);
        }

        function closeCategoryManager() {
            document.getElementById('categoryManagerModal').style.display = 'none';
            currentManagingCustomerId = null;
        }

        async function loadCategoryList(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}/categories`);
                if (!response.ok) return;

                const data = await response.json();
                const categoryList = document.getElementById('categoryList');

                if (!data.categories || data.categories.length === 0) {
                    categoryList.innerHTML = '<p style="color: #7d8590;">No categories yet. Add your first category above.</p>';
                    return;
                }

                categoryList.innerHTML = data.categories.map(cat => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; background: rgba(240, 246, 252, 0.05); border-radius: 6px;">
                        <span style="color: #e6edf3;">${cat.category_name}</span>
                        <button onclick="deleteCustomerCategory(${cat.id}, '${cat.category_name}')"
                                style="padding: 4px 8px; background: rgba(248, 81, 73, 0.2); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.3); border-radius: 4px; cursor: pointer;">
                            Delete
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading category list:', error);
            }
        }

        async function addCustomerCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            if (!currentManagingCustomerId) {
                alert('No customer selected');
                return;
            }

            try {
                const response = await fetch(`/api/customers/${currentManagingCustomerId}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category_name: categoryName })
                });

                if (response.ok) {
                    document.getElementById('newCategoryName').value = '';
                    loadCategoryList(currentManagingCustomerId);
                    loadCustomerCategories(currentManagingCustomerId);
                    alert('Category added successfully!');
                } else {
                    alert('Failed to add category');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category');
            }
        }

        async function deleteCustomerCategory(categoryId, categoryName) {
            if (!confirm(`Delete category "${categoryName}"? Products in this category will become uncategorized.`)) {
                return;
            }

            if (!currentManagingCustomerId) {
                alert('No customer selected');
                return;
            }

            try {
                const response = await fetch(`/api/customers/${currentManagingCustomerId}/categories`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category_id: categoryId })
                });

                if (response.ok) {
                    loadCategoryList(currentManagingCustomerId);
                    loadCustomerCategories(currentManagingCustomerId);
                    alert('Category deleted successfully!');
                } else {
                    alert('Failed to delete category');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Error deleting category');
            }
        }

        // Load customer-specific categories
        async function loadCustomerCategories(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}/categories`);
                if (!response.ok) return;

                const data = await response.json();

                // Reset mappings
                customerCategories = {};

                // Build category mapping
                data.categories.forEach(cat => {
                    customerCategories[cat.category_slug] = cat.category_name;
                });

                // Update all category dropdowns
                updateAllCategoryDropdowns();

            } catch (error) {
                console.error('Error loading customer categories:', error);
            }
        }

        async function loadCustomerCategoriesGlobal(customerId) {
            // Same as loadCustomerCategories but can be called from anywhere
            await loadCustomerCategories(customerId);
        }

        // Update all category dropdowns with customer categories
        function updateAllCategoryDropdowns() {
            // Update upload form category dropdown
            const uploadCategorySelect = document.getElementById('categorySelect');
            if (uploadCategorySelect) {
                const currentValue = uploadCategorySelect.value;
                uploadCategorySelect.innerHTML = '<option value="">Select Category (Optional)</option>';
                Object.entries(customerCategories).forEach(([slug, name]) => {
                    const option = document.createElement('option');
                    option.value = slug;
                    option.textContent = name;
                    uploadCategorySelect.appendChild(option);
                });
                uploadCategorySelect.value = currentValue;
            }

            // Update filter dropdown
            const filterCategorySelect = document.getElementById('categoryFilterDashboard');
            if (filterCategorySelect) {
                const currentValue = filterCategorySelect.value;
                filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
                Object.entries(customerCategories).forEach(([slug, name]) => {
                    const option = document.createElement('option');
                    option.value = slug;
                    option.textContent = name;
                    filterCategorySelect.appendChild(option);
                });
                // Add uncategorized option
                const uncategorizedOption = document.createElement('option');
                uncategorizedOption.value = 'uncategorized';
                uncategorizedOption.textContent = 'Uncategorized';
                filterCategorySelect.appendChild(uncategorizedOption);
                filterCategorySelect.value = currentValue;
            }

            // Update edit modal dropdown
            const editCategorySelect = document.getElementById('editCategorySelect');
            if (editCategorySelect) {
                const currentValue = editCategorySelect.value;
                editCategorySelect.innerHTML = '<option value="">No Category</option>';
                Object.entries(customerCategories).forEach(([slug, name]) => {
                    const option = document.createElement('option');
                    option.value = slug;
                    option.textContent = name;
                    editCategorySelect.appendChild(option);
                });
                editCategorySelect.value = currentValue;
            }
        }

        // Update subcategories when category changes

        document.addEventListener('DOMContentLoaded', () => {
            // Only initialize if authenticated
            if (isAuthenticated) {
                console.log(' Modern page system initialized');

                // Restore current page from URL
                restorePageFromURL();

                // Hide variant delete buttons for non-admin users
                hideVariantDeletesForCustomers();

                // Set up category selector
                const categorySelect = document.getElementById('categorySelect');
                if (categorySelect) {
                    categorySelect.addEventListener('change', updateSubcategories);
                }

                // Set up customer selector to load categories
                const customerSelect = document.getElementById('customerSelect');
                if (customerSelect) {
                    customerSelect.addEventListener('change', function() {
                        const [customerId] = this.value.split(':');
                        if (customerId && customerId !== 'unassigned') {
                            loadCustomerCategories(customerId);
                            loadCategoriesForDropdown('categorySelect', customerId);
                        } else {
                            // Clear categories if unassigned
                            document.getElementById('categorySelect').innerHTML = '<option value="">Select Category (Optional)</option>';
                        }
                    });

                    // Load initial categories
                    const [initialCustomerId] = customerSelect.value.split(':');
                    if (initialCustomerId && initialCustomerId !== 'unassigned') {
                        loadCustomerCategories(initialCustomerId);
                        loadCategoriesForDropdown('categorySelect', initialCustomerId);
                    }
                }
            }
        });
        
        // Hide variant delete and edit buttons for customer users
        function hideVariantDeletesForCustomers() {
            const currentUser = document.getElementById('loggedInUsername')?.textContent;
            if (currentUser && currentUser !== 'admin') {
                const deleteButtons = document.querySelectorAll('.variant-delete');
                const editButtons = document.querySelectorAll('.variant-edit-color');

                deleteButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
                editButtons.forEach(btn => {
                    btn.style.display = 'none';
                });

                // Also hide when new models are loaded
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // Check if new variant buttons were added
                            const newDeleteButtons = document.querySelectorAll('.variant-delete');
                            const newEditButtons = document.querySelectorAll('.variant-edit-color');

                            newDeleteButtons.forEach(btn => {
                                if (btn.style.display !== 'none') {
                                    btn.style.display = 'none';
                                }
                            });
                            newEditButtons.forEach(btn => {
                                if (btn.style.display !== 'none') {
                                    btn.style.display = 'none';
                                }
                            });
                        }
                    });
                });
                
                // Observe changes to the models container
                const modelsContainer = document.getElementById('modelsContainer');
                if (modelsContainer) {
                    observer.observe(modelsContainer, { childList: true, subtree: true });
                }
            }
        }
        
        // ========================================
        // CUSTOMER LOGO MANAGEMENT
        // ========================================
        
        let currentCustomerLogoData = null;
        
        async function showCustomerLogoUpload() {
            // Get current customer info
            const customerId = document.getElementById('editCustomerId').value.trim();
            const customerName = document.getElementById('editCustomerName').value.trim();
            
            if (!customerId || !customerName) {
                alert('Please save customer information first');
                return;
            }
            
            // Update the image upload modal to be customer-specific
            document.getElementById('imageType').value = 'customer_logo';
            
            // Store customer info for the upload
            window.currentCustomerForLogo = { id: customerId, name: customerName };
            
            // Show the image upload modal
            showImageUploadModal();
        }
        
        async function loadCustomerLogo(customerId) {
            if (!customerId) return;
            
            try {
                const response = await fetch(`/api/images?imageType=customer_logo&customerId=${customerId}`);
                if (response.ok) {
                    const { images } = await response.json();
                    const customerLogo = images && images.length > 0 ? images[0] : null;
                    
                    const logoContainer = document.getElementById('currentCustomerLogo');
                    const removeBtn = document.getElementById('removeLogoBtn');
                    
                    if (customerLogo) {
                        logoContainer.innerHTML = `<img src="${customerLogo.cloudinary_url}" alt="Customer Logo">`;
                        removeBtn.style.display = 'block';
                        currentCustomerLogoData = customerLogo;
                    } else {
                        logoContainer.innerHTML = '<div class="logo-placeholder">No logo uploaded</div>';
                        removeBtn.style.display = 'none';
                        currentCustomerLogoData = null;
                    }
                }
            } catch (error) {
                console.error('Error loading customer logo:', error);
            }
        }
        
        async function removeCustomerLogo() {
            if (!currentCustomerLogoData || !confirm('Remove this customer logo?')) return;
            
            try {
                const response = await fetch('/api/images', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: currentCustomerLogoData.id,
                        cloudinaryPublicId: currentCustomerLogoData.cloudinary_public_id
                    })
                });
                
                if (response.ok) {
                    // Reset logo display
                    document.getElementById('currentCustomerLogo').innerHTML = 
                        '<div class="logo-placeholder">No logo uploaded</div>';
                    document.getElementById('removeLogoBtn').style.display = 'none';
                    currentCustomerLogoData = null;
                } else {
                    alert('Failed to remove logo');
                }
            } catch (error) {
                console.error('Error removing logo:', error);
                alert('Error removing logo');
            }
        }
        
        // Enhanced openUserEditModal to load customer logo
        const originalOpenUserEditModal = openUserEditModal;
        openUserEditModal = function(userId, username, role, customerId, customerName, isActive, isAdmin) {
            originalOpenUserEditModal(userId, username, role, customerId, customerName, isActive, isAdmin);
            
            // Load customer logo if it's a customer
            if (role === 'customer' && customerId) {
                setTimeout(() => loadCustomerLogo(customerId), 500);
            }
        };
        
        // Enhanced image upload to handle customer logos
        const originalUploadImageFile = uploadImageFile;
        uploadImageFile = async function() {
            const fileInput = document.getElementById('imageFile');
            const imageType = document.getElementById('imageType').value;
            const fileName = document.getElementById('imageFileName');
            
            if (!fileInput.files.length) return;
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('imageType', imageType);
                
                // If uploading customer logo, add customer info
                if (imageType === 'customer_logo' && window.currentCustomerForLogo) {
                    formData.append('customerId', window.currentCustomerForLogo.id);
                    formData.append('customerName', window.currentCustomerForLogo.name);
                }
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    fileName.textContent = ` Uploaded successfully!`;
                    
                    // If it's a customer logo, refresh the logo display
                    if (imageType === 'customer_logo' && window.currentCustomerForLogo) {
                        setTimeout(() => {
                            loadCustomerLogo(window.currentCustomerForLogo.id);
                        }, 1000);
                    }
                    
                    setTimeout(() => {
                        closeImageUploadModal();
                        if (currentPage === 'images') {
                            loadImagesPage();
                        }
                    }, 1500);
                } else {
                    fileName.textContent = ` Upload couldn't complete. Please try again.`;
                    fileName.style.color = '#f85149';
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                fileName.textContent = ` Upload error: ${error.message}`;
                fileName.style.color = '#f85149';
            } finally {
                // Clean up customer logo context
                window.currentCustomerForLogo = null;
            }
        };
        
        // ===== REQUESTS MANAGEMENT =====
        async function loadRequests() {
            try {
                const statusFilter = document.getElementById('statusFilterAdmin')?.value || '';
                const customerFilter = document.getElementById('customerFilterAdmin')?.value || '';
                
                // Get all requests first
                const response = await fetch('/api/requests');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                let requests = data.requests || [];
                
                // Apply client-side filtering
                if (statusFilter) {
                    requests = requests.filter(r => r.status === statusFilter);
                }
                if (customerFilter) {
                    requests = requests.filter(r => r.customer_id === customerFilter);
                }
                
                displayRequests(requests);
                updateRequestsStats(requests);
                
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsContainer').innerHTML = 
                    '<div class="error">Error loading requests: ' + error.message + '</div>';
            }
        }
        
        function displayRequests(requests) {
            const container = document.getElementById('requestsContainer');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="empty-state">No requests found</div>';
                return;
            }
            
            const requestsHTML = requests.map(request => {
                const statusColor = getRequestStatusColor(request.status);
                const statusIcon = getRequestStatusIcon(request.status);
                const createdDate = new Date(request.created_at).toLocaleDateString();
                
                return `
                    <div class="request-admin-card" style="background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%); border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div class="request-admin-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div class="request-admin-title" style="font-size: 1.1rem; font-weight: 600; color: #e6edf3;">${request.title || 'Custom Furniture Request'}</div>
                            <div class="request-admin-status ${request.status}" style="color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; background: rgba(240, 246, 252, 0.1); border: 1px solid rgba(240, 246, 252, 0.2);">
                                ${statusIcon} ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                            </div>
                        </div>
                        
                        <div class="request-admin-content" style="margin-bottom: 20px; color: #7d8590; line-height: 1.5;">
                            <div style="margin-bottom: 8px;"><strong style="color: #e6edf3;">Customer:</strong> ${request.customer_id}</div>
                            <div style="margin-bottom: 8px;"><strong style="color: #e6edf3;">Product URL:</strong> 
                                <a href="${request.product_url}" target="_blank" rel="noopener" style="color: #58a6ff; text-decoration: none;">
                                    ${request.product_url.length > 60 ? request.product_url.substring(0, 60) + '...' : request.product_url}
                                </a>
                            </div>
                            ${request.notes ? `<div style="margin-bottom: 8px;"><strong style="color: #e6edf3;">Notes:</strong> ${request.notes}</div>` : ''}
                            ${request.admin_notes ? `<div style="margin-bottom: 8px; background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.2); border-radius: 8px; padding: 10px;"><strong style="color: #79c0ff;">Admin Notes:</strong> ${request.admin_notes}</div>` : ''}
                            <div><strong style="color: #e6edf3;">Submitted:</strong> ${createdDate}</div>
                        </div>
                        
                        <div class="request-admin-actions" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <select class="futuristic-input" id="status-${request.id}" onchange="updateRequestStatus('${request.id}')" style="width: auto; min-width: 140px;">
                                <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button class="action-button secondary" onclick="openRequestNotesModal('${request.id}', '${(request.admin_notes || '').replace(/'/g, "\\'")}')">
                                Add Notes
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = requestsHTML;
        }
        
        function updateRequestsStats(requests) {
            const total = requests.length;
            const pending = requests.filter(r => r.status === 'pending').length;
            const inProgress = requests.filter(r => r.status === 'in_progress').length;
            const completed = requests.filter(r => r.status === 'completed').length;
            
            document.getElementById('totalRequestsAdmin').textContent = total;
            document.getElementById('pendingRequestsAdmin').textContent = pending;
            document.getElementById('inProgressRequestsAdmin').textContent = inProgress;
            document.getElementById('completedRequestsAdmin').textContent = completed;
        }
        
        async function updateRequestStatus(requestId) {
            try {
                const statusSelect = document.getElementById(`status-${requestId}`);
                const newStatus = statusSelect.value;
                
                const response = await fetch('/api/requests', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: requestId,
                        status: newStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Request status updated successfully', 'success');
                    loadRequests(); // Reload to reflect changes
                } else {
                    throw new Error(result.error || 'Update failed');
                }
                
            } catch (error) {
                console.error('Error updating request status:', error);
                showNotification('Error updating request status: ' + error.message, 'error');
            }
        }
        
        function openRequestNotesModal(requestId, currentNotes) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%); border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #e6edf3; margin: 0;">Admin Notes</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; color: #7d8590; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"></button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <textarea id="adminNotesInput" placeholder="Enter admin notes that will be visible to the customer..." 
                                  style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 8px; background: rgba(22, 27, 34, 0.8); color: #e6edf3; resize: vertical; font-family: inherit;">${currentNotes}</textarea>
                    </div>
                    <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="action-button secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="action-button primary" onclick="saveAdminNotes('${requestId}')">Save Notes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveAdminNotes(requestId) {
            try {
                const notes = document.getElementById('adminNotesInput').value.trim();
                
                const response = await fetch('/api/requests', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: requestId,
                        adminNotes: notes
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Admin notes saved successfully', 'success');
                    document.querySelector('.modal-overlay').remove();
                    loadRequests(); // Reload to reflect changes
                } else {
                    throw new Error(result.error || 'Save failed');
                }
                
            } catch (error) {
                console.error('Error saving admin notes:', error);
                showNotification('Error saving notes: ' + error.message, 'error');
            }
        }
        
        function getRequestStatusColor(status) {
            switch (status) {
                case 'pending': return '#f1c40f';
                case 'in_progress': return '#3498db';
                case 'completed': return '#2ecc71';
                case 'cancelled': return '#e74c3c';
                default: return '#95a5a6';
            }
        }
        
        function getRequestStatusIcon(status) {
            switch (status) {
                case 'pending': return '';
                case 'in_progress': return '';
                case 'completed': return '';
                case 'cancelled': return '';
                default: return '';
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10001;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 400px;
            `;
            
            switch (type) {
                case 'success':
                    notification.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.opacity = '1', 10);
            
            // Auto remove
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Wallpaper Upload Modal Functions - DISABLED as of Nov 2024
        /*
        let wallpaperTextures = {};
        
        function toggleWallpaperUploadModal() {
            document.getElementById('wallpaperUploadModal').style.display = 'flex';
            loadCustomersForWallpaper();
        }
        
        function closeWallpaperUploadModal() {
            document.getElementById('wallpaperUploadModal').style.display = 'none';
            document.getElementById('wallpaperUploadForm').reset();
            document.getElementById('wallpaperUploadProgress').style.display = 'none';
            document.getElementById('wallpaperProgressBar').style.width = '0%';
            document.getElementById('wallpaperProgressPercentage').textContent = '0%';
            wallpaperTextures = {};
            clearAllWallpaperPreviews();
        }

        function loadCustomersForWallpaper() {
            try {
                const select = document.getElementById('wallpaperCustomerSelect');
                select.innerHTML = '<option value="">Select Customer</option>';
                
                // Use existing customer manager directly
                const customers = customerManager.getAllCustomers();
                if (customers && customers.length > 0) {
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = `${customer.id}:${customer.name}`;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                } else {
                    // Fallback NAPO option
                    const napoOption = document.createElement('option');
                    napoOption.value = 'napo:NAPO';
                    napoOption.textContent = 'NAPO';
                    select.appendChild(napoOption);
                }
            } catch (error) {
                console.error('Error loading customers for wallpaper:', error);
                showNotification('Failed to load customers', 'error');
            }
        }

        function handleWallpaperTextureUpload(textureType, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                inputElement.value = '';
                return;
            }

            // Store texture
            wallpaperTextures[textureType] = file;

            // Show preview
            const previewContainer = document.getElementById(`${textureType}Preview`);
            const placeholderElement = document.getElementById(`${textureType}Placeholder`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Hide placeholder and show preview
                if (placeholderElement) placeholderElement.style.display = 'none';
                
                previewContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.3); border-radius: 8px;">
                        <img src="${e.target.result}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 6px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #58a6ff; font-weight: 500; font-size: 0.9rem; margin-bottom: 2px;">${textureType.charAt(0).toUpperCase() + textureType.slice(1)} Map</div>
                            <div style="color: #7d8590; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
                            <div style="color: #7d8590; font-size: 0.7rem;">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button onclick="removeWallpaperTexture('${textureType}')" style="background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.3); border-radius: 6px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem;"></button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);

            updateWallpaperUploadButton();
        }

        function removeWallpaperTexture(textureType) {
            delete wallpaperTextures[textureType];
            
            // Clear preview and show placeholder again
            const previewContainer = document.getElementById(`${textureType}Preview`);
            const placeholderElement = document.getElementById(`${textureType}Placeholder`);
            
            if (previewContainer) previewContainer.innerHTML = '';
            if (placeholderElement) placeholderElement.style.display = 'block';
            
            // Clear file input
            const input = document.getElementById(`wallpaper${textureType.charAt(0).toUpperCase() + textureType.slice(1)}Input`);
            if (input) input.value = '';
            
            updateWallpaperUploadButton();
        }

        function clearAllWallpaperPreviews() {
            ['albedo', 'normal', 'roughness', 'height'].forEach(type => {
                // Clear preview and show placeholder
                const previewContainer = document.getElementById(`${type}Preview`);
                const placeholderElement = document.getElementById(`${type}Placeholder`);
                
                if (previewContainer) previewContainer.innerHTML = '';
                if (placeholderElement) placeholderElement.style.display = 'block';
                
                // Clear file input
                const input = document.getElementById(`wallpaper${type.charAt(0).toUpperCase() + type.slice(1)}Input`);
                if (input) input.value = '';
            });
        }

        function updateWallpaperUploadButton() {
            const uploadBtn = document.getElementById('wallpaperUploadButton');
            
            if (!uploadBtn) {
                console.error('wallpaperUploadButton element not found! Available buttons:', 
                    document.querySelectorAll('#wallpaperUploadModal button'));
                return;
            }
            
            const hasAlbedo = wallpaperTextures.albedo;
            const textureCount = Object.keys(wallpaperTextures).length;
            
            if (hasAlbedo) {
                uploadBtn.disabled = false;
                if (textureCount === 1) {
                    uploadBtn.textContent = ' Generate AR Wallpaper';
                } else {
                    uploadBtn.textContent = ` Generate AR Wallpaper (${textureCount} textures)`;
                }
                uploadBtn.style.opacity = '1';
                uploadBtn.style.cursor = 'pointer';
            } else {
                uploadBtn.disabled = true;
                uploadBtn.textContent = ' Upload Albedo first';
                uploadBtn.style.opacity = '0.6';
                uploadBtn.style.cursor = 'not-allowed';
            }
        }

        async function uploadWallpaper() {
            const customerValue = document.getElementById('wallpaperCustomerSelect').value;
            const [customerId, customerName] = customerValue.split(':');
            const title = document.getElementById('wallpaperTitle').value;
            const width = parseFloat(document.getElementById('wallWidth').value) || 2.44;
            const height = parseFloat(document.getElementById('wallHeight').value) || 2.44;
            const tileRepeat = parseFloat(document.getElementById('tileRepeat').value) || 4;

            if (!customerValue || !customerId) {
                showNotification('Please select a customer', 'error');
                return;
            }

            if (!title.trim()) {
                showNotification('Please enter a wallpaper title', 'error');
                return;
            }

            if (!wallpaperTextures.albedo) {
                showNotification('Albedo texture is required', 'error');
                return;
            }

            // Show progress
            document.getElementById('wallpaperUploadProgress').style.display = 'block';
            const progressBar = document.getElementById('wallpaperProgressBar');
            const progressPercentage = document.getElementById('wallpaperProgressPercentage');

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('customerId', customerId);
                formData.append('title', title);
                formData.append('width', width);
                formData.append('height', height);
                formData.append('tileRepeat', tileRepeat);

                // Add texture files
                Object.entries(wallpaperTextures).forEach(([type, file]) => {
                    formData.append(`${type}Texture`, file);
                });

                // Upload with progress
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        progressPercentage.textContent = Math.round(percentComplete) + '%';
                    }
                });

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            showNotification('Wallpaper uploaded successfully!', 'success');
                            closeWallpaperUploadModal();
                            loadModels(); // Refresh the model list
                        } else {
                            throw new Error(response.error || 'Upload failed');
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                };

                xhr.onerror = function() {
                    throw new Error('Network error during upload');
                };

                xhr.open('POST', '/api/upload-wallpaper');
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Upload failed: ' + error.message, 'error');
                document.getElementById('wallpaperUploadProgress').style.display = 'none';
            }
        }



        */




        function downloadQRCode(modelId, modelTitle, svgContent) {
            if (!svgContent || svgContent === 'undefined') {
                showNotification('No QR code available for download', 'error');
                return;
            }

            try {
                const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${modelTitle.replace(/[^a-zA-Z0-9]/g, '_')}_QR_Code.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification(` QR code downloaded: ${modelTitle}`, 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showNotification('Failed to download QR code', 'error');
            }
        }

        function copyQRCode(svgContent) {
            if (!svgContent || svgContent === 'undefined') {
                showNotification('No QR code available to copy', 'error');
                return;
            }

            copyToClipboard(svgContent);
        }

        // Data Export Functions
        function initializeDataExportPage() {
            const SHEET_ID = localStorage.getItem('googleSheetId') || '';

            // Set master sheet link
            const masterLink = document.getElementById('masterSheetLinkAdmin');
            if (SHEET_ID && masterLink) {
                masterLink.href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`;
            }

            // Load last sync time from localStorage
            const lastSync = localStorage.getItem('lastDataExportSync');
            if (lastSync) {
                document.getElementById('lastSyncTimeAdmin').textContent = `Last sync: ${new Date(lastSync).toLocaleString()}`;
            }
        }

        async function syncAllDataAdmin() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.disabled = true;
                button.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Syncing...';

                showDataExportStatus('Syncing all data to Google Sheets...', 'info');

                // First sync all customers to individual tabs
                const response = await fetch('/api/sheets/syncallcustomers');
                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('lastDataExportSync', new Date().toISOString());
                    document.getElementById('lastSyncTimeAdmin').textContent = `Last sync: ${new Date().toLocaleString()}`;

                    // Extract and store Google Sheet ID from the returned URL
                    if (data.sheetUrl) {
                        const sheetIdMatch = data.sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                        if (sheetIdMatch) {
                            const sheetId = sheetIdMatch[1];
                            localStorage.setItem('googleSheetId', sheetId);

                            // Update the link immediately
                            const masterLink = document.getElementById('masterSheetLinkAdmin');
                            if (masterLink) {
                                masterLink.href = data.sheetUrl;
                            }
                        }
                    }

                    // Show stats
                    const statsDiv = document.getElementById('syncStatsAdmin');
                    document.getElementById('syncedProductsAdmin').textContent = data.summary.totalProducts || 0;
                    document.getElementById('syncedVariantsAdmin').textContent = data.summary.totalVariants || 0;
                    document.getElementById('syncedCustomersAdmin').textContent = data.summary.successful || 0;
                    statsDiv.style.display = 'block';

                    showDataExportStatus(` Successfully synced ${data.summary.successful} customers with ${data.summary.totalProducts} products!`, 'success');
                } else {
                    showDataExportStatus(` Sync failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showDataExportStatus(` Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function showDataExportStatus(message, type) {
            const statusDiv = document.getElementById('dataExportStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type === 'error' ? 'error' : 'success'}`;
            statusDiv.style.display = 'block';

            if (type !== 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Clean up duplicated sheets data
        async function cleanupSheetsData() {
            if (!confirm(' This will remove ALL data from your Google Sheets. Are you sure?')) {
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.disabled = true;
                button.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Cleaning...';

                const response = await fetch('/api/sheets/cleanup');
                const data = await response.json();

                if (data.success) {
                    showNotification(` Cleaned ${data.summary.cleanedSheets} sheets! Ready for fresh export.`, 'success');
                } else {
                    showNotification(` Cleanup failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification(` Cleanup error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Dashboard Export Data function - syncs and opens sheet
        async function exportDataAndOpen() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.disabled = true;
                button.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Syncing...';

                // Sync all data using incremental sync
                const response = await fetch('/api/sheets/syncincremental');
                const data = await response.json();

                if (data.success) {
                    // Store sync data
                    localStorage.setItem('lastDataExportSync', new Date().toISOString());

                    // Extract and store Google Sheet ID
                    if (data.sheetUrl) {
                        const sheetIdMatch = data.sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                        if (sheetIdMatch) {
                            localStorage.setItem('googleSheetId', sheetIdMatch[1]);
                        }

                        // Open Google Sheets in new tab
                        window.open(data.sheetUrl, '_blank');
                    }

                    // Show success notification with incremental details
                    const changes = data.summary.changes;
                    if (changes) {
                        const parts = [];
                        if (changes.new > 0) parts.push(`${changes.new} new`);
                        if (changes.updated > 0) parts.push(`${changes.updated} updated`);
                        if (changes.deleted > 0) parts.push(`${changes.deleted} removed`);
                        const changeText = parts.length > 0 ? parts.join(', ') : 'no changes';

                        // Show debug info if no changes but we expect some
                        if (parts.length === 0 && data.debug) {
                            console.log(' Sync Debug Info:', data.debug);
                            const firstCustomer = data.debug[0];
                            if (firstCustomer) {
                                console.log(' First Customer Debug:', {
                                    name: firstCustomer.customer,
                                    dbProducts: firstCustomer.dbProducts,
                                    sheetProducts: firstCustomer.sheetProducts,
                                    dbSku: firstCustomer.firstDbProduct?.sku,
                                    sheetSku: firstCustomer.firstSheetProduct?.sku,
                                    skuAnalysis: firstCustomer.skuAnalysis
                                });
                                console.log(' Database SKUs:', firstCustomer.skuAnalysis?.dbSkus);
                                console.log(' Sheet SKUs:', firstCustomer.skuAnalysis?.sheetSkus);
                            }
                        }

                        showNotification(` Synced: ${changeText} - ${data.summary.totalProducts} total products!`, 'success');
                    } else {
                        showNotification(` Synced all data - ${data.summary.totalProducts} total products!`, 'success');
                    }
                } else {
                    showNotification(` Export failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification(` Export error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Feedback Management Functions

        async function toggleFeedbackView(view) {
            currentFeedbackView = view;

            // Clear any existing selections
            clearSelection();

            // Update toggle button styles
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="toggleFeedbackView('${view}')"]`).classList.add('active');

            // Reload feedback with filter
            await loadFeedback();
        }

        async function markFeedbackDone(feedbackId) {
            if (!confirm('Mark this feedback as done and move to archive?')) return;

            try {
                const response = await fetch('/api/feedback-status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedbackId, status: 'archived' })
                });

                if (response.ok) {
                    showNotification(' Feedback marked as done', 'success');
                    await loadFeedback(); // Reload current view
                } else {
                    throw new Error('Failed to update feedback status');
                }
            } catch (error) {
                console.error('Error marking feedback done:', error);
                showNotification(' Error updating feedback', 'error');
            }
        }

        async function restoreFeedback(feedbackId) {
            if (!confirm('Restore this feedback back to active status?')) return;

            try {
                const response = await fetch('/api/feedback-status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedbackId, status: 'active' })
                });

                if (response.ok) {
                    showNotification(' Feedback restored to active', 'success');
                    await loadFeedback(); // Reload current view
                } else {
                    throw new Error('Failed to restore feedback');
                }
            } catch (error) {
                console.error('Error restoring feedback:', error);
                showNotification(' Error restoring feedback', 'error');
            }
        }

        async function deleteFeedback(feedbackId) {
            if (!confirm(' Are you sure you want to permanently delete this feedback?\n\nThis action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/feedback?id=${feedbackId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    showNotification(' Feedback deleted permanently', 'success');
                    await loadFeedback(); // Reload current view
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to delete feedback');
                }
            } catch (error) {
                console.error('Error deleting feedback:', error);
                showNotification(' Error deleting feedback: ' + error.message, 'error');
            }
        }

        // Bulk selection functions

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.feedback-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });

            updateSelection();
        }

        function updateSelection() {
            selectedFeedbackIds.clear();
            const checkboxes = document.querySelectorAll('.feedback-checkbox:checked');

            checkboxes.forEach(checkbox => {
                selectedFeedbackIds.add(checkbox.value);
            });

            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');

            // Only update UI elements if they exist (only in archived view)
            if (bulkActionsBar && selectedCount) {
                if (selectedFeedbackIds.size > 0) {
                    bulkActionsBar.style.display = 'block';
                    selectedCount.textContent = `${selectedFeedbackIds.size} selected`;
                } else {
                    bulkActionsBar.style.display = 'none';
                }
            }

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.feedback-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 &&
                    selectedFeedbackIds.size === allCheckboxes.length;
            }
        }

        function clearSelection() {
            // Clear the set regardless of view
            selectedFeedbackIds.clear();

            // Only try to uncheck checkboxes if they exist (archived view)
            const checkboxes = document.querySelectorAll('.feedback-checkbox');
            if (checkboxes.length > 0) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }

            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }

            // Only call updateSelection if there are UI elements to update
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            if (bulkActionsBar) {
                updateSelection();
            }
        }

        async function restoreSelected() {
            const count = selectedFeedbackIds.size;
            if (count === 0) return;

            if (!confirm(`Restore ${count} feedback item${count > 1 ? 's' : ''} back to active status?`)) return;

            let successCount = 0;
            let errorCount = 0;

            for (const feedbackId of selectedFeedbackIds) {
                try {
                    const response = await fetch('/api/feedback-status', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ feedbackId, status: 'active' })
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error(`Error restoring feedback ${feedbackId}:`, error);
                    errorCount++;
                }
            }

            if (successCount > 0) {
                showNotification(` Restored ${successCount} feedback item${successCount > 1 ? 's' : ''}`, 'success');
            }
            if (errorCount > 0) {
                showNotification(` Failed to restore ${errorCount} item${errorCount > 1 ? 's' : ''}`, 'error');
            }

            clearSelection();
            await loadFeedback();
        }

        async function deleteSelected() {
            const count = selectedFeedbackIds.size;
            if (count === 0) return;

            if (!confirm(` Are you sure you want to permanently delete ${count} feedback item${count > 1 ? 's' : ''}?\n\nThis action cannot be undone.`)) return;

            let successCount = 0;
            let errorCount = 0;

            for (const feedbackId of selectedFeedbackIds) {
                try {
                    const response = await fetch(`/api/feedback?id=${feedbackId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error(`Error deleting feedback ${feedbackId}:`, error);
                    errorCount++;
                }
            }

            if (successCount > 0) {
                showNotification(` Deleted ${successCount} feedback item${successCount > 1 ? 's' : ''}`, 'success');
            }
            if (errorCount > 0) {
                showNotification(` Failed to delete ${errorCount} item${errorCount > 1 ? 's' : ''}`, 'error');
            }

            clearSelection();
            await loadFeedback();
        }

        async function markRevisionComplete(feedbackId) {
            if (!confirm('Mark revision as complete? This will archive the current feedback so the client can review the updated model.')) return;

            try {
                const response = await fetch('/api/feedback-status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedbackId, status: 'archived' })
                });

                if (response.ok) {
                    showNotification(' Revision marked complete - client can now review updated model', 'success');
                    await loadFeedback(); // Reload current view
                } else {
                    throw new Error('Failed to mark revision complete');
                }
            } catch (error) {
                console.error('Error marking revision complete:', error);
                showNotification(' Error marking revision complete', 'error');
            }
        }

        // Update loadFeedback function to handle status filter
        // Note: The main loadFeedback() function now handles status filtering directly

        // Feedback Images Functions
        let currentFeedbackImages = [];
        let currentImageIndex = 0;
        let currentFeedbackId = null;

        async function toggleFeedbackImages(event, feedbackId) {
            event.stopPropagation();
            const gallery = document.getElementById(`images-${feedbackId}`);

            if (gallery.style.display === 'none') {
                // Load and show images
                gallery.style.display = 'block';
                gallery.innerHTML = '<div style="text-align: center; padding: 10px;">Loading images...</div>';

                try {
                    const response = await fetch(`/api/feedback-images?feedback_id=${feedbackId}`);
                    const data = await response.json();
                    console.log('Feedback images data:', data);

                    if (data.success && data.images && data.images.length > 0) {
                        console.log('Images full data:', data.images);

                        const imagesHtml = `
                            <div class="feedback-images-title">Attached Images (${data.images.length})</div>
                            <div class="feedback-images-grid">
                                ${data.images.map((img, index) => {
                                    // Use aws_url as primary, fallback to thumbnail_url
                                    const imageUrl = img.aws_url || img.thumbnail_url || '';
                                    console.log(`Image ${index + 1} details:`, {
                                        id: img.id,
                                        aws_url: img.aws_url,
                                        thumbnail_url: img.thumbnail_url,
                                        aws_key: img.aws_key,
                                        using: imageUrl
                                    });

                                    // Create a proper image element with better error handling
                                    if (imageUrl) {
                                        return `
                                            <div class="feedback-image-item"
                                                 onclick="openImageViewer('${feedbackId}', ${index})"
                                                 style="background: rgba(22, 27, 34, 0.8); position: relative; min-height: 120px;">
                                                <img src="${imageUrl}"
                                                     alt="Feedback Image ${index + 1}"
                                                     onerror="console.error('Failed to load image:', '${imageUrl}'); this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display: flex; width: 100%; height: 100%; align-items: center; justify-content: center; color: #888; font-size: 12px; min-height: 120px;\\'> Load failed<br><small>' + '${imageUrl}'.substring(0, 50) + '...</small></div>';"
                                                     onload="console.log('Image loaded successfully:', '${imageUrl}');"
                                                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="feedback-image-item" style="background: rgba(22, 27, 34, 0.8); min-height: 120px;">
                                                <div style="display: flex; width: 100%; height: 100%; align-items: center; justify-content: center; color: #888; font-size: 12px;">
                                                     No URL
                                                </div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        `;
                        gallery.innerHTML = imagesHtml;

                        // Store images for viewer
                        window[`feedbackImages_${feedbackId}`] = data.images;

                        // Update the count badge with actual count
                        const row = event.target.closest('.feedback-row');
                        if (row) {
                            const indicator = row.querySelector('.image-indicator');
                            if (indicator) {
                                indicator.innerHTML = ` ${data.images.length}`;
                            }
                        }
                    } else {
                        console.log('No images found for feedback:', feedbackId);
                        gallery.innerHTML = '<div style="text-align: center; padding: 10px; color: #888;">No images attached</div>';

                        // Update the count badge to 0 if no images found
                        const row = event.target.closest('.feedback-row');
                        if (row) {
                            const indicator = row.querySelector('.image-indicator');
                            if (indicator) {
                                indicator.innerHTML = ' 0';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading images:', error);
                    gallery.innerHTML = '<div style="text-align: center; padding: 10px; color: #f85149;">Error loading images</div>';
                }
            } else {
                // Hide images
                gallery.style.display = 'none';
            }
        }

        function openImageViewer(feedbackId, imageIndex) {
            currentFeedbackId = feedbackId;
            currentFeedbackImages = window[`feedbackImages_${feedbackId}`] || [];
            currentImageIndex = imageIndex;

            if (currentFeedbackImages.length === 0) return;

            const modal = document.getElementById('imageViewerModal');
            modal.style.display = 'flex';

            updateViewerImage();
        }

        function updateViewerImage() {
            if (currentFeedbackImages.length === 0) return;

            const image = currentFeedbackImages[currentImageIndex];
            const viewerImage = document.getElementById('viewerImage');
            // Use aws_url as primary, fallback to thumbnail_url
            const imageUrl = image.aws_url || image.thumbnail_url || '';

            console.log('Viewer image details:', {
                index: currentImageIndex,
                id: image.id,
                aws_url: image.aws_url,
                thumbnail_url: image.thumbnail_url,
                using: imageUrl
            });

            viewerImage.src = imageUrl;
            viewerImage.onerror = function() {
                console.error('Failed to load viewer image:', imageUrl);
                this.alt = 'Failed to load image';
            };
            viewerImage.onload = function() {
                console.log('Viewer image loaded successfully:', imageUrl);
            };

            // Update navigation buttons
            document.getElementById('prevImageBtn').style.display = currentImageIndex > 0 ? 'block' : 'none';
            document.getElementById('nextImageBtn').style.display = currentImageIndex < currentFeedbackImages.length - 1 ? 'block' : 'none';
        }

        function navigateImage(direction) {
            currentImageIndex += direction;
            currentImageIndex = Math.max(0, Math.min(currentImageIndex, currentFeedbackImages.length - 1));
            updateViewerImage();
        }

        function closeImageViewer() {
            document.getElementById('imageViewerModal').style.display = 'none';
            currentFeedbackImages = [];
            currentImageIndex = 0;
        }

        function downloadImage() {
            if (currentFeedbackImages.length === 0) return;

            const image = currentFeedbackImages[currentImageIndex];
            const imageUrl = image.aws_url || image.thumbnail_url;

            if (!imageUrl) {
                alert('No image URL available');
                return;
            }

            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `feedback-image-${image.id}.jpg`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function deleteImage() {
            if (currentFeedbackImages.length === 0) return;

            const image = currentFeedbackImages[currentImageIndex];

            if (!confirm('Are you sure you want to delete this image?')) return;

            try {
                const response = await fetch(`/api/feedback-images?image_id=${image.id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Image deleted successfully');

                    // Remove from array
                    currentFeedbackImages.splice(currentImageIndex, 1);
                    window[`feedbackImages_${currentFeedbackId}`] = currentFeedbackImages;

                    // Update gallery
                    const gallery = document.getElementById(`images-${currentFeedbackId}`);
                    if (gallery) {
                        await toggleFeedbackImages({ stopPropagation: () => {} }, currentFeedbackId);
                        await toggleFeedbackImages({ stopPropagation: () => {} }, currentFeedbackId);
                    }

                    // Update viewer or close if no more images
                    if (currentFeedbackImages.length === 0) {
                        closeImageViewer();
                    } else {
                        currentImageIndex = Math.min(currentImageIndex, currentFeedbackImages.length - 1);
                        updateViewerImage();
                    }
                } else {
                    alert('Failed to delete image: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            }
        }

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('imageViewerModal');
            if (modal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') navigateImage(-1);
                if (e.key === 'ArrowRight') navigateImage(1);
                if (e.key === 'Escape') closeImageViewer();
            }
        });

    </script>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="image-viewer-modal" id="imageViewerModal">
        <span class="image-viewer-close" onclick="closeImageViewer()">&times;</span>
        <div class="image-viewer-content">
            <button class="image-nav-btn prev" onclick="navigateImage(-1)" id="prevImageBtn"></button>
            <img class="viewer-image" id="viewerImage" src="" alt="Feedback Image">
            <button class="image-nav-btn next" onclick="navigateImage(1)" id="nextImageBtn"></button>
            <div class="image-viewer-controls">
                <button onclick="downloadImage()"> Download</button>
                <button onclick="deleteImage()" style="background: rgba(255, 69, 58, 0.9);"> Delete</button>
            </div>
        </div>
    </div>
</body>
</html>
<!-- test comment -->
